<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    

    <title>Learn_Vulkan00_第一个三角形 | Adiosy&#39;s blog</title>
    <meta property="og:title" content="Learn_Vulkan00_第一个三角形 - Adiosy&#39;s blog">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2023-06-13T00:00:00&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2023-06-13T00:00:00&#43;08:00'>
        
    <meta name="Keywords" content="C/C&#43;&#43;,Java,计算机图形学,渲染,动画">
    <meta name="description" content="Learn_Vulkan00_第一个三角形">
        
    <meta name="author" content="xingchen">
    <meta property="og:url" content="http://www.adiosy.com/posts/learn_vulkan/learn_vulkan00_%E7%AC%AC%E4%B8%80%E4%B8%AA%E4%B8%89%E8%A7%92%E5%BD%A2.html">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
        <link href="https://cdn.bootcdn.net/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" rel="stylesheet">
    
    
    
    
        <link rel="stylesheet" href='/css/custom.css'>
    
</head>

<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="http://www.adiosy.com/">
                        Adiosy&#39;s blog
                    </a>
                
                <p class="description">民间图形学爱好者.</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="http://www.adiosy.com/">Home</a>
                    
                    <a  href="http://www.adiosy.com/archives.html" title="归档">归档</a>
                    
                    <a  href="http://www.adiosy.com/categories/opengl.html" title="OpenGL/ES">OpenGL/ES</a>
                    
                    <a  href="http://www.adiosy.com/categories/vulkan.html" title="Vulkan">Vulkan</a>
                    
                    <a  href="http://www.adiosy.com/books.html" title="读书">读书</a>
                    
                    <a  href="http://www.adiosy.com/about.html" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    <style type="text/css">
    .post-toc {
        position: fixed;
        width: 220px;
        margin-left: -260px;
        padding: 5px 0px;
        font-family: Athelas, STHeiti, Microsoft Yahei, serif;
        font-size: 20px;
        word-wrap: break-word;
        white-space: nowrap;
        z-index: 999;
        cursor: pointer;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .post-toc .post-toc-title {
        width: 100%;
        margin: 0 auto;
        font-size: 20px;
        font-weight: bold;
        text-transform: uppercase;
        text-align: center;
    }

    .post-toc .post-toc-content {
        font-size: 13px;
         
         
    }

    .post-toc .post-toc-content>nav>ul {
        margin: 10px 0;
        list-style: none;
        padding-inline-start: 1px !important;
    }

    .post-toc .post-toc-content ul {
        list-style: none;
        margin: 0.5em;
        line-height: 1.8em;
    }

    .post-toc .post-toc-content ul ul {
        padding-left: 15px;
        display: inherit;
    }

    .post-toc .post-toc-content>nav>ul>li{
        background-color: #fff;
         
        padding: 2px 5px 2px 5px;
    }

    .post-toc .post-toc-content ul li:hover{
 
 
    }

    .post-toc .post-toc-content ul li a{
        display: inline-block;
        width: 100%;
    }

    .post-toc .post-toc-content ul li a:hover{
        background-color: #666;
        color: #fff;
    }

    @media print,
    screen and (max-width:1057px) {
        .post-toc {
            display: none;
        }
    }
</style>
<div class="post-toc" style="position: absolute; top: 153px;">
    <h2 class="post-toc-title">目录</h2>
    <div class="post-toc-content">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#1-vulkan">1 Vulkan</a>
      <ul>
        <li><a href="#11-vulkan的概念">1.1 Vulkan的概念</a></li>
        <li><a href="#12-为什么选择vulkan">1.2 为什么选择Vulkan</a></li>
      </ul>
    </li>
    <li><a href="#2-方案">2 方案</a>
      <ul>
        <li><a href="#21-目标">2.1 目标</a></li>
        <li><a href="#22-重要对象">2.2 重要对象</a></li>
        <li><a href="#23-步骤">2.3 步骤</a></li>
      </ul>
    </li>
    <li><a href="#3-实现">3 实现</a>
      <ul>
        <li><a href="#31-vulkan实例">3.1 Vulkan实例</a></li>
        <li><a href="#32-窗口表面">3.2 窗口表面</a></li>
        <li><a href="#33-逻辑设备">3.3 逻辑设备</a></li>
        <li><a href="#34-命令池">3.4 命令池</a></li>
        <li><a href="#35-交换链">3.5 交换链</a></li>
        <li><a href="#36-创建渲染流程">3.6 创建渲染流程</a></li>
        <li><a href="#37-帧缓冲">3.7 帧缓冲</a></li>
        <li><a href="#38-图形渲染管线">3.8 图形渲染管线</a></li>
        <li><a href="#39-命令缓冲">3.9 命令缓冲</a></li>
        <li><a href="#310-信号量">3.10 信号量</a></li>
        <li><a href="#311-渲染">3.11 渲染</a></li>
      </ul>
    </li>
    <li><a href="#4-总结">4 总结</a></li>
  </ul>
</nav>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        var postToc = $(".post-toc");
        if (postToc.length) {
            var leftPos = $("#main").offset().left;
            if (leftPos < 220) {
                postToc.css({ "width": leftPos - 15, "margin-left": (0 - leftPos) })
            }

            var t = postToc.offset().top - 125,
                a = {
                    start: {
                        position: "absolute",
                        top: t
                    },
                    process: {
                        position: "fixed",
                        top: 98.375
                    },
                };

            var e = $(window).animate({scrollTop: 0}, 600);
            e < t ? postToc.css(a.start) : postToc.css(a.process);
        }

        if ($("#TableOfContents").children().length < 1) {
            $(".post-toc").remove();
        }
    })
</script>

    <article class="post">
        <header>
            <h1 class="post-title">Learn_Vulkan00_第一个三角形</h1>
        </header>
        
  <time datetime="2023-06-13T00:00:00Z" class="post-meta meta-date dt-published">
    2023-06-13
  </time>


<div class="post-meta meta-category">
  <span>&nbsp;|</span>
  
    <a href='/categories/vulkan'>Vulkan</a>
  
</div>


        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">&nbsp;|
                <span id="busuanzi_value_page_pv"></span> <span>reads</span>
            </span>
        </div>
        
        
        <div class="clear" style="display: none">
            <div class="toc-article">
                <div class="toc-title">Table of Contents</div>
            </div>
        </div>
        
        <div class="post-content">
            <p>本文将描述一个基于C++/Vulkan渲染彩色三角形的案例。因为Vulkan API较为底层，对象也繁多，所以我尽可能只保留必要内容，目的是梳理出来一个Vulkan程序的基础框架，也是对Vulkan各个对象的初步理解。当然也出于这个关系，本文不会对每个API参数都进行详细解释。</p>
<p><figure class="max-w-2xl mx-auto overflow-hidden">
    
    <a data-fancybox="gallery" href="../assets/image-20230613194024731.png" target="_blank">
        <img alt="" src="../assets/image-20230613194024731.png" />
    </a>
    
    <figcaption class="p-2 text-center"></figcaption>
</figure>
    </p>
<h2 id="1-vulkan">1 Vulkan</h2>
<h3 id="11-vulkan的概念">1.1 Vulkan的概念</h3>
<p>Vulkan是一套渲染图形API，于2015由Khronos组织发布，另外OpenGL也是这个组织发布的图形API。</p>
<p>以下是来自维基百科对Vulkan的定义。</p>
<blockquote>
<p>Vulkan是一个低开销、跨平台的二维、三维图形与计算的应用程序接口（API），最早由Khronos组织在2015年游戏开发者大会（GDC）上发表。
来自《维基百科》</p>
</blockquote>
<p>官网： <a href="https://www.vulkan.org">https://www.vulkan.org</a></p>
<h3 id="12-为什么选择vulkan">1.2 为什么选择Vulkan</h3>
<p>为什么要重新设计一套新的API呢？根据我的理解，主要是以下几个方面原因：</p>
<ul>
<li>首先是跨系统，OpenGL在移动端上并不可以直接使用，而是需要OpenGLES（可以理解为OpenGL的子集），所以将PC端的代码移植到移动端时，仍需要很多工作量。但对于Vulkan，在不同系统平台使用基本一致，在移植时不需要更改很多代码。</li>
<li>然后在渲染架构方面，OpenGL很多操作是隐式的，内部是一个超大的状态机，应用通过控制各种状态来完成渲染操作。相比之下，Vulkan会暴露更多底层操作，比如设备、内存。此外，Vulkan中渲染管线、渲染命令等都需要显式控制。总之就是Vulkan比OpenGL要复杂得多，上手难度也大一些，如果能啃下这个硬骨头，对渲染、Display和GPU处理等知识点能够有更深入的理解，而且也更符合新型渲染API的设计，如果学习D3D等新型渲染API时也能更快入门。</li>
<li>Vulkan天然支持多线程/多视图渲染。在OpenGL中，如果数据放到多线程中处理，在控制不好的情况下，很容易引起冲突，比如在绘制时上传了数据、绑定了贴图等，就会造成错误。但在Vulkan中可以在不同线程使用不同队列、不同的命令缓冲等，来完成并发、并行渲染。</li>
</ul>
<blockquote>
<p>与OpenGL类似，Vulkan针对全平台即时3D图形程序（如电子游戏和交互媒体）而设计，并提供高性能与更均衡的CPU与GPU占用，这也是Direct3D 12和AMD的Mantle的目标。与Direct3D（12版之前）和OpenGL的其他主要区别是，Vulkan是一个底层API，而且能执行并行任务。除此之外，Vulkan还能更好地分配多个CPU核心的使用。</p>
<p>来自《维基百科》</p>
</blockquote>
<p>本人在两年前也写过几篇基于OpenGL写渲染器的文章，可以<a href="/posts/opengl_renderer/01_%E5%BC%80%E7%AF%87.html">点这里</a>找到。当初计划是使用OpenGL来编写一个简单的3D模型渲染器。最近也会重启这个项目。</p>
<p>最近因工作需要，需要多了解了解Vulkan，奈何相关资料比较少，所以准备写本系列文章，以作学习记录。如果你也对Vulkan感兴趣，非常高兴能和你分享交流。</p>
<h2 id="2-方案">2 方案</h2>
<h3 id="21-目标">2.1 目标</h3>
<p>本文目标非常“简单”，那就是使用Vulkan渲染一个最简单的彩色三角形。对于图形渲染来说，三角形跟我们编程入门的“Hello World”一样拥有重大意义。使用OpenGL用差不多100行代码就可以绘制出来一个三角形，但Vulkan却需要1000多行代码，所以本片的篇幅会比较长，不管怎么样，我们开始吧。</p>
<blockquote>
<p>说明：本文不包含C++环境搭建、Vulkan和GLFW的下载安装。</p>
</blockquote>
<h3 id="22-重要对象">2.2 重要对象</h3>
<p>本着是“Hello World”的原则，在这三角形案例中，我将尽可能的减少对象和减少代码量，重点是初步了解Vulkan程序的基本框架和写法。所以，本文不可避免会出现以下几个对象：</p>
<blockquote>
<p>其实刚开始不用对每个对象都详细了解，用的多了自然就知道内部细节了。</p>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align:left">对象</th>
<th>英文</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">物理设备</td>
<td>Physical Device</td>
<td>对于大多数系统来说，物理设备也就是GPU。</td>
</tr>
<tr>
<td style="text-align:left">队列族</td>
<td>Queue Family</td>
<td>队列族是用来寻找合适的物理设备，因为有的队列适合提交图形渲染命令，也有的队列适合提交计算命令，所以需要通过队列族来区分。</td>
</tr>
<tr>
<td style="text-align:left">逻辑设备</td>
<td>Device</td>
<td>可以理解为物理设备的一个引用，也就是一个逻辑操作对象。大部分的Vulkan API操作只使用逻辑设备，而不是物理设备。</td>
</tr>
<tr>
<td style="text-align:left">队列</td>
<td>Queue</td>
<td>根据队列族找到合适的物理设备后，创建逻辑设备前，需要指定要创建的队列数量，就可以获取到相应队列。队列是用来提交一个个命令缓冲的。假如是多线程应用，就可以将命令缓冲提交到不同队列，以完成高效渲染。</td>
</tr>
<tr>
<td style="text-align:left">窗口表面</td>
<td>Surface</td>
<td>作跨系统所用，在窗口级别上加一层中间层，所有Vulkan API使用这个对象即可完成对窗口的各种操作。</td>
</tr>
<tr>
<td style="text-align:left">交换链</td>
<td>Swapchain</td>
<td>可以理解为一个图像队列，是将图像提交到屏幕的基本机制。应用程序从交换链获取图像并执行绘制，完成后提交给交换链并完成图像呈现。</td>
</tr>
<tr>
<td style="text-align:left">命令池</td>
<td>Command Pool</td>
<td>各种内存操作、绑定、绘制等命令都需要记录到命令缓冲并提交到队列，所以这里需要很多命令缓冲，命令池就是为了加速命令的执行。</td>
</tr>
<tr>
<td style="text-align:left">渲染流程</td>
<td>Render Pass</td>
<td>渲染中的颜色附件、深度附件、模板附件等在此指定，告知流水线输入或输出什么数据。</td>
</tr>
<tr>
<td style="text-align:left">图形渲染管线</td>
<td>Pipeline</td>
<td>渲染管线就是将三维场景通过一些列步骤后输出二位图形的处理流程。在Vulkan中，图形渲染管线需要显式配置状态，包括顶点输入、光栅化、多重采样、深度缓冲、模块缓冲等。</td>
</tr>
<tr>
<td style="text-align:left">命令缓冲</td>
<td>Command Buffer</td>
<td>用作记录复制、绘制、申请内存等命令，然后统一提交到队列中。</td>
</tr>
<tr>
<td style="text-align:left">帧缓冲</td>
<td>Frame Buffer</td>
<td>各种附件的集合，包括颜色附件、深度附件、模板附件等等。</td>
</tr>
<tr>
<td style="text-align:left">同步机制</td>
<td>Fence/Semaphore</td>
<td>用作CPU和GPU之间同步，CPU需要等待GPU执行完毕才可以继续执行提交或呈现，Fence（栅栏）和Semaphore（信号量）。</td>
</tr>
</tbody>
</table>
<p>其他关键词。</p>
<table>
<thead>
<tr>
<th>关键词</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>呈现（present）</td>
<td>将渲染结果提交给显示器这一过程，并不是指渲染。</td>
</tr>
<tr>
<td>图像（Image）</td>
<td>创建时指定如何使用，可以是颜色附件，也就是将渲染结果”绘制“到这个Image中；也可以是传统贴图，传递给着色器；也可以是读写并用，用以传输。</td>
</tr>
<tr>
<td>图像视图（Image View）</td>
<td>图像（Image）不能直接使用，我们将借用图像视图（Image View）来访问图像（Image）。</td>
</tr>
</tbody>
</table>
<p><strong>小技巧</strong></p>
<p>在Vulkan API中，大部分遵循以下几种风格（VkXxx代表对象名，比如VKInstance，VkDevice，VkFramebuffer等）。</p>
<ol>
<li>创建和销毁对象。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#177500">//创建
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span><span style="color:#000">VkXxxCreateInfo</span> <span style="color:#000">createInfo</span>{};
</span></span><span style="display:flex;"><span><span style="color:#a90d91">if</span>(<span style="color:#000">VK_SUCCESS</span> <span style="color:#000">!=</span> <span style="color:#000">vkCreateXxx</span>(<span style="color:#000">&amp;</span><span style="color:#000">createInfo</span>, <span style="color:#a90d91">nullptr</span>, <span style="color:#000">&amp;</span><span style="color:#000">xxx</span>)){
</span></span><span style="display:flex;"><span>    <span style="color:#000">Error</span>(<span style="color:#c41a16">&#34;Failed to create xxx.&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#177500">//销毁
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span><span style="color:#000">vkDestroyXxx</span>(<span style="color:#000">xxx</span>, <span style="color:#a90d91">nullptr</span>);
</span></span></code></pre></div><ol start="2">
<li>枚举属性列表。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">uint32_t</span> <span style="color:#000">xxxCount</span>;
</span></span><span style="display:flex;"><span><span style="color:#000">vkEnumerateXxx</span>(<span style="color:#000">&amp;</span><span style="color:#000">xxxCount</span>, <span style="color:#a90d91">nullptr</span>);
</span></span><span style="display:flex;"><span><span style="color:#000">VkXxx</span> <span style="color:#000">xxxArr</span>[<span style="color:#000">xxxCount</span>];
</span></span><span style="display:flex;"><span><span style="color:#000">vkEnumerateXxx</span>(<span style="color:#000">&amp;</span><span style="color:#000">xxxCount</span>, <span style="color:#000">xxxArr</span>);
</span></span></code></pre></div><ol start="3">
<li>内存申请和释放。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#177500">//申请内存
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span><span style="color:#000">VkMemoryAllocateInfo</span> <span style="color:#000">memAllocateInfo</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>        .<span style="color:#000">sType</span> <span style="color:#000">=</span> <span style="color:#000">VK_STRUCTURE_TYPE_MEMORY_ALLOCATE_INFO</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">allocationSize</span> <span style="color:#000">=</span> <span style="color:#000">n</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">memoryTypeIndex</span> <span style="color:#000">=</span> <span style="color:#000">index</span>
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#000">vkAllocateMemory</span>(<span style="color:#000">device</span>, <span style="color:#000">&amp;</span><span style="color:#000">memAllocateInfo</span>, <span style="color:#a90d91">nullptr</span>, <span style="color:#000">&amp;</span><span style="color:#000">xxxMemo</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#177500">//释放内存
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span><span style="color:#000">vkFreeMemory</span>(<span style="color:#000">vk</span>.<span style="color:#000">device</span>, <span style="color:#000">&amp;</span><span style="color:#000">xxxMemo</span>, <span style="color:#a90d91">nullptr</span>);
</span></span></code></pre></div><ol start="4">
<li>有Begin就会有End。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#000">vkBeginXxx</span>();
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#000">vkEndXxx</span>();
</span></span></code></pre></div><h3 id="23-步骤">2.3 步骤</h3>
<p>一、初始化</p>
<ol>
<li>选取合适的物理设备</li>
<li>创建窗口表面</li>
<li>创建逻辑设备</li>
<li>创建命令池</li>
<li>创建交换链</li>
<li>创建渲染流程</li>
<li>创建N个帧缓冲（本文N和交换链内图片数量一致）</li>
<li>创建图形渲染管线</li>
<li>创建N个命令缓冲（本文N和交换链内图片数量一致）</li>
<li>创建两个个信号量，一个用于获取交换链图像，一个用于显示</li>
</ol>
<p>二、渲染主循环</p>
<ol>
<li>获取交换链图像</li>
<li>开启命令缓冲</li>
<li>开启渲染流程</li>
<li>执行渲染</li>
<li>结束渲染流程</li>
<li>结束命令缓冲</li>
<li>将命令缓冲提交到队列</li>
<li>呈现/显示</li>
</ol>
<p>三、回收</p>
<h2 id="3-实现">3 实现</h2>
<p><strong>版本约定</strong></p>
<table>
<thead>
<tr>
<th>事项</th>
<th>作用</th>
<th>版本号</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>操作系统</td>
<td>编程和程序运行环境</td>
<td>Windows7/10/11</td>
<td>代码编写环境为Windows11，在Linux/Android等系统只需要修改构建文件即可</td>
</tr>
<tr>
<td>C/C++</td>
<td>编程语言</td>
<td>17</td>
<td>set(CMAKE_CXX_STANDARD 17)</td>
</tr>
<tr>
<td>CMake</td>
<td>构建项目</td>
<td>3.26.0-rc5</td>
<td><code>cmake --version</code>命令查询</td>
</tr>
<tr>
<td>GLFW</td>
<td>窗口系统</td>
<td>3.3.8</td>
<td></td>
</tr>
<tr>
<td>代码风格</td>
<td>统一风格</td>
<td>小驼峰</td>
<td></td>
</tr>
</tbody>
</table>
<p><strong>项目结构</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>00_hello_triangle/
</span></span><span style="display:flex;"><span>|-- CMakeLists.txt
</span></span><span style="display:flex;"><span><span style="color:#c41a16">`</span>-- src
</span></span><span style="display:flex;"><span>    |-- Main.cpp				// 程序入口
</span></span><span style="display:flex;"><span>    |-- VkBundle.h				// Vulkan对象维护
</span></span><span style="display:flex;"><span>    |-- VkHelper.cpp			// Vulkan API调用工具类实现
</span></span><span style="display:flex;"><span>    |-- VkHelper.h				// Vulkan API调用工具类定义
</span></span><span style="display:flex;"><span>    <span style="color:#c41a16">`</span>-- VulkanCommon.h			// 公用的宏和工具函数
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#1c01ce">1</span> directory, <span style="color:#1c01ce">6</span> files
</span></span></code></pre></div><p>在实现之前，我们创建一个结构体用来存储各个Vulkan对象，再使用一个静态工具实现各个Vulkan对象的创建和销毁。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#633820">#include</span> <span style="color:#633820">&#34;VulkanCommon.h&#34;</span><span style="color:#633820">
</span></span></span><span style="display:flex;"><span><span style="color:#633820"></span>
</span></span><span style="display:flex;"><span><span style="color:#a90d91">struct</span> <span style="color:#3f6e75">VkBundle</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#000">VkInstance</span> <span style="color:#000">instance</span>;
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#633820">#include</span> <span style="color:#633820">&#34;VulkanCommon.h&#34;</span><span style="color:#633820">
</span></span></span><span style="display:flex;"><span><span style="color:#633820"></span>
</span></span><span style="display:flex;"><span><span style="color:#a90d91">class</span> <span style="color:#3f6e75">VkHelper</span> {
</span></span><span style="display:flex;"><span><span style="color:#a90d91">public</span><span style="color:#000">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#177500">/** create Vulkan Instance */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">static</span> <span style="color:#a90d91">void</span> <span style="color:#000">createInstance</span>(<span style="color:#a90d91">bool</span> <span style="color:#000">bValidate</span>, <span style="color:#000">VkInstance</span> <span style="color:#000">*</span><span style="color:#000">out_instance</span>, <span style="color:#000">VkDebugReportCallbackEXT</span> <span style="color:#000">*</span><span style="color:#000">out_debugReport</span>);
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>CMake构建配置文件<code>CMakeLists.txt</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span><span style="color:#a90d91">cmake_minimum_required</span>(<span style="color:#c41a16">VERSION</span> <span style="color:#c41a16">3.24</span>)<span style="color:#000">
</span></span></span><span style="display:flex;"><span><span style="color:#000"></span><span style="color:#a90d91">project</span>(<span style="color:#c41a16">00_hello_triangle</span>)<span style="color:#000">
</span></span></span><span style="display:flex;"><span><span style="color:#000">
</span></span></span><span style="display:flex;"><span><span style="color:#000"></span><span style="color:#a90d91">set</span>(<span style="color:#c41a16">CMAKE_CXX_STANDARD</span> <span style="color:#c41a16">17</span>)<span style="color:#000">
</span></span></span><span style="display:flex;"><span><span style="color:#000">
</span></span></span><span style="display:flex;"><span><span style="color:#000"></span><span style="color:#177500"># 定义平台为Windows
</span></span></span><span style="display:flex;"><span><span style="color:#177500"># VK_USE_PLATFORM_WIN32_KHR -&gt; Windows
</span></span></span><span style="display:flex;"><span><span style="color:#177500"># VK_USE_PLATFORM_ANDROID_KHR -&gt; 安卓
</span></span></span><span style="display:flex;"><span><span style="color:#177500"># ...
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span><span style="color:#a90d91">add_definitions</span>(<span style="color:#c41a16">-DVK_USE_PLATFORM_WIN32_KHR</span>)<span style="color:#000">
</span></span></span><span style="display:flex;"><span><span style="color:#000">
</span></span></span><span style="display:flex;"><span><span style="color:#000"></span><span style="color:#177500"># Vulkan
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span><span style="color:#a90d91">find_package</span>(<span style="color:#c41a16">Vulkan</span> <span style="color:#c41a16">REQUIRED</span>)<span style="color:#000">
</span></span></span><span style="display:flex;"><span><span style="color:#000"></span><span style="color:#a90d91">if</span>(<span style="color:#c41a16">Vulkan_FOUND</span>)<span style="color:#000">
</span></span></span><span style="display:flex;"><span><span style="color:#000"></span>    <span style="color:#a90d91">message</span>(<span style="color:#c41a16">&#34;Find vulkan success!&#34;</span>)<span style="color:#000">
</span></span></span><span style="display:flex;"><span><span style="color:#000"></span>    <span style="color:#a90d91">include_directories</span>(<span style="color:#000">${</span><span style="color:#000">Vulkan_INCLUDE_DIRS</span><span style="color:#000">}</span>)<span style="color:#000">
</span></span></span><span style="display:flex;"><span><span style="color:#000"></span><span style="color:#a90d91">endif</span>()<span style="color:#000">
</span></span></span><span style="display:flex;"><span><span style="color:#000">
</span></span></span><span style="display:flex;"><span><span style="color:#000"></span><span style="color:#177500"># 如果没有配置寻找cmake path环境变量，可以使用这种临时方案找到对应包
</span></span></span><span style="display:flex;"><span><span style="color:#177500">#set(glfw3_DIR &#34;C:/Program Files (x86)/GLFW/lib/cmake/glfw3&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#177500">#set(glfw3_INCLUDE_DIRS &#34;C:/Program Files (x86)/GLFW/include&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#177500">#set(glfw3_LIBRARY &#34;C:/Program Files (x86)/GLFW/lib/libglfw3.a&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span><span style="color:#000">
</span></span></span><span style="display:flex;"><span><span style="color:#000"></span><span style="color:#177500"># GLFW3
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span><span style="color:#a90d91">find_package</span>(<span style="color:#c41a16">glfw3</span> <span style="color:#c41a16">REQUIRED</span>)<span style="color:#000">
</span></span></span><span style="display:flex;"><span><span style="color:#000"></span><span style="color:#a90d91">if</span>(<span style="color:#c41a16">glfw3_FOUND</span>)<span style="color:#000">
</span></span></span><span style="display:flex;"><span><span style="color:#000"></span>    <span style="color:#a90d91">message</span>(<span style="color:#c41a16">&#34;Find glfw3 success!&#34;</span>)<span style="color:#000">
</span></span></span><span style="display:flex;"><span><span style="color:#000"></span>    <span style="color:#a90d91">include_directories</span>(<span style="color:#000">${</span><span style="color:#000">glfw3_INCLUDE_DIRS</span><span style="color:#000">}</span>)<span style="color:#000">
</span></span></span><span style="display:flex;"><span><span style="color:#000"></span><span style="color:#a90d91">endif</span>()<span style="color:#000">
</span></span></span><span style="display:flex;"><span><span style="color:#000">
</span></span></span><span style="display:flex;"><span><span style="color:#000"></span><span style="color:#a90d91">add_executable</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#000">${</span><span style="color:#000">PROJECT_NAME</span><span style="color:#000">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c41a16">src/VulkanCommon.h</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c41a16">src/Main.cpp</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c41a16">src/VkBundle.h</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c41a16">src/VkHelper.cpp</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c41a16">src/VkHelper.h</span>
</span></span><span style="display:flex;"><span>)<span style="color:#000">
</span></span></span><span style="display:flex;"><span><span style="color:#000">
</span></span></span><span style="display:flex;"><span><span style="color:#000"></span><span style="color:#a90d91">target_link_libraries</span>(<span style="color:#000">${</span><span style="color:#000">PROJECT_NAME</span><span style="color:#000">}</span> <span style="color:#c41a16">PUBLIC</span> <span style="color:#000">${</span><span style="color:#000">Vulkan_LIBRARY</span><span style="color:#000">}</span> <span style="color:#000">${</span><span style="color:#000">glfw3_LIBRARY</span><span style="color:#000">}</span>)<span style="color:#000">
</span></span></span></code></pre></div><p>另外，一些公共的处理和判断，我们抽取到一个<a href="https://gitee.com/xingchen0085/learn_vulkan_blog/blob/master/00_hello_triangle/src/VulkanCommon.h">头文件VulkanCommon.h</a>中，后续我们会很多地方用到这里定义的宏，比如日志输出、Vulkan API调用结果判断等。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#633820">#define VK_ALLOC nullptr
</span></span></span><span style="display:flex;"><span><span style="color:#633820">#define APP_NAME &#34;Learn Vulkan&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#633820"></span>...
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#633820">#ifndef Print
</span></span></span><span style="display:flex;"><span><span style="color:#633820">#define Print(...) ((void)my_debug(DBG, __VA_ARGS__))
</span></span></span><span style="display:flex;"><span><span style="color:#633820">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#633820"></span>
</span></span><span style="display:flex;"><span><span style="color:#633820">#ifndef Warn
</span></span></span><span style="display:flex;"><span><span style="color:#633820">#define Warn(...) ((void)my_debug(WRN, __VA_ARGS__))
</span></span></span><span style="display:flex;"><span><span style="color:#633820">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#633820"></span>
</span></span><span style="display:flex;"><span><span style="color:#633820">#ifndef Error
</span></span></span><span style="display:flex;"><span><span style="color:#633820">#define Error(...) ((void)my_debug(ERR, __VA_ARGS__))
</span></span></span><span style="display:flex;"><span><span style="color:#633820">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#633820"></span>
</span></span><span style="display:flex;"><span><span style="color:#a90d91">static</span> <span style="color:#a90d91">void</span>
</span></span><span style="display:flex;"><span><span style="color:#000">vk_check_errors</span>(<span style="color:#000">VkResult</span> <span style="color:#000">result</span>, <span style="color:#a90d91">const</span> <span style="color:#a90d91">char</span> <span style="color:#000">*</span><span style="color:#000">file_name</span>, <span style="color:#a90d91">const</span> <span style="color:#a90d91">int</span> <span style="color:#000">line_number</span>, <span style="color:#a90d91">const</span> <span style="color:#a90d91">char</span> <span style="color:#000">*</span><span style="color:#000">function</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">if</span>(<span style="color:#000">VK_SUCCESS</span> <span style="color:#000">!=</span> <span style="color:#000">result</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#000">Error</span>( <span style="color:#c41a16">&#34;[%s, %d]: %s: %s</span><span style="color:#c41a16">\n</span><span style="color:#c41a16">&#34;</span>, <span style="color:#000">file_name</span>, <span style="color:#000">line_number</span>, <span style="color:#000">function</span>, <span style="color:#000">vk_error_string</span>( <span style="color:#000">result</span> ) );
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#633820">#define CALL_VK(func) vk_check_errors(func, __FILE__, __LINE__, #func);
</span></span></span><span style="display:flex;"><span><span style="color:#633820">#define ARRAY_SIZE(a) (sizeof(a) / sizeof((a)[0]))
</span></span></span></code></pre></div><p><code>Main.cpp</code>定义主流程代码。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#633820">#include</span> <span style="color:#633820">&lt;iostream&gt;</span><span style="color:#633820">
</span></span></span><span style="display:flex;"><span><span style="color:#633820">#include</span> <span style="color:#633820">&#34;VkBundle.h&#34;</span><span style="color:#633820">
</span></span></span><span style="display:flex;"><span><span style="color:#633820">#include</span> <span style="color:#633820">&#34;VkHelper.h&#34;</span><span style="color:#633820">
</span></span></span><span style="display:flex;"><span><span style="color:#633820">#include</span> <span style="color:#633820">&lt;GLFW/glfw3.h&gt;</span><span style="color:#633820">
</span></span></span><span style="display:flex;"><span><span style="color:#633820">#include</span> <span style="color:#633820">&lt;limits&gt;</span><span style="color:#633820">
</span></span></span><span style="display:flex;"><span><span style="color:#633820"></span>
</span></span><span style="display:flex;"><span><span style="color:#177500">/***** 全局变量 *****/</span>
</span></span><span style="display:flex;"><span><span style="color:#000">GLFWwindow</span> <span style="color:#000">*</span><span style="color:#000">window</span>;
</span></span><span style="display:flex;"><span><span style="color:#000">VkBundle</span> <span style="color:#000">vk</span>;
</span></span><span style="display:flex;"><span><span style="color:#a90d91">bool</span> <span style="color:#000">canRender</span>;
</span></span><span style="display:flex;"><span><span style="color:#177500">/***** 全局变量 *****/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">init</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#177500">//TODO
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#177500">//...
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#177500">//...
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#000">canRender</span> <span style="color:#000">=</span> <span style="color:#a90d91">true</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">render</span>(<span style="color:#a90d91">uint32_t</span> <span style="color:#000">currentFrame</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">if</span>(<span style="color:#000">!</span><span style="color:#000">canRender</span>) <span style="color:#a90d91">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#177500">//TODO
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>	<span style="color:#177500">//...
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#177500">//...
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">renderLoop</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">uint32_t</span> <span style="color:#000">currentFrame</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">while</span>(<span style="color:#a90d91">true</span>){
</span></span><span style="display:flex;"><span>		<span style="color:#000">render</span>(<span style="color:#000">currentFrame</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#000">currentFrame</span> <span style="color:#000">++</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">destroy</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#000">Print</span>(<span style="color:#c41a16">&#34;%s&#34;</span>, <span style="color:#000">__FUNCTION__</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#177500">//vkDestroyXxx(...);
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#177500">//TODO
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a90d91">int</span> <span style="color:#000">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#000">std</span><span style="color:#000">::</span><span style="color:#000">cout</span> <span style="color:#000">&lt;&lt;</span> <span style="color:#c41a16">&#34;Hello, Learn Vulkan!&#34;</span> <span style="color:#000">&lt;&lt;</span> <span style="color:#000">std</span><span style="color:#000">::</span><span style="color:#000">endl</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">init</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#000">renderLoop</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#000">destroy</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">return</span> <span style="color:#1c01ce">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>通用约定</strong></p>
<p>因为初始化部分对象较多，所以通常情况下，我会遵循以下顺序描述。</p>
<ol>
<li>首先，我会先在Vulkan对象维护（<code>VkBundle.h</code>）中添加成员变量。</li>
<li>然后，如果较为复杂的API调用，我将在工具类<code>VkHelper.h</code>中编写调用实现。</li>
<li>接着我会在初始化函数中调用步骤2中定义的函数，传递步骤1的成员变量指针给<code>VkHelper.h</code>，并完成初始化后逻辑。</li>
<li>最后，我会在回收函数中添加该对象的回收逻辑。</li>
</ol>
<p>举例：</p>
<p>我要创建和使用一个对象叫 <code>VkAbc</code>，我先在<code>VkBundle.h</code>中维护变量。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">struct</span> <span style="color:#3f6e75">VkBundle</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkAbc</span> <span style="color:#000">abc</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>然后在<code>VkHelper</code>中实现创建<code>VkAbc</code>的动作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">class</span> <span style="color:#3f6e75">VkHelper</span> {
</span></span><span style="display:flex;"><span><span style="color:#a90d91">public</span><span style="color:#000">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#177500">/** create abc */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">static</span> <span style="color:#a90d91">void</span> <span style="color:#000">createAbc</span>(<span style="color:#000">VkAbc</span> <span style="color:#000">*</span><span style="color:#000">abc</span>){
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>        ...
</span></span><span style="display:flex;"><span>       	<span style="color:#177500">//具体的创建逻辑
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    }
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>接下来在<code>Main.cpp</code>中调用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#177500">//全局变量
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span><span style="color:#000">VkBundle</span> <span style="color:#000">vk</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">init</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">createAbc</span>(<span style="color:#000">&amp;</span><span style="color:#000">vk</span>.<span style="color:#000">abc</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>因为销毁一般较为简单，所以直接调用Vulkan API完成销毁。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">destroy</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#000">vkDestroyAbc</span>(<span style="color:#000">vk</span>.<span style="color:#000">abc</span>, <span style="color:#a90d91">nullptr</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="31-vulkan实例">3.1 Vulkan实例</h3>
<p>使用Vulkan作为图形API之前，需要创建一个唯一的VkInstance，一般一个应用程序只会有一个VkInstance。</p>
<p>创建VkInstance的三个步骤：</p>
<ol>
<li>检查层Layer支持列表；</li>
<li>检查扩展Extension支持列表；</li>
<li>调用vkCreateXxx()函数。</li>
</ol>
<p>现在<code>VkBundle</code>中维护两个对象。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">struct</span> <span style="color:#3f6e75">VkBundle</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkInstance</span> <span style="color:#000">instance</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkDebugReportCallbackEXT</span> <span style="color:#000">debugReport</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>我们在<code>VkHelper</code>中创建<code>createInstance()</code>函数，并使用<code>vkEnumerateInstanceLayerProperties()</code>枚举出来目前环境支持的所有层列表，在这些层列表中检查我们需要用到的层。层/扩展检查也就是判断该层/扩展名称是否包含在内，我已经将其抽取到<a href="https://gitee.com/xingchen0085/learn_vulkan_blog/blob/master/00_hello_triangle/src/VulkanCommon.h">头文件VulkanCommon.h</a>了。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">typedef</span> <span style="color:#a90d91">struct</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">const</span> <span style="color:#a90d91">char</span>      <span style="color:#000">*</span><span style="color:#000">name</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">bool</span>			<span style="color:#000">validationOnly</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">bool</span>			<span style="color:#000">required</span>;
</span></span><span style="display:flex;"><span>} <span style="color:#000">DriverFeature</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#177500">/**
</span></span></span><span style="display:flex;"><span><span style="color:#177500"> * 层/扩展验证
</span></span></span><span style="display:flex;"><span><span style="color:#177500"> * @param label 提示名，用作日志输出使用
</span></span></span><span style="display:flex;"><span><span style="color:#177500"> * @param validationEnabled 是否启用验证，如果为否，直接跳过
</span></span></span><span style="display:flex;"><span><span style="color:#177500"> * @param extensions 是否属于扩展验证，层验证时为false，扩展验证时为true
</span></span></span><span style="display:flex;"><span><span style="color:#177500"> * @param requested 待验证列表
</span></span></span><span style="display:flex;"><span><span style="color:#177500"> * @param requestedCount 待验证数量
</span></span></span><span style="display:flex;"><span><span style="color:#177500"> * @param available 全部的功能列表，从vkEnumerateXxxLayerProperties或vkEnumerateXxxExtensionProperties获取
</span></span></span><span style="display:flex;"><span><span style="color:#177500"> * @param availableCount 全部功能数量
</span></span></span><span style="display:flex;"><span><span style="color:#177500"> * @param enabledNames 输出的可用功能名称数组
</span></span></span><span style="display:flex;"><span><span style="color:#177500"> * @param enabledCount 输出的可用功能数量
</span></span></span><span style="display:flex;"><span><span style="color:#177500"> * @return 操作是否成功
</span></span></span><span style="display:flex;"><span><span style="color:#177500"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#a90d91">static</span> <span style="color:#a90d91">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#000">checkFeatures</span>(<span style="color:#a90d91">const</span> <span style="color:#a90d91">char</span> <span style="color:#000">*</span><span style="color:#000">label</span>, <span style="color:#a90d91">const</span> <span style="color:#a90d91">bool</span> <span style="color:#000">validationEnabled</span>, <span style="color:#a90d91">const</span> <span style="color:#a90d91">bool</span> <span style="color:#000">extensions</span>,
</span></span><span style="display:flex;"><span>                   <span style="color:#a90d91">const</span> <span style="color:#000">DriverFeature</span> <span style="color:#000">*</span><span style="color:#000">requested</span>, <span style="color:#a90d91">const</span> <span style="color:#a90d91">uint32_t</span> <span style="color:#000">requestedCount</span>,
</span></span><span style="display:flex;"><span>                   <span style="color:#a90d91">const</span> <span style="color:#a90d91">void</span> <span style="color:#000">*</span><span style="color:#000">available</span>, <span style="color:#a90d91">const</span> <span style="color:#a90d91">uint32_t</span> <span style="color:#000">availableCount</span>,
</span></span><span style="display:flex;"><span>                   <span style="color:#a90d91">const</span> <span style="color:#a90d91">char</span> <span style="color:#000">*</span><span style="color:#000">enabledNames</span>[], <span style="color:#a90d91">uint32_t</span> <span style="color:#000">*</span><span style="color:#000">enabledCount</span>){
</span></span><span style="display:flex;"><span><span style="color:#633820">#if 1		</span><span style="color:#177500">//TODO 这里只是为了调试而打开，可以置为0关闭
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#000">Print</span>(<span style="color:#c41a16">&#34;%s available: &#34;</span>, <span style="color:#000">label</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">for</span>(<span style="color:#a90d91">int</span> <span style="color:#000">i</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>; <span style="color:#000">i</span> <span style="color:#000">&lt;</span> <span style="color:#000">availableCount</span>; <span style="color:#000">i</span><span style="color:#000">++</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#a90d91">const</span> <span style="color:#a90d91">char</span> <span style="color:#000">*</span> <span style="color:#000">name</span> <span style="color:#000">=</span> <span style="color:#000">extensions</span> <span style="color:#000">?</span> ((<span style="color:#a90d91">const</span> <span style="color:#000">VkExtensionProperties</span> <span style="color:#000">*</span>)<span style="color:#000">available</span>)[<span style="color:#000">i</span>].<span style="color:#000">extensionName</span> : ((<span style="color:#a90d91">const</span> <span style="color:#000">VkLayerProperties</span> <span style="color:#000">*</span>)<span style="color:#000">available</span>)[<span style="color:#000">i</span>].<span style="color:#000">layerName</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#000">Print</span>(<span style="color:#c41a16">&#34;%s&#34;</span>, <span style="color:#000">name</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span><span style="color:#633820">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#633820"></span>    <span style="color:#a90d91">bool</span> <span style="color:#000">foundAllRequired</span> <span style="color:#000">=</span> <span style="color:#a90d91">true</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">*</span><span style="color:#000">enabledCount</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">for</span> ( <span style="color:#a90d91">uint32_t</span> <span style="color:#000">i</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>; <span style="color:#000">i</span> <span style="color:#000">&lt;</span> <span style="color:#000">requestedCount</span>; <span style="color:#000">i</span><span style="color:#000">++</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a90d91">bool</span> <span style="color:#000">found</span> <span style="color:#000">=</span> <span style="color:#a90d91">false</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a90d91">const</span> <span style="color:#a90d91">char</span> <span style="color:#000">*</span><span style="color:#000">result</span> <span style="color:#000">=</span> <span style="color:#000">requested</span>[<span style="color:#000">i</span>].<span style="color:#000">required</span> <span style="color:#000">?</span> <span style="color:#c41a16">&#34;(required, not found)&#34;</span> <span style="color:#000">:</span> <span style="color:#c41a16">&#34;(not found)&#34;</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a90d91">for</span> ( <span style="color:#a90d91">uint32_t</span> <span style="color:#000">j</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>; <span style="color:#000">j</span> <span style="color:#000">&lt;</span> <span style="color:#000">availableCount</span>; <span style="color:#000">j</span><span style="color:#000">++</span> )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#a90d91">const</span> <span style="color:#a90d91">char</span> <span style="color:#000">*</span> <span style="color:#000">name</span> <span style="color:#000">=</span> <span style="color:#000">extensions</span> <span style="color:#000">?</span> ((<span style="color:#a90d91">const</span> <span style="color:#000">VkExtensionProperties</span> <span style="color:#000">*</span>)<span style="color:#000">available</span>)[<span style="color:#000">j</span>].<span style="color:#000">extensionName</span> :
</span></span><span style="display:flex;"><span>                                ((<span style="color:#a90d91">const</span> <span style="color:#000">VkLayerProperties</span> <span style="color:#000">*</span>)<span style="color:#000">available</span>)[<span style="color:#000">j</span>].<span style="color:#000">layerName</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#a90d91">if</span> ( <span style="color:#000">strcmp</span>( <span style="color:#000">requested</span>[<span style="color:#000">i</span>].<span style="color:#000">name</span>, <span style="color:#000">name</span> ) <span style="color:#000">==</span> <span style="color:#1c01ce">0</span> )
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#000">found</span> <span style="color:#000">=</span> <span style="color:#a90d91">true</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#a90d91">if</span> ( <span style="color:#000">requested</span>[<span style="color:#000">i</span>].<span style="color:#000">validationOnly</span> <span style="color:#000">&amp;&amp;</span> <span style="color:#000">!</span><span style="color:#000">validationEnabled</span> )
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#000">result</span> <span style="color:#000">=</span> <span style="color:#c41a16">&#34;(not enabled)&#34;</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#a90d91">break</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#000">enabledNames</span>[(<span style="color:#000">*</span><span style="color:#000">enabledCount</span>)<span style="color:#000">++</span>] <span style="color:#000">=</span> <span style="color:#000">requested</span>[<span style="color:#000">i</span>].<span style="color:#000">name</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#000">result</span> <span style="color:#000">=</span> <span style="color:#000">requested</span>[<span style="color:#000">i</span>].<span style="color:#000">required</span> <span style="color:#000">?</span> <span style="color:#c41a16">&#34;(required, enabled)&#34;</span> <span style="color:#000">:</span> <span style="color:#c41a16">&#34;(enabled)&#34;</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#a90d91">break</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#000">foundAllRequired</span> <span style="color:#000">&amp;=</span> ( <span style="color:#000">found</span> <span style="color:#000">||</span> <span style="color:#000">!</span><span style="color:#000">requested</span>[<span style="color:#000">i</span>].<span style="color:#000">required</span> );
</span></span><span style="display:flex;"><span>        <span style="color:#000">Print</span>( <span style="color:#c41a16">&#34;%-21s%c %s %s&#34;</span>, ( <span style="color:#000">i</span> <span style="color:#000">==</span> <span style="color:#1c01ce">0</span> <span style="color:#000">?</span> <span style="color:#000">label</span> : <span style="color:#c41a16">&#34;&#34;</span> ), ( <span style="color:#000">i</span> <span style="color:#000">==</span> <span style="color:#1c01ce">0</span> <span style="color:#000">?</span> <span style="color:#2300ce">&#39;:&#39;</span> <span style="color:#000">:</span> <span style="color:#2300ce">&#39; &#39;</span> ), <span style="color:#000">requested</span>[<span style="color:#000">i</span>].<span style="color:#000">name</span>, <span style="color:#000">result</span> );
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">return</span> <span style="color:#000">foundAllRequired</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>层验证</strong></p>
<p>在这个案例中，我们只使用一个层：API验证。</p>
<p>开启该层的作用是在调用Vulkan API过程中，如果出现错误会回调并提示。这个在开发调试阶段非常有用。在上线前如果有性能考虑则关闭该层即可。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">const</span> <span style="color:#000">DriverFeature</span> <span style="color:#000">validation_layers</span>[] <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>        {<span style="color:#c41a16">&#34;VK_LAYER_KHRONOS_validation&#34;</span>,    <span style="color:#a90d91">false</span>,     <span style="color:#a90d91">true</span>}
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>枚举查询和验证</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">createInstance</span>(<span style="color:#a90d91">bool</span> <span style="color:#000">bValidate</span>, <span style="color:#000">VkInstance</span> <span style="color:#000">*</span><span style="color:#000">out_instance</span>, <span style="color:#000">VkDebugReportCallbackEXT</span> <span style="color:#000">*</span><span style="color:#000">out_debugReport</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#177500">//instance layers
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#a90d91">uint32_t</span> <span style="color:#000">availableLayerCount</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">CALL_VK</span>(<span style="color:#000">vkEnumerateInstanceLayerProperties</span>(<span style="color:#000">&amp;</span><span style="color:#000">availableLayerCount</span>, <span style="color:#a90d91">nullptr</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkLayerProperties</span> <span style="color:#000">availableLayerProps</span>[<span style="color:#000">availableLayerCount</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#000">CALL_VK</span>(<span style="color:#000">vkEnumerateInstanceLayerProperties</span>(<span style="color:#000">&amp;</span><span style="color:#000">availableLayerCount</span>, <span style="color:#000">availableLayerProps</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#000">Print</span>(<span style="color:#c41a16">&#34;---------------------------------&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">const</span> <span style="color:#a90d91">char</span> <span style="color:#000">*</span><span style="color:#000">enabledLayerNames</span>[<span style="color:#1c01ce">32</span>] <span style="color:#000">=</span> {};
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">uint32_t</span> <span style="color:#000">enabledLayerCount</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">checkFeatures</span>(<span style="color:#c41a16">&#34;Instance Layers&#34;</span>, <span style="color:#000">bValidate</span>, <span style="color:#a90d91">false</span>, <span style="color:#000">validation_layers</span>, <span style="color:#000">ARRAY_SIZE</span>(<span style="color:#000">validation_layers</span>),
</span></span><span style="display:flex;"><span>                  <span style="color:#000">availableLayerProps</span>, <span style="color:#000">availableLayerCount</span>, <span style="color:#000">enabledLayerNames</span>, <span style="color:#000">&amp;</span><span style="color:#000">enabledLayerCount</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#177500">//TODO
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>}
</span></span></code></pre></div><p>结果输出（不同硬件环境结果可能略有不同）。</p>
<p><figure class="max-w-2xl mx-auto overflow-hidden">
    
    <a data-fancybox="gallery" href="./../assets/image-20230529114344250.png" target="_blank">
        <img alt="" src="./../assets/image-20230529114344250.png" />
    </a>
    
    <figcaption class="p-2 text-center"></figcaption>
</figure>
    </p>
<p><strong>扩展验证</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">const</span> <span style="color:#000">DriverFeature</span> <span style="color:#000">validation_extensions</span>[] <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>        {<span style="color:#c41a16">&#34;VK_KHR_surface&#34;</span>,    <span style="color:#a90d91">false</span>,     <span style="color:#a90d91">true</span>},
</span></span><span style="display:flex;"><span>        {<span style="color:#c41a16">&#34;VK_KHR_win32_surface&#34;</span>,    <span style="color:#a90d91">false</span>,     <span style="color:#a90d91">true</span>}
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><ul>
<li>VK_KHR_surface 窗口表面支持。</li>
<li>VK_KHR_win32_surface 针对Win32的窗口表面支持，如果是其他操作系统，这里需要变更。</li>
</ul>
<p>对于扩展验证也是类似的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#177500">//instance extensions
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span><span style="color:#a90d91">uint32_t</span> <span style="color:#000">availableExtensionCount</span>;
</span></span><span style="display:flex;"><span><span style="color:#000">CALL_VK</span>(<span style="color:#000">vkEnumerateInstanceExtensionProperties</span>(<span style="color:#a90d91">nullptr</span>, <span style="color:#000">&amp;</span><span style="color:#000">availableExtensionCount</span>, <span style="color:#a90d91">nullptr</span>));
</span></span><span style="display:flex;"><span><span style="color:#000">VkExtensionProperties</span> <span style="color:#000">availableExtensionProps</span>[<span style="color:#000">availableExtensionCount</span>];
</span></span><span style="display:flex;"><span><span style="color:#000">CALL_VK</span>(<span style="color:#000">vkEnumerateInstanceExtensionProperties</span>(<span style="color:#a90d91">nullptr</span>, <span style="color:#000">&amp;</span><span style="color:#000">availableExtensionCount</span>, <span style="color:#000">availableExtensionProps</span>));
</span></span><span style="display:flex;"><span><span style="color:#000">Print</span>(<span style="color:#c41a16">&#34;---------------------------------&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#a90d91">const</span> <span style="color:#a90d91">char</span> <span style="color:#000">*</span><span style="color:#000">enableExtensionNames</span>[<span style="color:#1c01ce">32</span>] <span style="color:#000">=</span> {};
</span></span><span style="display:flex;"><span><span style="color:#a90d91">uint32_t</span> <span style="color:#000">enableExtensionCount</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#000">checkFeatures</span>(<span style="color:#c41a16">&#34;Instance Extensions&#34;</span>, <span style="color:#000">bValidate</span>, <span style="color:#a90d91">true</span>, <span style="color:#000">validation_extensions</span>, <span style="color:#000">ARRAY_SIZE</span>(<span style="color:#000">validation_extensions</span>),
</span></span><span style="display:flex;"><span>              <span style="color:#000">availableExtensionProps</span>, <span style="color:#000">availableExtensionCount</span>, <span style="color:#000">enableExtensionNames</span>, <span style="color:#000">&amp;</span><span style="color:#000">enableExtensionCount</span>);
</span></span></code></pre></div><p>我们获得的是最终的层和扩展：enabledLayerNames，enabledLayerCount，enableExtensionNames，enableExtensionCount。在接下来的VkInstance的创建中，我们将首次见到上文提到的代码风格。</p>
<p><strong>创建VkInstance</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#000">VkInstanceCreateInfo</span> <span style="color:#000">createInfo</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>        .<span style="color:#000">sType</span> <span style="color:#000">=</span> <span style="color:#000">VK_STRUCTURE_TYPE_INSTANCE_CREATE_INFO</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pNext</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">flags</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pApplicationInfo</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">enabledLayerCount</span> <span style="color:#000">=</span> <span style="color:#000">enabledLayerCount</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">ppEnabledLayerNames</span> <span style="color:#000">=</span> <span style="color:#000">enabledLayerCount</span> <span style="color:#000">==</span> <span style="color:#1c01ce">0</span> <span style="color:#000">?</span> <span style="color:#a90d91">nullptr</span> <span style="color:#000">:</span> <span style="color:#000">enabledLayerNames</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">enabledExtensionCount</span> <span style="color:#000">=</span> <span style="color:#000">enableExtensionCount</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">ppEnabledExtensionNames</span> <span style="color:#000">=</span> <span style="color:#000">enableExtensionCount</span> <span style="color:#000">==</span> <span style="color:#1c01ce">0</span> <span style="color:#000">?</span> <span style="color:#a90d91">nullptr</span> <span style="color:#000">:</span> <span style="color:#000">enableExtensionNames</span>
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#000">CALL_VK</span>(<span style="color:#000">vkCreateInstance</span>(<span style="color:#000">&amp;</span><span style="color:#000">createInfo</span>, <span style="color:#000">VK_ALLOC</span>, <span style="color:#000">out_instance</span>));
</span></span></code></pre></div><p>我们定义好了这一框架之后，发现有一个成员变量还需要赋值：<code>pApplicationInfo</code>，从<code>VkInstanceCreateInfo</code>结构体可知，我们需要一个<code>VkApplicationInfo</code>对象指针，因此我们也需要初始化。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#000">VkApplicationInfo</span> <span style="color:#000">application</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>        .<span style="color:#000">sType</span> <span style="color:#000">=</span> <span style="color:#000">VK_STRUCTURE_TYPE_APPLICATION_INFO</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pNext</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pApplicationName</span> <span style="color:#000">=</span> <span style="color:#000">APP_NAME</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">applicationVersion</span> <span style="color:#000">=</span> <span style="color:#000">VK_MAKE_VERSION</span>(<span style="color:#1c01ce">1</span>, <span style="color:#1c01ce">0</span>, <span style="color:#1c01ce">0</span>),
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pEngineName</span> <span style="color:#000">=</span> <span style="color:#000">APP_NAME</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">engineVersion</span> <span style="color:#000">=</span> <span style="color:#000">VK_MAKE_VERSION</span>(<span style="color:#1c01ce">1</span>, <span style="color:#1c01ce">0</span>, <span style="color:#1c01ce">0</span>),
</span></span><span style="display:flex;"><span>        .<span style="color:#000">apiVersion</span> <span style="color:#000">=</span> <span style="color:#000">VK_VERSION_1_0</span>
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>这是在创建VkInstance需要指定的一些App信息，包括版本号指定、应用名称等。</p>
<p>如此一来，我们将<code>application</code>赋值给<code>pApplicationInfo</code>即可。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#000">VkInstanceCreateInfo</span> <span style="color:#000">createInfo</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>        .<span style="color:#000">sType</span> <span style="color:#000">=</span> <span style="color:#000">VK_STRUCTURE_TYPE_INSTANCE_CREATE_INFO</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pNext</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">flags</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pApplicationInfo</span> <span style="color:#000">=</span> <span style="color:#000">&amp;</span><span style="color:#000">application</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">enabledLayerCount</span> <span style="color:#000">=</span> <span style="color:#000">enabledLayerCount</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">ppEnabledLayerNames</span> <span style="color:#000">=</span> <span style="color:#000">enabledLayerCount</span> <span style="color:#000">==</span> <span style="color:#1c01ce">0</span> <span style="color:#000">?</span> <span style="color:#a90d91">nullptr</span> <span style="color:#000">:</span> <span style="color:#000">enabledLayerNames</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">enabledExtensionCount</span> <span style="color:#000">=</span> <span style="color:#000">enableExtensionCount</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">ppEnabledExtensionNames</span> <span style="color:#000">=</span> <span style="color:#000">enableExtensionCount</span> <span style="color:#000">==</span> <span style="color:#1c01ce">0</span> <span style="color:#000">?</span> <span style="color:#a90d91">nullptr</span> <span style="color:#000">:</span> <span style="color:#000">enableExtensionNames</span>
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p><strong>添加验证层配置</strong></p>
<p>还记得我们之前定义的<code>validation_layers</code>吗？如果需要Vulkan报告API调用中的错误，就需要添加一个错误回调。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#000">VkBool32</span> <span style="color:#000">debugReportCallback</span>(<span style="color:#000">VkDebugReportFlagsEXT</span> <span style="color:#000">msgFlags</span>, <span style="color:#000">VkDebugReportObjectTypeEXT</span> <span style="color:#000">objType</span>, <span style="color:#a90d91">uint64_t</span> <span style="color:#000">srcObject</span>, <span style="color:#000">size_t</span> <span style="color:#000">location</span>, <span style="color:#a90d91">int32_t</span> <span style="color:#000">msgCode</span>, <span style="color:#a90d91">const</span> <span style="color:#a90d91">char</span> <span style="color:#000">*</span><span style="color:#000">pLayerPrefix</span>, <span style="color:#a90d91">const</span> <span style="color:#a90d91">char</span> <span style="color:#000">*</span><span style="color:#000">pMsg</span>, <span style="color:#a90d91">void</span> <span style="color:#000">*</span><span style="color:#000">pUserData</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">if</span>(<span style="color:#000">msgFlags</span> <span style="color:#000">==</span> <span style="color:#000">VK_DEBUG_REPORT_ERROR_BIT_EXT</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#000">Error</span>(<span style="color:#c41a16">&#34;%s: [%s] Code %d : %s&#34;</span>, <span style="color:#c41a16">&#34;Error&#34;</span>, <span style="color:#000">pLayerPrefix</span>, <span style="color:#000">msgCode</span>, <span style="color:#000">pMsg</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#a90d91">else</span> <span style="color:#a90d91">if</span>(<span style="color:#000">msgFlags</span> <span style="color:#000">==</span> <span style="color:#000">VK_DEBUG_REPORT_WARNING_BIT_EXT</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#000">Warn</span>(<span style="color:#c41a16">&#34;%s: [%s] Code %d : %s&#34;</span>, <span style="color:#c41a16">&#34;Warning&#34;</span>, <span style="color:#000">pLayerPrefix</span>, <span style="color:#000">msgCode</span>, <span style="color:#000">pMsg</span>);
</span></span><span style="display:flex;"><span>    } <span style="color:#a90d91">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#000">Print</span>(<span style="color:#c41a16">&#34;%s: [%s] Code %d : %s&#34;</span>, <span style="color:#c41a16">&#34;Info&#34;</span>, <span style="color:#000">pLayerPrefix</span>, <span style="color:#000">msgCode</span>, <span style="color:#000">pMsg</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">return</span> <span style="color:#000">VK_FALSE</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>另外，在上文中执行<code>vkCreateInstance()</code>之前，创建<code>VkDebugReportCallbackCreateInfoEXT</code>并赋值到<code>pNext</code>成员变量上，我们的验证层即可使用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#000">VkInstanceCreateInfo</span> <span style="color:#000">createInfo</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#177500">//在创建VkInstance之前
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span><span style="color:#a90d91">if</span>(<span style="color:#000">bValidate</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkDebugReportCallbackCreateInfoEXT</span> <span style="color:#000">debugReport</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>        .<span style="color:#000">sType</span> <span style="color:#000">=</span> <span style="color:#000">VK_STRUCTURE_TYPE_DEBUG_REPORT_CALLBACK_CREATE_INFO_EXT</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pNext</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">flags</span> <span style="color:#000">=</span> <span style="color:#000">VK_DEBUG_REPORT_ERROR_BIT_EXT</span> <span style="color:#000">|</span>				<span style="color:#177500">//错误信息
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>                 <span style="color:#000">VK_DEBUG_REPORT_WARNING_BIT_EXT</span> <span style="color:#000">|</span>				<span style="color:#177500">//警告信息
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>                 <span style="color:#000">VK_DEBUG_REPORT_PERFORMANCE_WARNING_BIT_EXT</span>,	<span style="color:#177500">//性能警告信息
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>        .<span style="color:#000">pfnCallback</span> <span style="color:#000">=</span> (<span style="color:#000">PFN_vkDebugReportCallbackEXT</span>) <span style="color:#000">debugReportCallback</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pUserData</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000">createInfo</span>.<span style="color:#000">pNext</span> <span style="color:#000">=</span> <span style="color:#000">&amp;</span><span style="color:#000">debugReport</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">CALL_VK</span>(<span style="color:#000">vkCreateInstance</span>(<span style="color:#000">&amp;</span><span style="color:#000">createInfo</span>, <span style="color:#000">VK_ALLOC</span>, <span style="color:#000">out_instance</span>));
</span></span></code></pre></div><p><strong>使用和销毁</strong></p>
<p>在<code>init()</code>中调用创建函数，并在<code>destroy()</code>中回收。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">init</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">createInstance</span>(<span style="color:#a90d91">true</span>, <span style="color:#000">&amp;</span><span style="color:#000">vk</span>.<span style="color:#000">instance</span>, <span style="color:#000">&amp;</span><span style="color:#000">vk</span>.<span style="color:#000">debugReport</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">destroy</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#000">Print</span>(<span style="color:#c41a16">&#34;%s&#34;</span>, <span style="color:#000">__FUNCTION__</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">vkDestroyInstance</span>(<span style="color:#000">vk</span>.<span style="color:#000">instance</span>, <span style="color:#000">VK_ALLOC</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>此时我们可以测试VkInstance是否创建成功。如果没有错误日志而且out_instance指针不为空，则表示程序运行正常。我们也可以测试一下验证层是否成果，比如在<code>VkInstanceCreateInfo</code>中将<code>ppEnabledExtensionNames</code>置为nullptr。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#000">VkInstanceCreateInfo</span> <span style="color:#000">createInfo</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>            .<span style="color:#000">sType</span> <span style="color:#000">=</span> <span style="color:#000">VK_STRUCTURE_TYPE_INSTANCE_CREATE_INFO</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">pNext</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">flags</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">pApplicationInfo</span> <span style="color:#000">=</span> <span style="color:#000">&amp;</span><span style="color:#000">application</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">enabledLayerCount</span> <span style="color:#000">=</span> <span style="color:#000">enabledLayerCount</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">ppEnabledLayerNames</span> <span style="color:#000">=</span> <span style="color:#000">enabledLayerCount</span> <span style="color:#000">==</span> <span style="color:#1c01ce">0</span> <span style="color:#000">?</span> <span style="color:#a90d91">nullptr</span> <span style="color:#000">:</span> <span style="color:#000">enabledLayerNames</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">enabledExtensionCount</span> <span style="color:#000">=</span> <span style="color:#000">enableExtensionCount</span>,
</span></span><span style="display:flex;"><span>    		<span style="color:#177500">// 更改这里，可以测试验证层是否成功。
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>            .<span style="color:#000">ppEnabledExtensionNames</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>, <span style="color:#177500">//enableExtensionCount == 0 ? nullptr : enableExtensionNames
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    };
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>如果验证层已经成功，将看到以下错误信息。</p>
<p><figure class="max-w-2xl mx-auto overflow-hidden">
    
    <a data-fancybox="gallery" href="./../assets/image-20230529132409189.png" target="_blank">
        <img alt="" src="./../assets/image-20230529132409189.png" />
    </a>
    
    <figcaption class="p-2 text-center"></figcaption>
</figure>
    </p>
<h3 id="32-窗口表面">3.2 窗口表面</h3>
<p>在<code>VkBundle</code>中添加<code>surface</code>成员变量存储窗口表面对象。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">struct</span> <span style="color:#3f6e75">VkBundle</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkInstance</span> <span style="color:#000">instance</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkDebugReportCallbackEXT</span> <span style="color:#000">debugReport</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkSurfaceKHR</span> <span style="color:#000">surface</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>利用GLFW实现窗口创建和Surface创建，这里GLFW的使用就不做过多解释了，我之前写过一点，感兴趣的话可以<a href="/posts/opengl_renderer/03_opengl%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA.html#hello-window">点击这里</a>看看。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#633820">#define WINDOW_WIDTH 800
</span></span></span><span style="display:flex;"><span><span style="color:#633820">#define WINDOW_HEIGHT 600
</span></span></span><span style="display:flex;"><span><span style="color:#633820"></span><span style="color:#000">GLFWwindow</span> <span style="color:#000">*</span><span style="color:#000">window</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">createWindow</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">if</span>(<span style="color:#000">!</span><span style="color:#000">glfwInit</span>()){
</span></span><span style="display:flex;"><span>        <span style="color:#a90d91">throw</span> <span style="color:#000">std</span><span style="color:#000">::</span><span style="color:#000">runtime_error</span>(<span style="color:#c41a16">&#34;Can not init glfw window.&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#000">glfwWindowHint</span>(<span style="color:#000">GLFW_CLIENT_API</span>, <span style="color:#000">GLFW_NO_API</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">glfwWindowHint</span>(<span style="color:#000">GLFW_RESIZABLE</span>, <span style="color:#000">GL_FALSE</span>); <span style="color:#177500">// 暂时不允许改变大小，改变大小后需要重置交换链，后续demo实现
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#000">window</span> <span style="color:#000">=</span> <span style="color:#000">glfwCreateWindow</span>(<span style="color:#000">WINDOW_WIDTH</span>, <span style="color:#000">WINDOW_HEIGHT</span>, <span style="color:#000">APP_NAME</span>, <span style="color:#a90d91">nullptr</span>, <span style="color:#a90d91">nullptr</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">if</span>(<span style="color:#000">!</span><span style="color:#000">window</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#a90d91">throw</span> <span style="color:#000">std</span><span style="color:#000">::</span><span style="color:#000">runtime_error</span>(<span style="color:#c41a16">&#34;Can not create glfw window&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Print</span>(<span style="color:#c41a16">&#34;GLFW Vulkan Support: %d&#34;</span>, <span style="color:#000">glfwVulkanSupported</span>());
</span></span><span style="display:flex;"><span>    <span style="color:#000">glfwMakeContextCurrent</span>(<span style="color:#000">window</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">if</span>(<span style="color:#000">glfwCreateWindowSurface</span>(<span style="color:#000">vk</span>.<span style="color:#000">instance</span>, <span style="color:#000">window</span>, <span style="color:#000">VK_ALLOC</span>, <span style="color:#000">&amp;</span><span style="color:#000">vk</span>.<span style="color:#000">surface</span>) <span style="color:#000">!=</span> <span style="color:#000">VK_SUCCESS</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#a90d91">throw</span> <span style="color:#000">std</span><span style="color:#000">::</span><span style="color:#000">runtime_error</span>(<span style="color:#c41a16">&#34;Can not creat surface.&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Print</span>(<span style="color:#c41a16">&#34;surface: %p&#34;</span>, <span style="color:#000">vk</span>.<span style="color:#000">surface</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>在<code>init()</code>中执行Window的创建。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">init</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">createInstance</span>(<span style="color:#a90d91">true</span>, <span style="color:#000">&amp;</span><span style="color:#000">vk</span>.<span style="color:#000">instance</span>, <span style="color:#000">&amp;</span><span style="color:#000">vk</span>.<span style="color:#000">debugReport</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">createWindow</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>在渲染主循环中，添加GLFW窗口的事件监听和切换缓冲区。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">renderLoop</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">uint32_t</span> <span style="color:#000">currentFrame</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">while</span>(<span style="color:#000">!</span><span style="color:#000">glfwWindowShouldClose</span>(<span style="color:#000">window</span>)){
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#000">glfwPollEvents</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">render</span>(<span style="color:#000">currentFrame</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">glfwSwapBuffers</span>(<span style="color:#000">window</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#000">currentFrame</span> <span style="color:#000">++</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>在<code>destroy()</code>中销毁surface，并终止GLFW的窗口运行。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">destroy</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#000">Print</span>(<span style="color:#c41a16">&#34;%s&#34;</span>, <span style="color:#000">__FUNCTION__</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">vkDestroySurfaceKHR</span>(<span style="color:#000">vk</span>.<span style="color:#000">instance</span>, <span style="color:#000">vk</span>.<span style="color:#000">surface</span>, <span style="color:#000">VK_ALLOC</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">vkDestroyInstance</span>(<span style="color:#000">vk</span>.<span style="color:#000">instance</span>, <span style="color:#000">VK_ALLOC</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">glfwDestroyWindow</span>(<span style="color:#000">window</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">glfwTerminate</span>();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>如果运行正常，可以看到一个什么都没有的窗口了。</p>
<p><figure class="max-w-2xl mx-auto overflow-hidden">
    
    <a data-fancybox="gallery" href="../assets/image-20230613164651880.png" target="_blank">
        <img alt="" src="../assets/image-20230613164651880.png" />
    </a>
    
    <figcaption class="p-2 text-center"></figcaption>
</figure>
    </p>
<h3 id="33-逻辑设备">3.3 逻辑设备</h3>
<p>在<code>VkBundle</code>中添加device和queue的成员变量。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">struct</span> <span style="color:#3f6e75">DeviceInfo</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkPhysicalDevice</span> <span style="color:#000">physicalDev</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkPhysicalDeviceLimits</span> <span style="color:#000">physicalDevLimits</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkPhysicalDeviceMemoryProperties</span> <span style="color:#000">physicalDevMemoProps</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkDevice</span> <span style="color:#000">device</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a90d91">struct</span> <span style="color:#3f6e75">QueueInfo</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">uint16_t</span> <span style="color:#000">workQueueIndex</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">uint16_t</span> <span style="color:#000">presentQueueIndex</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkQueue</span> <span style="color:#000">queue</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a90d91">struct</span> <span style="color:#3f6e75">VkBundle</span> {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">struct</span> <span style="color:#3f6e75">DeviceInfo</span> <span style="color:#000">deviceInfo</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">struct</span> <span style="color:#3f6e75">QueueInfo</span> <span style="color:#000">queueInfo</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>在<code>VkHelper</code>中添加<code>pickPhyDevAndCreateDev()</code>函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">pickPhyDevAndCreateDev</span>(<span style="color:#000">VkInstance</span> <span style="color:#000">instance</span>, <span style="color:#000">VkSurfaceKHR</span> <span style="color:#000">surface</span>, <span style="color:#000">DeviceInfo</span> <span style="color:#000">*</span><span style="color:#000">out_deviceInfo</span>, <span style="color:#000">QueueInfo</span> <span style="color:#000">*</span><span style="color:#000">out_queueInfo</span>) {}
</span></span></code></pre></div><p>创建逻辑设备的步骤：</p>
<ol>
<li>查询出来所有的物理设备；</li>
<li>遍历所有物理设备，找到支持窗口表面的设备，并且判断队列族是否支持图形管线（因为我们这个案例需要用图形渲染管线渲染），如果符合，将队列索引记录下来，备用；</li>
<li>查询物理设备的限量、内存属性并赋值，后续内存操作时使用；</li>
<li>查询设备支持扩展列表并验证；</li>
<li>创建逻辑设备；</li>
<li>从逻辑设备获取已创建的队列并赋值给<code>VkBundle</code>备用。</li>
</ol>
<p><strong>选取合适的物理设备</strong></p>
<p>枚举出来索引的物理设备。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">pickPhyDevAndCreateDev</span>(<span style="color:#000">VkInstance</span> <span style="color:#000">instance</span>, <span style="color:#000">VkSurfaceKHR</span> <span style="color:#000">surface</span>, <span style="color:#000">DeviceInfo</span> <span style="color:#000">*</span><span style="color:#000">out_deviceInfo</span>, <span style="color:#000">QueueInfo</span> <span style="color:#000">*</span><span style="color:#000">out_queueInfo</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">uint32_t</span> <span style="color:#000">physicalDevCount</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">CALL_VK</span>(<span style="color:#000">vkEnumeratePhysicalDevices</span>(<span style="color:#000">instance</span>, <span style="color:#000">&amp;</span><span style="color:#000">physicalDevCount</span>, <span style="color:#a90d91">nullptr</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkPhysicalDevice</span> <span style="color:#000">physicalDevs</span>[<span style="color:#000">physicalDevCount</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#000">CALL_VK</span>(<span style="color:#000">vkEnumeratePhysicalDevices</span>(<span style="color:#000">instance</span>, <span style="color:#000">&amp;</span><span style="color:#000">physicalDevCount</span>, <span style="color:#000">physicalDevs</span>));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>根据应用程序要求，找到合适的物理设备。这些要求可以是筛选这个物理设备是否支持某些表面格式，或者某些Shader API的支持情况。在实际生产开发中，也有可能选择多个物理设备（多GPU的情况下），以满足应用程序运行的性能要求。</p>
<p>在本案例中，我们只有两个要求，那就是物理设备<strong>支持表面格式(Surface)<strong>和</strong>队列族支持图形管线</strong>。</p>
<ul>
<li>查询是支持表面格式：<code>vkGetPhysicalDeviceSurfaceSupportKHR(...)</code></li>
<li>查询队列族是否支持图形管线：<code>if(queueFlags &amp; VK_QUEUE_GRAPHICS_BIT)</code></li>
</ul>
<p>上文提到过，队列族可能是以下几种：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">typedef</span> <span style="color:#a90d91">enum</span> <span style="color:#3f6e75">VkQueueFlagBits</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#000">VK_QUEUE_GRAPHICS_BIT</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0x00000001</span>,			<span style="color:#177500">// 图形
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#000">VK_QUEUE_COMPUTE_BIT</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0x00000002</span>,			<span style="color:#177500">// 计算
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#000">VK_QUEUE_TRANSFER_BIT</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0x00000004</span>,			<span style="color:#177500">// 传输
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>	...
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>} <span style="color:#000">VkQueueFlagBits</span>;
</span></span></code></pre></div><p>所以找到一个支持表面格式和图形管线的队列族，就跳出循环，将该物理设备给到应用程序使用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">printPhysicalDevLog</span>(<span style="color:#a90d91">const</span> <span style="color:#000">VkPhysicalDeviceProperties</span> <span style="color:#000">&amp;</span><span style="color:#000">devProps</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#177500">/****************** For log *********************/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">const</span> <span style="color:#a90d91">uint32_t</span> <span style="color:#000">driverMajor</span> <span style="color:#000">=</span> <span style="color:#000">VK_VERSION_MAJOR</span>(<span style="color:#000">devProps</span>.<span style="color:#000">driverVersion</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">const</span> <span style="color:#a90d91">uint32_t</span> <span style="color:#000">driverMinor</span> <span style="color:#000">=</span> <span style="color:#000">VK_VERSION_MINOR</span>(<span style="color:#000">devProps</span>.<span style="color:#000">driverVersion</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">const</span> <span style="color:#a90d91">uint32_t</span> <span style="color:#000">driverPatch</span> <span style="color:#000">=</span> <span style="color:#000">VK_VERSION_PATCH</span>(<span style="color:#000">devProps</span>.<span style="color:#000">driverVersion</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">const</span> <span style="color:#a90d91">uint32_t</span> <span style="color:#000">apiMajor</span> <span style="color:#000">=</span> <span style="color:#000">VK_VERSION_MAJOR</span>(<span style="color:#000">devProps</span>.<span style="color:#000">apiVersion</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">const</span> <span style="color:#a90d91">uint32_t</span> <span style="color:#000">apiMinor</span> <span style="color:#000">=</span> <span style="color:#000">VK_VERSION_MINOR</span>(<span style="color:#000">devProps</span>.<span style="color:#000">apiVersion</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">const</span> <span style="color:#a90d91">uint32_t</span> <span style="color:#000">apiPatch</span> <span style="color:#000">=</span> <span style="color:#000">VK_VERSION_PATCH</span>(<span style="color:#000">devProps</span>.<span style="color:#000">apiVersion</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Print</span>(<span style="color:#c41a16">&#34;---------------------------------&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">Print</span>(<span style="color:#c41a16">&#34;Device Name          : %s&#34;</span>, <span style="color:#000">devProps</span>.<span style="color:#000">deviceName</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">Print</span>(<span style="color:#c41a16">&#34;Device Type          : %s&#34;</span>,
</span></span><span style="display:flex;"><span>          ((<span style="color:#000">devProps</span>.<span style="color:#000">deviceType</span> <span style="color:#000">==</span> <span style="color:#000">VK_PHYSICAL_DEVICE_TYPE_INTEGRATED_GPU</span>) <span style="color:#000">?</span> <span style="color:#c41a16">&#34;integrated GPU&#34;</span> <span style="color:#000">:</span>
</span></span><span style="display:flex;"><span>           ((<span style="color:#000">devProps</span>.<span style="color:#000">deviceType</span> <span style="color:#000">==</span> <span style="color:#000">VK_PHYSICAL_DEVICE_TYPE_DISCRETE_GPU</span>) <span style="color:#000">?</span> <span style="color:#c41a16">&#34;discrete GPU&#34;</span> <span style="color:#000">:</span>
</span></span><span style="display:flex;"><span>            ((<span style="color:#000">devProps</span>.<span style="color:#000">deviceType</span> <span style="color:#000">==</span> <span style="color:#000">VK_PHYSICAL_DEVICE_TYPE_VIRTUAL_GPU</span>) <span style="color:#000">?</span> <span style="color:#c41a16">&#34;virtual GPU&#34;</span> <span style="color:#000">:</span>
</span></span><span style="display:flex;"><span>             ((<span style="color:#000">devProps</span>.<span style="color:#000">deviceType</span> <span style="color:#000">==</span> <span style="color:#000">VK_PHYSICAL_DEVICE_TYPE_CPU</span>) <span style="color:#000">?</span> <span style="color:#c41a16">&#34;CPU&#34;</span> <span style="color:#000">:</span> <span style="color:#c41a16">&#34;unknown&#34;</span>)))));
</span></span><span style="display:flex;"><span>    <span style="color:#000">Print</span>(<span style="color:#c41a16">&#34;Vendor ID            : 0x%04X&#34;</span>, <span style="color:#000">devProps</span>.<span style="color:#000">vendorID</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">Print</span>(<span style="color:#c41a16">&#34;Device ID            : 0x%04X&#34;</span>, <span style="color:#000">devProps</span>.<span style="color:#000">deviceID</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">Print</span>(<span style="color:#c41a16">&#34;Driver Version       : %d.%d.%d&#34;</span>, <span style="color:#000">driverMajor</span>, <span style="color:#000">driverMinor</span>, <span style="color:#000">driverPatch</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">Print</span>(<span style="color:#c41a16">&#34;API Version          : %d.%d.%d&#34;</span>, <span style="color:#000">apiMajor</span>, <span style="color:#000">apiMinor</span>, <span style="color:#000">apiPatch</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#177500">/****************** For log *********************/</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">pickPhyDevAndCreateDev</span>(<span style="color:#000">VkInstance</span> <span style="color:#000">instance</span>, <span style="color:#000">VkSurfaceKHR</span> <span style="color:#000">surface</span>, <span style="color:#000">DeviceInfo</span> <span style="color:#000">*</span><span style="color:#000">out_deviceInfo</span>, <span style="color:#000">QueueInfo</span> <span style="color:#000">*</span><span style="color:#000">out_queueInfo</span>) {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#000">Print</span>(<span style="color:#c41a16">&#34;---------------------------------&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">Print</span>(<span style="color:#c41a16">&#34;Physical Devices:&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#177500">//选取的物理设备和队列索引
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#000">VkPhysicalDevice</span> <span style="color:#000">selectedPhysicalDev</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">uint16_t</span> <span style="color:#000">workQueueIndex</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">uint16_t</span> <span style="color:#000">presentQueueIndex</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">for</span>(<span style="color:#a90d91">int</span> <span style="color:#000">i</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>; <span style="color:#000">i</span> <span style="color:#000">&lt;</span> <span style="color:#000">physicalDevCount</span>; <span style="color:#000">i</span><span style="color:#000">++</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#000">VkPhysicalDeviceProperties</span> <span style="color:#000">devProps</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#000">vkGetPhysicalDeviceProperties</span>(<span style="color:#000">physicalDevs</span>[<span style="color:#000">i</span>], <span style="color:#000">&amp;</span><span style="color:#000">devProps</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#177500">//打印Log，不影响流程
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>        <span style="color:#000">printPhysicalDevLog</span>(<span style="color:#000">devProps</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a90d91">uint32_t</span> <span style="color:#000">queueFamilyPropCount</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#000">vkGetPhysicalDeviceQueueFamilyProperties</span>(<span style="color:#000">physicalDevs</span>[<span style="color:#000">i</span>], <span style="color:#000">&amp;</span><span style="color:#000">queueFamilyPropCount</span>, <span style="color:#a90d91">nullptr</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#000">VkQueueFamilyProperties</span> <span style="color:#000">queueFamilyProps</span>[<span style="color:#000">queueFamilyPropCount</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#000">vkGetPhysicalDeviceQueueFamilyProperties</span>(<span style="color:#000">physicalDevs</span>[<span style="color:#000">i</span>], <span style="color:#000">&amp;</span><span style="color:#000">queueFamilyPropCount</span>, <span style="color:#000">queueFamilyProps</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#177500">//表面查询支持
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>        <span style="color:#a90d91">for</span>(<span style="color:#a90d91">int</span> <span style="color:#000">j</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>; <span style="color:#000">j</span> <span style="color:#000">&lt;</span> <span style="color:#000">queueFamilyPropCount</span>; <span style="color:#000">j</span><span style="color:#000">++</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#000">VkBool32</span> <span style="color:#000">surfaceSupport</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#000">vkGetPhysicalDeviceSurfaceSupportKHR</span>(<span style="color:#000">physicalDevs</span>[<span style="color:#000">i</span>], <span style="color:#000">i</span>, <span style="color:#000">surface</span>, <span style="color:#000">&amp;</span><span style="color:#000">surfaceSupport</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#000">Print</span>(<span style="color:#c41a16">&#34;Surface Support: %d&#34;</span>, <span style="color:#000">surfaceSupport</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#177500">//支持图形渲染管线
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>            <span style="color:#a90d91">if</span>(<span style="color:#000">surfaceSupport</span> <span style="color:#000">&amp;&amp;</span> <span style="color:#000">queueFamilyProps</span>[<span style="color:#000">j</span>].<span style="color:#000">queueFlags</span> <span style="color:#000">&amp;</span> <span style="color:#000">VK_QUEUE_GRAPHICS_BIT</span>) {
</span></span><span style="display:flex;"><span>                <span style="color:#000">selectedPhysicalDev</span> <span style="color:#000">=</span> <span style="color:#000">physicalDevs</span>[<span style="color:#000">i</span>];
</span></span><span style="display:flex;"><span>                <span style="color:#000">workQueueIndex</span> <span style="color:#000">=</span> <span style="color:#000">j</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#000">presentQueueIndex</span> <span style="color:#000">=</span> <span style="color:#000">j</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#a90d91">break</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">if</span>(<span style="color:#a90d91">nullptr</span> <span style="color:#000">==</span> <span style="color:#000">selectedPhysicalDev</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#a90d91">throw</span> <span style="color:#000">std</span><span style="color:#000">::</span><span style="color:#000">runtime_error</span>(<span style="color:#c41a16">&#34;Can not find any suitable Physical device.&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>物理设备属性，仅作记录，本案例暂时用不到</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">pickPhyDevAndCreateDev</span>(<span style="color:#000">VkInstance</span> <span style="color:#000">instance</span>, <span style="color:#000">VkSurfaceKHR</span> <span style="color:#000">surface</span>, <span style="color:#000">DeviceInfo</span> <span style="color:#000">*</span><span style="color:#000">out_deviceInfo</span>, <span style="color:#000">QueueInfo</span> <span style="color:#000">*</span><span style="color:#000">out_queueInfo</span>) {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkPhysicalDeviceProperties</span> <span style="color:#000">devProps</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">vkGetPhysicalDeviceProperties</span>(<span style="color:#000">selectedPhysicalDev</span>, <span style="color:#000">&amp;</span><span style="color:#000">devProps</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">out_deviceInfo</span><span style="color:#000">-&gt;</span><span style="color:#000">physicalDev</span> <span style="color:#000">=</span> <span style="color:#000">selectedPhysicalDev</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">out_deviceInfo</span><span style="color:#000">-&gt;</span><span style="color:#000">physicalDevLimits</span> <span style="color:#000">=</span> <span style="color:#000">devProps</span>.<span style="color:#000">limits</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">out_queueInfo</span><span style="color:#000">-&gt;</span><span style="color:#000">workQueueIndex</span> <span style="color:#000">=</span> <span style="color:#000">workQueueIndex</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">out_queueInfo</span><span style="color:#000">-&gt;</span><span style="color:#000">presentQueueIndex</span> <span style="color:#000">=</span> <span style="color:#000">presentQueueIndex</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">vkGetPhysicalDeviceMemoryProperties</span>(<span style="color:#000">selectedPhysicalDev</span>, <span style="color:#000">&amp;</span><span style="color:#000">out_deviceInfo</span><span style="color:#000">-&gt;</span><span style="color:#000">physicalDevMemoProps</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>验证设备扩展，判断是否支持交换链。</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">const</span> <span style="color:#000">DriverFeature</span> <span style="color:#000">validation_device_extensions</span>[] <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>        {<span style="color:#000">VK_KHR_SWAPCHAIN_EXTENSION_NAME</span>, <span style="color:#a90d91">false</span>, <span style="color:#a90d91">true</span>}
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">pickPhyDevAndCreateDev</span>(<span style="color:#000">VkInstance</span> <span style="color:#000">instance</span>, <span style="color:#000">VkSurfaceKHR</span> <span style="color:#000">surface</span>, <span style="color:#000">DeviceInfo</span> <span style="color:#000">*</span><span style="color:#000">out_deviceInfo</span>, <span style="color:#000">QueueInfo</span> <span style="color:#000">*</span><span style="color:#000">out_queueInfo</span>) {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">uint32_t</span> <span style="color:#000">availableDeviceExtensionCount</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">CALL_VK</span>(<span style="color:#000">vkEnumerateDeviceExtensionProperties</span>(<span style="color:#000">out_deviceInfo</span><span style="color:#000">-&gt;</span><span style="color:#000">physicalDev</span>, <span style="color:#a90d91">nullptr</span>, <span style="color:#000">&amp;</span><span style="color:#000">availableDeviceExtensionCount</span>, <span style="color:#a90d91">nullptr</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkExtensionProperties</span> <span style="color:#000">availableDeviceExtensions</span>[<span style="color:#000">availableDeviceExtensionCount</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#000">CALL_VK</span>(<span style="color:#000">vkEnumerateDeviceExtensionProperties</span>(<span style="color:#000">out_deviceInfo</span><span style="color:#000">-&gt;</span><span style="color:#000">physicalDev</span>, <span style="color:#a90d91">nullptr</span>, <span style="color:#000">&amp;</span><span style="color:#000">availableDeviceExtensionCount</span>, <span style="color:#000">availableDeviceExtensions</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">const</span> <span style="color:#a90d91">char</span> <span style="color:#000">*</span><span style="color:#000">enableDeviceExtensions</span>[<span style="color:#1c01ce">32</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">uint32_t</span> <span style="color:#000">enableDeviceExtensionCount</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">checkFeatures</span>(<span style="color:#c41a16">&#34;Device Extensions&#34;</span>, <span style="color:#a90d91">true</span>, <span style="color:#a90d91">true</span>, <span style="color:#000">validation_device_extensions</span>, <span style="color:#000">ARRAY_SIZE</span>(<span style="color:#000">validation_device_extensions</span>),
</span></span><span style="display:flex;"><span>                  <span style="color:#000">availableDeviceExtensions</span>, <span style="color:#000">availableDeviceExtensionCount</span>, <span style="color:#000">enableDeviceExtensions</span>, <span style="color:#000">&amp;</span><span style="color:#000">enableDeviceExtensionCount</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>队列信息</strong></p>
<p>我们暂时只创建一个队列，以作最简单的演示。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">pickPhyDevAndCreateDev</span>(<span style="color:#000">VkInstance</span> <span style="color:#000">instance</span>, <span style="color:#000">VkSurfaceKHR</span> <span style="color:#000">surface</span>, <span style="color:#000">DeviceInfo</span> <span style="color:#000">*</span><span style="color:#000">out_deviceInfo</span>, <span style="color:#000">QueueInfo</span> <span style="color:#000">*</span><span style="color:#000">out_queueInfo</span>) {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">float</span> <span style="color:#000">queuePriority</span> <span style="color:#000">=</span> <span style="color:#1c01ce">1.0f</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkDeviceQueueCreateInfo</span> <span style="color:#000">queueCreateInfo</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>            .<span style="color:#000">sType</span> <span style="color:#000">=</span> <span style="color:#000">VK_STRUCTURE_TYPE_DEVICE_QUEUE_CREATE_INFO</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">pNext</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">flags</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">queueFamilyIndex</span> <span style="color:#000">=</span> <span style="color:#000">out_queueInfo</span><span style="color:#000">-&gt;</span><span style="color:#000">workQueueIndex</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">queueCount</span> <span style="color:#000">=</span> <span style="color:#1c01ce">1</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">pQueuePriorities</span> <span style="color:#000">=</span> <span style="color:#000">&amp;</span><span style="color:#000">queuePriority</span>, <span style="color:#177500">//队列优先级
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    };
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>创建逻辑设备</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">pickPhyDevAndCreateDev</span>(<span style="color:#000">VkInstance</span> <span style="color:#000">instance</span>, <span style="color:#000">VkSurfaceKHR</span> <span style="color:#000">surface</span>, <span style="color:#000">DeviceInfo</span> <span style="color:#000">*</span><span style="color:#000">out_deviceInfo</span>, <span style="color:#000">QueueInfo</span> <span style="color:#000">*</span><span style="color:#000">out_queueInfo</span>) {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkDeviceCreateInfo</span> <span style="color:#000">deviceCreateInfo</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>        .<span style="color:#000">sType</span> <span style="color:#000">=</span> <span style="color:#000">VK_STRUCTURE_TYPE_DEVICE_CREATE_INFO</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pNext</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">flags</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">queueCreateInfoCount</span> <span style="color:#000">=</span> <span style="color:#1c01ce">1</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pQueueCreateInfos</span> <span style="color:#000">=</span> <span style="color:#000">&amp;</span><span style="color:#000">queueCreateInfo</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">enabledLayerCount</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">ppEnabledLayerNames</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">enabledExtensionCount</span> <span style="color:#000">=</span> <span style="color:#000">enableDeviceExtensionCount</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">ppEnabledExtensionNames</span> <span style="color:#000">=</span> <span style="color:#000">enableDeviceExtensionCount</span> <span style="color:#000">==</span> <span style="color:#1c01ce">0</span> <span style="color:#000">?</span> <span style="color:#a90d91">nullptr</span> <span style="color:#000">:</span> <span style="color:#000">enableDeviceExtensions</span>
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#000">CALL_VK</span>(<span style="color:#000">vkCreateDevice</span>(<span style="color:#000">out_deviceInfo</span><span style="color:#000">-&gt;</span><span style="color:#000">physicalDev</span>, <span style="color:#000">&amp;</span><span style="color:#000">deviceCreateInfo</span>, <span style="color:#000">VK_ALLOC</span>, <span style="color:#000">&amp;</span><span style="color:#000">out_deviceInfo</span><span style="color:#000">-&gt;</span><span style="color:#000">device</span>));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>获取队列</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#000">vkGetDeviceQueue</span>(<span style="color:#000">out_deviceInfo</span><span style="color:#000">-&gt;</span><span style="color:#000">device</span>, <span style="color:#000">out_queueInfo</span><span style="color:#000">-&gt;</span><span style="color:#000">workQueueIndex</span>, <span style="color:#1c01ce">0</span>, <span style="color:#000">&amp;</span><span style="color:#000">out_queueInfo</span><span style="color:#000">-&gt;</span><span style="color:#000">queue</span>);
</span></span></code></pre></div><p><code>pickPhyDevAndCreateDev()</code>实现完成后，同样是在<code>init()</code>中调用，并在<code>destroy()</code>中销毁。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">init</span>(){
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#000">createWindow</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">pickPhyDevAndCreateDev</span>(<span style="color:#000">vk</span>.<span style="color:#000">instance</span>, <span style="color:#000">vk</span>.<span style="color:#000">surface</span>, <span style="color:#000">&amp;</span><span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>, <span style="color:#000">&amp;</span><span style="color:#000">vk</span>.<span style="color:#000">queueInfo</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">destroy</span>(){
</span></span><span style="display:flex;"><span>	<span style="color:#000">Print</span>(<span style="color:#c41a16">&#34;%s&#34;</span>, <span style="color:#000">__FUNCTION__</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">vkDeviceWaitIdle</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000">vkDestroyDevice</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>, <span style="color:#000">VK_ALLOC</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">vkDestroySurfaceKHR</span>(<span style="color:#000">vk</span>.<span style="color:#000">instance</span>, <span style="color:#000">vk</span>.<span style="color:#000">surface</span>, <span style="color:#000">VK_ALLOC</span>);
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="34-命令池">3.4 命令池</h3>
<p>后续所有命令操作都要从命令池中获取命令并执行，所以我们先创建一个备用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">struct</span> <span style="color:#3f6e75">VkBundle</span> {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>	<span style="color:#000">VkCommandPool</span> <span style="color:#000">cmdPool</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>命令池的创建相对简单，只需要指定队列索引即可创建。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">createCommandPool</span>(<span style="color:#000">VkDevice</span> <span style="color:#000">device</span>, <span style="color:#a90d91">uint32_t</span> <span style="color:#000">workQueueIndex</span>, <span style="color:#000">VkCommandPool</span> <span style="color:#000">*</span><span style="color:#000">out_cmdPool</span>) {
</span></span><span style="display:flex;"><span> 	<span style="color:#000">VkCommandPoolCreateInfo</span> <span style="color:#000">createInfo</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>        .<span style="color:#000">sType</span> <span style="color:#000">=</span> <span style="color:#000">VK_STRUCTURE_TYPE_COMMAND_POOL_CREATE_INFO</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pNext</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">flags</span> <span style="color:#000">=</span> <span style="color:#000">VK_COMMAND_POOL_CREATE_RESET_COMMAND_BUFFER_BIT</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">queueFamilyIndex</span> <span style="color:#000">=</span> <span style="color:#000">workQueueIndex</span>
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#000">CALL_VK</span>(<span style="color:#000">vkCreateCommandPool</span>(<span style="color:#000">device</span>, <span style="color:#000">&amp;</span><span style="color:#000">createInfo</span>, <span style="color:#000">VK_ALLOC</span>, <span style="color:#000">out_cmdPool</span>));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>在<code>init()</code>中使用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">createCommandPool</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>, <span style="color:#000">vk</span>.<span style="color:#000">queueInfo</span>.<span style="color:#000">workQueueIndex</span>, <span style="color:#000">&amp;</span><span style="color:#000">vk</span>.<span style="color:#000">cmdPool</span>);
</span></span></code></pre></div><p>在<code>destroy()</code>中销毁。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">destroy</span>(){
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>	<span style="color:#000">vkDestroyCommandPool</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>, <span style="color:#000">vk</span>.<span style="color:#000">cmdPool</span>, <span style="color:#000">VK_ALLOC</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">vkDestroyDevice</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>, <span style="color:#000">VK_ALLOC</span>);
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="35-交换链">3.5 交换链</h3>
<p>创建交换链的步骤：</p>
<ol>
<li>查询表面参数；
<ul>
<li>功能；</li>
<li>格式；</li>
<li>呈现模式。</li>
</ul>
</li>
<li>创建交换链。</li>
</ol>
<p>我们创建一个保存表面参数的结构体，名为<code>SwapchainParam</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">struct</span> <span style="color:#3f6e75">SwapchainParam</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkSurfaceCapabilitiesKHR</span> <span style="color:#000">capabilities</span>;	<span style="color:#177500">//功能
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#000">VkSurfaceFormatKHR</span> <span style="color:#000">format</span>;				<span style="color:#177500">//格式
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#000">VkPresentModeKHR</span> <span style="color:#000">presentMode</span>;			<span style="color:#177500">//呈现模式
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#000">VkExtent2D</span> <span style="color:#000">extent</span>;						<span style="color:#177500">//范围
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>};
</span></span></code></pre></div><p>接下来创建一个<code>createSwapchain()</code>函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">createSwapchain</span>(<span style="color:#000">VkPhysicalDevice</span> <span style="color:#000">physicalDev</span>, <span style="color:#000">VkDevice</span> <span style="color:#000">device</span>, <span style="color:#000">VkSurfaceKHR</span> <span style="color:#000">surface</span>,
</span></span><span style="display:flex;"><span>                               <span style="color:#a90d91">uint16_t</span> <span style="color:#000">workQueueIndex</span>, <span style="color:#a90d91">uint16_t</span> <span style="color:#000">presentQueueIndex</span>,
</span></span><span style="display:flex;"><span>                               <span style="color:#000">SwapchainParam</span> <span style="color:#000">*</span><span style="color:#000">out_swapchainParam</span>, <span style="color:#000">VkSwapchainKHR</span> <span style="color:#000">*</span><span style="color:#000">out_swapchain</span>){}
</span></span></code></pre></div><p>在函数中实现上述两个步骤，首先查询表面参数，目前就是拿到合适的格式、呈现模式、视口范围三个信息。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">querySwapchainParam</span>(<span style="color:#000">VkPhysicalDevice</span> <span style="color:#000">physicalDev</span>, <span style="color:#000">VkSurfaceKHR</span> <span style="color:#000">surface</span>, <span style="color:#000">SwapchainParam</span> <span style="color:#000">*</span><span style="color:#000">out_swapchainParam</span>){
</span></span><span style="display:flex;"><span>	<span style="color:#177500">//capabilities
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#000">CALL_VK</span>(<span style="color:#000">vkGetPhysicalDeviceSurfaceCapabilitiesKHR</span>(<span style="color:#000">physicalDev</span>, <span style="color:#000">surface</span>, <span style="color:#000">&amp;</span><span style="color:#000">out_swapchainParam</span><span style="color:#000">-&gt;</span><span style="color:#000">capabilities</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#000">out_swapchainParam</span><span style="color:#000">-&gt;</span><span style="color:#000">extent</span> <span style="color:#000">=</span> <span style="color:#000">out_swapchainParam</span><span style="color:#000">-&gt;</span><span style="color:#000">capabilities</span>.<span style="color:#000">currentExtent</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">Print</span>(<span style="color:#c41a16">&#34;Extent: %d, %d&#34;</span>, <span style="color:#000">out_swapchainParam</span><span style="color:#000">-&gt;</span><span style="color:#000">extent</span>.<span style="color:#000">width</span>, <span style="color:#000">out_swapchainParam</span><span style="color:#000">-&gt;</span><span style="color:#000">extent</span>.<span style="color:#000">height</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#177500">//format
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#a90d91">uint32_t</span> <span style="color:#000">formatCount</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">vkGetPhysicalDeviceSurfaceFormatsKHR</span>(<span style="color:#000">physicalDev</span>, <span style="color:#000">surface</span>, <span style="color:#000">&amp;</span><span style="color:#000">formatCount</span>, <span style="color:#a90d91">nullptr</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkSurfaceFormatKHR</span> <span style="color:#000">formats</span>[<span style="color:#000">formatCount</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#000">vkGetPhysicalDeviceSurfaceFormatsKHR</span>(<span style="color:#000">physicalDev</span>, <span style="color:#000">surface</span>, <span style="color:#000">&amp;</span><span style="color:#000">formatCount</span>, <span style="color:#000">formats</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">bool</span> <span style="color:#000">bFindFormat</span> <span style="color:#000">=</span> <span style="color:#a90d91">false</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">if</span>(<span style="color:#000">formatCount</span> <span style="color:#000">==</span> <span style="color:#1c01ce">1</span> <span style="color:#000">&amp;&amp;</span> <span style="color:#000">formats</span>[<span style="color:#1c01ce">0</span>].<span style="color:#000">format</span> <span style="color:#000">==</span> <span style="color:#000">VK_FORMAT_UNDEFINED</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#000">out_swapchainParam</span><span style="color:#000">-&gt;</span><span style="color:#000">format</span> <span style="color:#000">=</span> {<span style="color:#000">VK_FORMAT_B8G8R8A8_UNORM</span>,   <span style="color:#000">VK_COLORSPACE_SRGB_NONLINEAR_KHR</span>};
</span></span><span style="display:flex;"><span>        <span style="color:#000">bFindFormat</span> <span style="color:#000">=</span> <span style="color:#a90d91">true</span>;
</span></span><span style="display:flex;"><span>    }  <span style="color:#a90d91">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a90d91">for</span> (<span style="color:#a90d91">const</span> <span style="color:#a90d91">auto</span> <span style="color:#000">&amp;</span><span style="color:#000">item</span>: <span style="color:#000">formats</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#a90d91">if</span>(<span style="color:#000">item</span>.<span style="color:#000">format</span> <span style="color:#000">==</span> <span style="color:#000">VK_FORMAT_B8G8R8A8_UNORM</span> <span style="color:#000">&amp;&amp;</span> <span style="color:#000">item</span>.<span style="color:#000">colorSpace</span> <span style="color:#000">==</span> <span style="color:#000">VK_COLORSPACE_SRGB_NONLINEAR_KHR</span>){
</span></span><span style="display:flex;"><span>                <span style="color:#000">out_swapchainParam</span><span style="color:#000">-&gt;</span><span style="color:#000">format</span> <span style="color:#000">=</span> <span style="color:#000">item</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#000">bFindFormat</span> <span style="color:#000">=</span> <span style="color:#a90d91">true</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#a90d91">break</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">if</span>(<span style="color:#000">!</span><span style="color:#000">bFindFormat</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#000">out_swapchainParam</span><span style="color:#000">-&gt;</span><span style="color:#000">format</span> <span style="color:#000">=</span> <span style="color:#000">formats</span>[<span style="color:#1c01ce">0</span>];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#177500">//present mode
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#a90d91">uint32_t</span> <span style="color:#000">presentModeCount</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">vkGetPhysicalDeviceSurfacePresentModesKHR</span>(<span style="color:#000">physicalDev</span>, <span style="color:#000">surface</span>, <span style="color:#000">&amp;</span><span style="color:#000">presentModeCount</span>, <span style="color:#a90d91">nullptr</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkPresentModeKHR</span> <span style="color:#000">presentModes</span>[<span style="color:#000">presentModeCount</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#000">vkGetPhysicalDeviceSurfacePresentModesKHR</span>(<span style="color:#000">physicalDev</span>, <span style="color:#000">surface</span>, <span style="color:#000">&amp;</span><span style="color:#000">presentModeCount</span>, <span style="color:#000">presentModes</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#177500">//VK_PRESENT_MODE_IMMEDIATE_KHR 立即提交，可能导致画面撕裂
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#177500">//VK_PRESENT_MODE_FIFO_KHR 先进先出的队列，队列满时需要等待，类似垂直同步
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#177500">//VK_PRESENT_MODE_FIFO_RELAXED_KHR 和上一模式的区别是：如果应用程序延迟，导致交换链的队列在上一次垂直回扫时为空， 那么，如果应用程序在下一次垂直回扫前提交图像，图像会立即被显示。这一模式可能会导致撕裂现象。
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#177500">//VK_PRESENT_MODE_MAILBOX_KHR 这一模式是第二种模式的另一个变种。它不会在交换链的队列满时阻塞应用程序，队列中的图像会被直接替换为应用程序新提交的图像。这一模式可以用来实现三倍缓冲，避免撕裂现象的同时减小了延迟问题
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#a90d91">bool</span> <span style="color:#000">bFoundPrentMode</span> <span style="color:#000">=</span> <span style="color:#a90d91">false</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">for</span> (<span style="color:#a90d91">const</span> <span style="color:#a90d91">auto</span> <span style="color:#000">&amp;</span><span style="color:#000">item</span>: <span style="color:#000">presentModes</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a90d91">if</span>(<span style="color:#000">VK_PRESENT_MODE_MAILBOX_KHR</span> <span style="color:#000">==</span> <span style="color:#000">item</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#000">out_swapchainParam</span><span style="color:#000">-&gt;</span><span style="color:#000">presentMode</span> <span style="color:#000">=</span> <span style="color:#000">item</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#000">bFoundPrentMode</span> <span style="color:#000">=</span> <span style="color:#a90d91">true</span>;
</span></span><span style="display:flex;"><span>        } <span style="color:#a90d91">else</span> <span style="color:#a90d91">if</span>(<span style="color:#000">VK_PRESENT_MODE_IMMEDIATE_KHR</span> <span style="color:#000">==</span> <span style="color:#000">item</span>){ <span style="color:#177500">//目前大部分硬件不不支持VK_PRESENT_MODE_MAILBOX_KHR
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>            <span style="color:#000">out_swapchainParam</span><span style="color:#000">-&gt;</span><span style="color:#000">presentMode</span> <span style="color:#000">=</span> <span style="color:#000">item</span>;
</span></span><span style="display:flex;"><span>            <span style="color:#000">bFoundPrentMode</span> <span style="color:#000">=</span> <span style="color:#a90d91">true</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">if</span>(<span style="color:#000">!</span><span style="color:#000">bFoundPrentMode</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#000">out_swapchainParam</span><span style="color:#000">-&gt;</span><span style="color:#000">presentMode</span> <span style="color:#000">=</span> <span style="color:#000">VK_PRESENT_MODE_MAILBOX_KHR</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">createSwapchain</span>(<span style="color:#000">VkPhysicalDevice</span> <span style="color:#000">physicalDev</span>, <span style="color:#000">VkDevice</span> <span style="color:#000">device</span>, <span style="color:#000">VkSurfaceKHR</span> <span style="color:#000">surface</span>,
</span></span><span style="display:flex;"><span>                               <span style="color:#a90d91">uint16_t</span> <span style="color:#000">workQueueIndex</span>, <span style="color:#a90d91">uint16_t</span> <span style="color:#000">presentQueueIndex</span>,
</span></span><span style="display:flex;"><span>                               <span style="color:#000">SwapchainParam</span> <span style="color:#000">*</span><span style="color:#000">out_swapchainParam</span>, <span style="color:#000">VkSwapchainKHR</span> <span style="color:#000">*</span><span style="color:#000">out_swapchain</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#000">querySwapchainParam</span>(<span style="color:#000">physicalDev</span>, <span style="color:#000">surface</span>, <span style="color:#000">out_swapchainParam</span>);
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>然后就是执行<code>vkCreateSwapchain()</code>，和其他对象类似地创建swapchain。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">createSwapchain</span>(<span style="color:#000">VkPhysicalDevice</span> <span style="color:#000">physicalDev</span>, <span style="color:#000">VkDevice</span> <span style="color:#000">device</span>, <span style="color:#000">VkSurfaceKHR</span> <span style="color:#000">surface</span>,
</span></span><span style="display:flex;"><span>                               <span style="color:#a90d91">uint16_t</span> <span style="color:#000">workQueueIndex</span>, <span style="color:#a90d91">uint16_t</span> <span style="color:#000">presentQueueIndex</span>,
</span></span><span style="display:flex;"><span>                               <span style="color:#000">SwapchainParam</span> <span style="color:#000">*</span><span style="color:#000">out_swapchainParam</span>, <span style="color:#000">VkSwapchainKHR</span> <span style="color:#000">*</span><span style="color:#000">out_swapchain</span>){
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">querySwapchainParam</span>(<span style="color:#000">physicalDev</span>, <span style="color:#000">surface</span>, <span style="color:#000">out_swapchainParam</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkSwapchainCreateInfoKHR</span> <span style="color:#000">swapchainCreateInfo</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#177500">//TODO
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    }; 
</span></span><span style="display:flex;"><span>    <span style="color:#000">CALL_VK</span>(<span style="color:#000">vkCreateSwapchainKHR</span>(<span style="color:#000">device</span>, <span style="color:#000">&amp;</span><span style="color:#000">swapchainCreateInfo</span>, <span style="color:#000">VK_ALLOC</span>, <span style="color:#000">out_swapchain</span>));
</span></span></code></pre></div><p>现在的核心就是构造<code>swapchainCreateInfo</code>对象。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">uint32_t</span> <span style="color:#000">queueFamilysArr</span>[<span style="color:#1c01ce">2</span>] <span style="color:#000">=</span> {<span style="color:#a90d91">static_cast</span><span style="color:#000">&lt;</span><span style="color:#a90d91">uint32_t</span><span style="color:#000">&gt;</span>(<span style="color:#000">workQueueIndex</span>), <span style="color:#a90d91">static_cast</span><span style="color:#000">&lt;</span><span style="color:#a90d91">uint32_t</span><span style="color:#000">&gt;</span>(<span style="color:#000">presentQueueIndex</span>)};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">VkSwapchainKHR</span> <span style="color:#000">oldSwapchain</span>;
</span></span><span style="display:flex;"><span><span style="color:#a90d91">if</span>(<span style="color:#a90d91">nullptr</span> <span style="color:#000">!=</span> <span style="color:#000">out_swapchain</span> <span style="color:#000">&amp;&amp;</span> <span style="color:#000">VK_NULL_HANDLE</span> <span style="color:#000">!=</span> <span style="color:#000">*</span><span style="color:#000">out_swapchain</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#000">oldSwapchain</span> <span style="color:#000">=</span> <span style="color:#000">*</span><span style="color:#000">out_swapchain</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">VkSwapchainCreateInfoKHR</span> <span style="color:#000">swapchainCreateInfo</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>            .<span style="color:#000">sType</span> <span style="color:#000">=</span> <span style="color:#000">VK_STRUCTURE_TYPE_SWAPCHAIN_CREATE_INFO_KHR</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">pNext</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">flags</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>    		<span style="color:#177500">//上文创建的窗口表面
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>            .<span style="color:#000">surface</span> <span style="color:#000">=</span> <span style="color:#000">surface</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">minImageCount</span> <span style="color:#000">=</span> <span style="color:#000">out_swapchainParam</span><span style="color:#000">-&gt;</span><span style="color:#000">capabilities</span>.<span style="color:#000">minImageCount</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">imageFormat</span> <span style="color:#000">=</span> <span style="color:#000">out_swapchainParam</span><span style="color:#000">-&gt;</span><span style="color:#000">format</span>.<span style="color:#000">format</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">imageColorSpace</span> <span style="color:#000">=</span> <span style="color:#000">out_swapchainParam</span><span style="color:#000">-&gt;</span><span style="color:#000">format</span>.<span style="color:#000">colorSpace</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">imageExtent</span> <span style="color:#000">=</span> <span style="color:#000">out_swapchainParam</span><span style="color:#000">-&gt;</span><span style="color:#000">extent</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">imageArrayLayers</span> <span style="color:#000">=</span> <span style="color:#1c01ce">1</span>,
</span></span><span style="display:flex;"><span>    		<span style="color:#177500">//用为颜色附件
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>            .<span style="color:#000">imageUsage</span> <span style="color:#000">=</span> <span style="color:#000">VK_IMAGE_USAGE_COLOR_ATTACHMENT_BIT</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">imageSharingMode</span> <span style="color:#000">=</span> <span style="color:#000">workQueueIndex</span> <span style="color:#000">==</span> <span style="color:#000">presentQueueIndex</span> <span style="color:#000">?</span> <span style="color:#000">VK_SHARING_MODE_EXCLUSIVE</span> : <span style="color:#000">VK_SHARING_MODE_CONCURRENT</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">queueFamilyIndexCount</span> <span style="color:#000">=</span> <span style="color:#a90d91">static_cast</span><span style="color:#000">&lt;</span><span style="color:#a90d91">uint32_t</span><span style="color:#000">&gt;</span>(<span style="color:#000">workQueueIndex</span> <span style="color:#000">==</span> <span style="color:#000">presentQueueIndex</span> <span style="color:#000">?</span> <span style="color:#1c01ce">1</span> <span style="color:#000">:</span> <span style="color:#1c01ce">2</span>),
</span></span><span style="display:flex;"><span>            .<span style="color:#000">pQueueFamilyIndices</span> <span style="color:#000">=</span> <span style="color:#000">workQueueIndex</span> <span style="color:#000">==</span> <span style="color:#000">presentQueueIndex</span> <span style="color:#000">?</span> <span style="color:#a90d91">nullptr</span> <span style="color:#000">:</span> <span style="color:#000">queueFamilysArr</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">preTransform</span> <span style="color:#000">=</span> <span style="color:#000">out_swapchainParam</span><span style="color:#000">-&gt;</span><span style="color:#000">capabilities</span>.<span style="color:#000">currentTransform</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">compositeAlpha</span> <span style="color:#000">=</span> <span style="color:#000">VK_COMPOSITE_ALPHA_OPAQUE_BIT_KHR</span>, <span style="color:#177500">//忽略掉alpha通道
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>            .<span style="color:#000">presentMode</span> <span style="color:#000">=</span> <span style="color:#000">out_swapchainParam</span><span style="color:#000">-&gt;</span><span style="color:#000">presentMode</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">clipped</span> <span style="color:#000">=</span> <span style="color:#000">VK_TRUE</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">oldSwapchain</span> <span style="color:#000">=</span> <span style="color:#000">oldSwapchain</span>
</span></span><span style="display:flex;"><span>    };
</span></span></code></pre></div><p>最后，我们再<code>VkBundle</code>中增加<code>swapchain</code>、<code>swapchainParam</code>成员变量，然后在<code>init()</code>中调用创建函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">struct</span> <span style="color:#3f6e75">VkBundle</span> {
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkCommandPool</span> <span style="color:#000">cmdPool</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">SwapchainParam</span> <span style="color:#000">swapchainParam</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkSwapchainKHR</span> <span style="color:#000">swapchain</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">init</span>(){
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">createSwapchain</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">physicalDev</span>, <span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>, <span style="color:#000">vk</span>.<span style="color:#000">surface</span>, 				<span style="color:#000">vk</span>.<span style="color:#000">queueInfo</span>.<span style="color:#000">workQueueIndex</span>, <span style="color:#000">vk</span>.<span style="color:#000">queueInfo</span>.<span style="color:#000">presentQueueIndex</span>,
</span></span><span style="display:flex;"><span>                                  <span style="color:#000">&amp;</span><span style="color:#000">vk</span>.<span style="color:#000">swapchainParam</span>,<span style="color:#000">&amp;</span><span style="color:#000">vk</span>.<span style="color:#000">swapchain</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>当然别忘了程序结束前销毁。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">destroy</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#000">Print</span>(<span style="color:#c41a16">&#34;%s&#34;</span>, <span style="color:#000">__FUNCTION__</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">vkDeviceWaitIdle</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vkDestroySwapchainKHR</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>, <span style="color:#000">vk</span>.<span style="color:#000">swapchain</span>, <span style="color:#000">VK_ALLOC</span>);
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>正常情况下，我们的交换链这样就创建完毕了。但我们在使用时候需要若干个Image来处理应用程序提交和呈现，因此需要根据Swapchain内Image的数量来创建Image View。</p>
<p>首先添加一个结构体，记录一个Swapchain下面的所有图片信息。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">struct</span> <span style="color:#3f6e75">SwapchainImage</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">uint32_t</span> <span style="color:#000">imageCount</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkImage</span> <span style="color:#000">*</span><span style="color:#000">images</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkImageView</span> <span style="color:#000">*</span><span style="color:#000">views</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a90d91">struct</span> <span style="color:#3f6e75">VkBundle</span> {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#000">SwapchainImage</span> <span style="color:#000">swapchainImage</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>怎么获取交换链内的Image呢？我们可以直接使用<code>vkGetSwapchainImagesKHR()</code>来完成。以下内容直接在<code>init()</code>中完成。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#000">CALL_VK</span>(<span style="color:#000">vkGetSwapchainImagesKHR</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>, <span style="color:#000">vk</span>.<span style="color:#000">swapchain</span>, <span style="color:#000">&amp;</span><span style="color:#000">vk</span>.<span style="color:#000">swapchainImage</span>.<span style="color:#000">imageCount</span>, <span style="color:#a90d91">nullptr</span>));
</span></span><span style="display:flex;"><span><span style="color:#000">vk</span>.<span style="color:#000">swapchainImage</span>.<span style="color:#000">images</span> <span style="color:#000">=</span> <span style="color:#a90d91">static_cast</span><span style="color:#000">&lt;</span><span style="color:#000">VkImage</span> <span style="color:#000">*&gt;</span>(<span style="color:#000">malloc</span>(<span style="color:#a90d91">sizeof</span>(<span style="color:#000">VkImage</span>) <span style="color:#000">*</span> <span style="color:#000">vk</span>.<span style="color:#000">swapchainImage</span>.<span style="color:#000">imageCount</span>));
</span></span><span style="display:flex;"><span><span style="color:#000">CALL_VK</span>(<span style="color:#000">vkGetSwapchainImagesKHR</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>, <span style="color:#000">vk</span>.<span style="color:#000">swapchain</span>, <span style="color:#000">&amp;</span><span style="color:#000">vk</span>.<span style="color:#000">swapchainImage</span>.<span style="color:#000">imageCount</span>, <span style="color:#000">vk</span>.<span style="color:#000">swapchainImage</span>.<span style="color:#000">images</span>));
</span></span></code></pre></div><p>然后创建对应数量的ImageView。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#000">vk</span>.<span style="color:#000">swapchainImage</span>.<span style="color:#000">views</span> <span style="color:#000">=</span> <span style="color:#a90d91">static_cast</span><span style="color:#000">&lt;</span><span style="color:#000">VkImageView</span> <span style="color:#000">*&gt;</span>(<span style="color:#000">malloc</span>(<span style="color:#a90d91">sizeof</span>(<span style="color:#000">VkImageView</span>) <span style="color:#000">*</span> <span style="color:#000">vk</span>.<span style="color:#000">swapchainImage</span>.<span style="color:#000">imageCount</span>));
</span></span><span style="display:flex;"><span><span style="color:#a90d91">for</span>(<span style="color:#a90d91">uint32_t</span> <span style="color:#000">i</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>; <span style="color:#000">i</span> <span style="color:#000">&lt;</span> <span style="color:#000">vk</span>.<span style="color:#000">swapchainImage</span>.<span style="color:#000">imageCount</span>; <span style="color:#000">i</span><span style="color:#000">++</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkImageViewCreateInfo</span> <span style="color:#000">createInfo</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>        .<span style="color:#000">sType</span> <span style="color:#000">=</span> <span style="color:#000">VK_STRUCTURE_TYPE_IMAGE_VIEW_CREATE_INFO</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pNext</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">flags</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">image</span> <span style="color:#000">=</span> <span style="color:#000">vk</span>.<span style="color:#000">swapchainImage</span>.<span style="color:#000">images</span>[<span style="color:#000">i</span>],
</span></span><span style="display:flex;"><span>        .<span style="color:#000">viewType</span> <span style="color:#000">=</span> <span style="color:#000">VK_IMAGE_VIEW_TYPE_2D</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">format</span> <span style="color:#000">=</span> <span style="color:#000">vk</span>.<span style="color:#000">swapchainParam</span>.<span style="color:#000">format</span>.<span style="color:#000">format</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">components</span> <span style="color:#000">=</span> {<span style="color:#000">VK_COMPONENT_SWIZZLE_IDENTITY</span>},
</span></span><span style="display:flex;"><span>        .<span style="color:#000">subresourceRange</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>                .<span style="color:#000">aspectMask</span> <span style="color:#000">=</span> <span style="color:#000">VK_IMAGE_ASPECT_COLOR_BIT</span>,
</span></span><span style="display:flex;"><span>                .<span style="color:#000">baseMipLevel</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>                .<span style="color:#000">levelCount</span> <span style="color:#000">=</span> <span style="color:#1c01ce">1</span>,
</span></span><span style="display:flex;"><span>                .<span style="color:#000">baseArrayLayer</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>                .<span style="color:#000">layerCount</span> <span style="color:#000">=</span> <span style="color:#1c01ce">1</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#000">CALL_VK</span>(<span style="color:#000">vkCreateImageView</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>, <span style="color:#000">&amp;</span><span style="color:#000">createInfo</span>, <span style="color:#000">VK_ALLOC</span>, <span style="color:#000">&amp;</span><span style="color:#000">vk</span>.<span style="color:#000">swapchainImage</span>.<span style="color:#000">views</span>[<span style="color:#000">i</span>]));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>销毁。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">destroy</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#000">Print</span>(<span style="color:#c41a16">&#34;%s&#34;</span>, <span style="color:#000">__FUNCTION__</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">vkDeviceWaitIdle</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>);   
</span></span><span style="display:flex;"><span>	<span style="color:#a90d91">for</span>(<span style="color:#a90d91">uint32_t</span> <span style="color:#000">i</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>; <span style="color:#000">i</span> <span style="color:#000">&lt;</span> <span style="color:#000">vk</span>.<span style="color:#000">swapchainImage</span>.<span style="color:#000">imageCount</span>; <span style="color:#000">i</span><span style="color:#000">++</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#000">vkDestroyImageView</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>, <span style="color:#000">vk</span>.<span style="color:#000">swapchainImage</span>.<span style="color:#000">views</span>[<span style="color:#000">i</span>], <span style="color:#000">VK_ALLOC</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#000">free</span>(<span style="color:#000">vk</span>.<span style="color:#000">swapchainImage</span>.<span style="color:#000">views</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">free</span>(<span style="color:#000">vk</span>.<span style="color:#000">swapchainImage</span>.<span style="color:#000">images</span>);
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="36-创建渲染流程">3.6 创建渲染流程</h3>
<p>还是同样的操作，我们在<code>VkBundle</code>中添加一个<code>renderPass</code>成员变量，供后续使用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">struct</span> <span style="color:#3f6e75">VkBundle</span> {
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#000">SwapchainImage</span> <span style="color:#000">swapchainImage</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#000">VkRenderPass</span> <span style="color:#000">renderPass</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>然后创建一个<code>createRenderPass()</code>函数，完成对<code>RenderPass</code>的创建。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">createRenderPass</span>(<span style="color:#000">VkDevice</span> <span style="color:#000">device</span>, <span style="color:#000">SwapchainParam</span> <span style="color:#000">swapchainParam</span>, <span style="color:#000">VkRenderPass</span> <span style="color:#000">*</span><span style="color:#000">out_renderPass</span>) {
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>    <span style="color:#177500">//TODO 我们不管createInfo有多复杂，先把框架写出来，接下来再完善。
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#000">VkRenderPassCreateInfo</span> <span style="color:#000">createInfo</span> <span style="color:#000">=</span> {};
</span></span><span style="display:flex;"><span>    <span style="color:#000">CALL_VK</span>(<span style="color:#000">vkCreateRenderPass</span>(<span style="color:#000">device</span>, <span style="color:#000">&amp;</span><span style="color:#000">createInfo</span>, <span style="color:#000">VK_ALLOC</span>, <span style="color:#000">out_renderPass</span>));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>在<code>VkRenderPassCreateInfo</code>中，拥有以下三种对象的集合。</p>
<ul>
<li>attachments 附件，可以颜色、深度、模板等等。</li>
<li>subpass 子流程，渲染流程只会在子流程种执行，所以子流程数量需要&gt;=1。</li>
<li>dependency 依赖，标识子流程中的关系。</li>
</ul>
<p>我们首先处理附件，在案例中我们只需要画一个三角形，所以使用一个颜色附件即可。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#000">VkAttachmentDescription</span> <span style="color:#000">attachDesc</span>[] <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        .<span style="color:#000">flags</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">format</span> <span style="color:#000">=</span> <span style="color:#000">swapchainParam</span>.<span style="color:#000">format</span>.<span style="color:#000">format</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">samples</span> <span style="color:#000">=</span> <span style="color:#000">VK_SAMPLE_COUNT_1_BIT</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#177500">//VK_ATTACHMENT_LOAD_OP_LOAD：保持附着的现有内容
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>        <span style="color:#177500">//VK_ATTACHMENT_LOAD_OP_CLEAR：使用一个常量值来清除附着的内容
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>        <span style="color:#177500">//VK_ATTACHMENT_LOAD_OP_DONT_CARE：不关心附着现存的内容
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>        .<span style="color:#000">loadOp</span> <span style="color:#000">=</span> <span style="color:#000">VK_ATTACHMENT_LOAD_OP_CLEAR</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">storeOp</span> <span style="color:#000">=</span> <span style="color:#000">VK_ATTACHMENT_STORE_OP_STORE</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#177500">//K_ATTACHMENT_STORE_OP_STORE：渲染的内容会被存储起来，以便之后读取
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>        <span style="color:#177500">//VK_ATTACHMENT_STORE_OP_DONT_CARE：渲染后，不会读取帧缓冲的内容
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>        .<span style="color:#000">stencilLoadOp</span> <span style="color:#000">=</span> <span style="color:#000">VK_ATTACHMENT_LOAD_OP_DONT_CARE</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">stencilStoreOp</span> <span style="color:#000">=</span> <span style="color:#000">VK_ATTACHMENT_STORE_OP_DONT_CARE</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">initialLayout</span> <span style="color:#000">=</span> <span style="color:#000">VK_IMAGE_LAYOUT_UNDEFINED</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">finalLayout</span> <span style="color:#000">=</span> <span style="color:#000">VK_IMAGE_LAYOUT_PRESENT_SRC_KHR</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>因为我们只需要第一个附件，所以附件引用为0，类型为颜色附件。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#000">VkAttachmentReference</span> <span style="color:#000">colorAttachRef</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>        .<span style="color:#000">attachment</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,										<span style="color:#177500">// 0表示上文attachDesc[]数组的第1位
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>        .<span style="color:#000">layout</span> <span style="color:#000">=</span> <span style="color:#000">VK_IMAGE_LAYOUT_COLOR_ATTACHMENT_OPTIMAL</span>,		<span style="color:#177500">// 作为颜色附件使用
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>};
</span></span></code></pre></div><p>接着我们处理子流程，同样也只需要一个颜色附件即可。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#000">VkSubpassDescription</span> <span style="color:#000">subpass</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>        .<span style="color:#000">flags</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pipelineBindPoint</span> <span style="color:#000">=</span> <span style="color:#000">VK_PIPELINE_BIND_POINT_GRAPHICS</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">inputAttachmentCount</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pInputAttachments</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">colorAttachmentCount</span> <span style="color:#000">=</span> <span style="color:#1c01ce">1</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pColorAttachments</span> <span style="color:#000">=</span> <span style="color:#000">&amp;</span><span style="color:#000">colorAttachRef</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">preserveAttachmentCount</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pPreserveAttachments</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>对于dependency，我们可以理解为各个附件的输入输出关系。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#000">VkSubpassDependency</span> <span style="color:#000">dependency</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>        .<span style="color:#000">srcSubpass</span> <span style="color:#000">=</span> <span style="color:#000">VK_SUBPASS_EXTERNAL</span>,								<span style="color:#177500">// 外部流程作为输入
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>        .<span style="color:#000">dstSubpass</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">srcStageMask</span> <span style="color:#000">=</span> <span style="color:#000">VK_PIPELINE_STAGE_COLOR_ATTACHMENT_OUTPUT_BIT</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">dstStageMask</span> <span style="color:#000">=</span> <span style="color:#000">VK_PIPELINE_STAGE_COLOR_ATTACHMENT_OUTPUT_BIT</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">srcAccessMask</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">dstAccessMask</span> <span style="color:#000">=</span> <span style="color:#000">VK_ACCESS_COLOR_ATTACHMENT_READ_BIT</span> <span style="color:#000">|</span> <span style="color:#000">VK_ACCESS_COLOR_ATTACHMENT_WRITE_BIT</span>,<span style="color:#177500">// 颜色附件作为输出
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>        .<span style="color:#000">dependencyFlags</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>到此为止，我们<code>VkRenderPassCreateInfo</code>的值就全部都赋值了。如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">createRenderPass</span>(<span style="color:#000">VkDevice</span> <span style="color:#000">device</span>, <span style="color:#000">SwapchainParam</span> <span style="color:#000">swapchainParam</span>, <span style="color:#000">VkRenderPass</span> <span style="color:#000">*</span><span style="color:#000">out_renderPass</span>) {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkRenderPassCreateInfo</span> <span style="color:#000">createInfo</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>        .<span style="color:#000">sType</span> <span style="color:#000">=</span> <span style="color:#000">VK_STRUCTURE_TYPE_RENDER_PASS_CREATE_INFO</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pNext</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">flags</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">attachmentCount</span> <span style="color:#000">=</span> <span style="color:#000">ARRAY_SIZE</span>(<span style="color:#000">attachDesc</span>),
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pAttachments</span> <span style="color:#000">=</span> <span style="color:#000">attachDesc</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">subpassCount</span> <span style="color:#000">=</span> <span style="color:#1c01ce">1</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pSubpasses</span> <span style="color:#000">=</span> <span style="color:#000">&amp;</span><span style="color:#000">subpass</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">dependencyCount</span> <span style="color:#000">=</span> <span style="color:#1c01ce">1</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pDependencies</span> <span style="color:#000">=</span> <span style="color:#000">&amp;</span><span style="color:#000">dependency</span>
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#000">CALL_VK</span>(<span style="color:#000">vkCreateRenderPass</span>(<span style="color:#000">device</span>, <span style="color:#000">&amp;</span><span style="color:#000">createInfo</span>, <span style="color:#000">VK_ALLOC</span>, <span style="color:#000">out_renderPass</span>));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>使用，在<code>init()</code>中添加调用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">init</span>(){
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">createRenderPass</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>, <span style="color:#000">vk</span>.<span style="color:#000">swapchainParam</span>, <span style="color:#000">&amp;</span><span style="color:#000">vk</span>.<span style="color:#000">renderPass</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>回收。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">destroy</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#000">Print</span>(<span style="color:#c41a16">&#34;%s&#34;</span>, <span style="color:#000">__FUNCTION__</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">vkDeviceWaitIdle</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vkDestroyRenderPass</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>, <span style="color:#000">vk</span>.<span style="color:#000">renderPass</span>, <span style="color:#000">VK_ALLOC</span>);
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="37-帧缓冲">3.7 帧缓冲</h3>
<p>在Vulkan中需要创建若干个帧缓冲，可以理解为后续场景将渲染到帧缓冲中的某些图像视图（ImageView）上。</p>
<blockquote>
<p>在OpenGL也有对应概念，可以参考<a href="https://learnopengl-cn.github.io/04%20Advanced%20OpenGL/05%20Framebuffers/">Learn-OpenGL帧缓冲</a>。</p>
</blockquote>
<p>在本案例中，我直接使用交换链中图片数作为帧缓冲的数量，也就是交换链中每个图像使用单独的帧缓冲。我们首先在<code>VkBundle</code>中维护帧缓冲相关信息。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">struct</span> <span style="color:#3f6e75">VkBundle</span> {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>	<span style="color:#a90d91">uint32_t</span> <span style="color:#000">framebufferCount</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkFramebuffer</span> <span style="color:#000">*</span><span style="color:#000">framebuffers</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>帧缓冲数组初始化，创建帧缓冲的具体实现我们先放在后面处理。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">init</span>(){
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#000">vk</span>.<span style="color:#000">framebufferCount</span> <span style="color:#000">=</span> <span style="color:#000">vk</span>.<span style="color:#000">swapchainImage</span>.<span style="color:#000">imageCount</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">vk</span>.<span style="color:#000">framebuffers</span> <span style="color:#000">=</span> <span style="color:#a90d91">static_cast</span><span style="color:#000">&lt;</span><span style="color:#000">VkFramebuffer</span> <span style="color:#000">*&gt;</span>(<span style="color:#000">malloc</span>(<span style="color:#a90d91">sizeof</span>(<span style="color:#000">VkFramebuffer</span>) <span style="color:#000">*</span> <span style="color:#000">vk</span>.<span style="color:#000">framebufferCount</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#177500">//TODO 创建帧缓冲
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">createFramebuffer</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>, <span style="color:#000">vk</span>.<span style="color:#000">renderPass</span>, <span style="color:#000">vk</span>.<span style="color:#000">swapchainParam</span>.<span style="color:#000">extent</span>.<span style="color:#000">width</span>, 										<span style="color:#000">vk</span>.<span style="color:#000">swapchainParam</span>.<span style="color:#000">extent</span>.<span style="color:#000">height</span>,
</span></span><span style="display:flex;"><span>                                <span style="color:#000">vk</span>.<span style="color:#000">framebufferCount</span>, <span style="color:#000">vk</span>.<span style="color:#000">swapchainImage</span>.<span style="color:#000">views</span>, <span style="color:#000">vk</span>.<span style="color:#000">framebuffers</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>然后在<code>destroy()</code>时销毁帧缓冲数据。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">destroy</span>(){
</span></span><span style="display:flex;"><span>	<span style="color:#000">Print</span>(<span style="color:#c41a16">&#34;%s&#34;</span>, <span style="color:#000">__FUNCTION__</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">vkDeviceWaitIdle</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">for</span> (<span style="color:#000">size_t</span> <span style="color:#000">i</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>; <span style="color:#000">i</span> <span style="color:#000">&lt;</span> <span style="color:#000">vk</span>.<span style="color:#000">framebufferCount</span>; <span style="color:#000">i</span><span style="color:#000">++</span>) {
</span></span><span style="display:flex;"><span>    	<span style="color:#000">vkDestroyFramebuffer</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>, <span style="color:#000">vk</span>.<span style="color:#000">framebuffers</span>[<span style="color:#000">i</span>], <span style="color:#000">VK_ALLOC</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#000">free</span>(<span style="color:#000">vk</span>.<span style="color:#000">framebuffers</span>);
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>最后，我们在<code>VkHelper</code>中实现创建帧缓冲的实现。同样的，核心就是构建<code>VkFramebufferCreateInfo</code>对象，缺什么给什么就可以。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">createFramebuffer</span>(<span style="color:#000">VkDevice</span> <span style="color:#000">device</span>, <span style="color:#000">VkRenderPass</span> <span style="color:#000">renderPass</span>,
</span></span><span style="display:flex;"><span>                                 <span style="color:#a90d91">uint32_t</span> <span style="color:#000">width</span>, <span style="color:#a90d91">uint32_t</span> <span style="color:#000">height</span>,
</span></span><span style="display:flex;"><span>                                 <span style="color:#a90d91">uint32_t</span> <span style="color:#000">framebufferCount</span>, <span style="color:#000">VkImageView</span> <span style="color:#000">*</span><span style="color:#000">imageViews</span>, <span style="color:#000">VkFramebuffer</span> <span style="color:#000">*</span><span style="color:#000">out_framebuffers</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">for</span>(<span style="color:#a90d91">uint32_t</span> <span style="color:#000">i</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>; <span style="color:#000">i</span> <span style="color:#000">&lt;</span> <span style="color:#000">framebufferCount</span>; <span style="color:#000">i</span><span style="color:#000">++</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#000">VkImageView</span> <span style="color:#000">attachment</span>[] <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#000">imageViews</span>[<span style="color:#000">i</span>],
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>        <span style="color:#000">VkFramebufferCreateInfo</span> <span style="color:#000">createInfo</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>                .<span style="color:#000">sType</span> <span style="color:#000">=</span> <span style="color:#000">VK_STRUCTURE_TYPE_FRAMEBUFFER_CREATE_INFO</span>,
</span></span><span style="display:flex;"><span>                .<span style="color:#000">pNext</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>                .<span style="color:#000">flags</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>                .<span style="color:#000">renderPass</span> <span style="color:#000">=</span> <span style="color:#000">renderPass</span>,
</span></span><span style="display:flex;"><span>                .<span style="color:#000">attachmentCount</span> <span style="color:#000">=</span> <span style="color:#000">ARRAY_SIZE</span>(<span style="color:#000">attachment</span>),
</span></span><span style="display:flex;"><span>                .<span style="color:#000">pAttachments</span> <span style="color:#000">=</span> <span style="color:#000">attachment</span>,
</span></span><span style="display:flex;"><span>                .<span style="color:#000">width</span> <span style="color:#000">=</span> <span style="color:#000">width</span>,
</span></span><span style="display:flex;"><span>                .<span style="color:#000">height</span> <span style="color:#000">=</span> <span style="color:#000">height</span>,
</span></span><span style="display:flex;"><span>                .<span style="color:#000">layers</span> <span style="color:#000">=</span> <span style="color:#1c01ce">1</span>
</span></span><span style="display:flex;"><span>        };
</span></span><span style="display:flex;"><span>        <span style="color:#000">CALL_VK</span>(<span style="color:#000">vkCreateFramebuffer</span>(<span style="color:#000">device</span>, <span style="color:#000">&amp;</span><span style="color:#000">createInfo</span>, <span style="color:#000">VK_ALLOC</span>, <span style="color:#000">&amp;</span><span style="color:#000">out_framebuffers</span>[<span style="color:#000">i</span>]));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="38-图形渲染管线">3.8 图形渲染管线</h3>
<p>图形渲染管线的初始化比较复杂，我们首先要创建一个管线布局（PipelineLayerout），再创建管线。</p>
<p>我们先添加成员变量。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">struct</span> <span style="color:#3f6e75">VkBundle</span> {
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">uint32_t</span> <span style="color:#000">framebufferCount</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkFramebuffer</span> <span style="color:#000">*</span><span style="color:#000">framebuffers</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkPipelineLayout</span> <span style="color:#000">pipelineLayout</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>然后添加<code>createPipelineLayout()</code>函数。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">createPipelineLayout</span>(<span style="color:#000">VkDevice</span> <span style="color:#000">device</span>, <span style="color:#000">VkPipelineLayout</span> <span style="color:#000">*</span><span style="color:#000">out_pipelineLayout</span>) {}
</span></span></code></pre></div><p>其实管线布局重要参数是配置uniform、constant变量，在渲染时传递给着色器，比如MVP矩阵信息。但本文案例不作这些处理，所以只需要直接创建管线布局即可。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">createPipelineLayout</span>(<span style="color:#000">VkDevice</span> <span style="color:#000">device</span>, <span style="color:#000">VkPipelineLayout</span> <span style="color:#000">*</span><span style="color:#000">out_pipelineLayout</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkPipelineLayoutCreateInfo</span> <span style="color:#000">createInfo</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>            .<span style="color:#000">sType</span> <span style="color:#000">=</span> <span style="color:#000">VK_STRUCTURE_TYPE_PIPELINE_LAYOUT_CREATE_INFO</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">pNext</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">flags</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">setLayoutCount</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">pSetLayouts</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">pushConstantRangeCount</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">pPushConstantRanges</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#000">CALL_VK</span>(<span style="color:#000">vkCreatePipelineLayout</span>(<span style="color:#000">device</span>, <span style="color:#000">&amp;</span><span style="color:#000">createInfo</span>, <span style="color:#000">VK_ALLOC</span>, <span style="color:#000">out_pipelineLayout</span>));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>使用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">init</span>(){
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">createPipelineLayout</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>, <span style="color:#000">&amp;</span><span style="color:#000">vk</span>.<span style="color:#000">pipelineLayout</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>销毁。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">destroy</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#000">Print</span>(<span style="color:#c41a16">&#34;%s&#34;</span>, <span style="color:#000">__FUNCTION__</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">vkDeviceWaitIdle</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vkDestroyPipelineLayout</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>, <span style="color:#000">vk</span>.<span style="color:#000">pipelineLayout</span>, <span style="color:#000">VK_ALLOC</span>);
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>然后接着开始创建渲染管线，我们通过以下步骤配置。</p>
<ol>
<li>编译顶点着色器；</li>
<li>编译片元着色器；</li>
<li>顶点输入配置；</li>
<li>图元装配；</li>
<li>裁剪；</li>
<li>光栅化；</li>
<li>多重采样；</li>
<li>颜色混合；</li>
</ol>
<h4 id="381-编译着色器">3.8.1 编译着色器</h4>
<p>在本案例中，我们只需要一个顶点着色器和一个片元着色器。Vulkan为了性能考虑，使用的着色器程序是GLSL编译后的<code>.spv</code>中间文件。所以我们分了“编译着色器程序到中间文件”和“读取着色器程序”两个步骤。</p>
<p><strong>编译着色器程序到中间文件</strong></p>
<p>我们需要借助<a href="https://github.com/KhronosGroup/glslang">glslangValidator</a>工具来完成这项任务，我们下载之后，把可执行文件配置到环境变量即可。</p>
<p><figure class="max-w-2xl mx-auto overflow-hidden">
    
    <a data-fancybox="gallery" href="./../assets/image-20230609165453905.png" target="_blank">
        <img alt="" src="./../assets/image-20230609165453905.png" />
    </a>
    
    <figcaption class="p-2 text-center"></figcaption>
</figure>
    </p>
<p>添加到环境变量后：</p>
<p><figure class="max-w-2xl mx-auto overflow-hidden">
    
    <a data-fancybox="gallery" href="./../assets/image-20230609165612502.png" target="_blank">
        <img alt="" src="./../assets/image-20230609165612502.png" />
    </a>
    
    <figcaption class="p-2 text-center"></figcaption>
</figure>
    </p>
<p>有了这个工具之后，我们编写顶点着色器程序和片元着色器程序。</p>
<p>在项目根目录创建一个<code>shaders</code>文件夹。添加<code>demo001.vert</code>、<code>demo001.frag</code>两个文件，内容如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-glsl" data-lang="glsl"><span style="display:flex;"><span><span style="color:#633820">#version 450</span>
</span></span><span style="display:flex;"><span><span style="color:#633820">#extension GL_ARB_separate_shader_objects : enable</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a90d91">out</span> <span style="color:#000">gl_PerVertex</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">vec4</span> <span style="color:#000">gl_Position</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a90d91">out</span> <span style="color:#000">layout</span>(<span style="color:#000">location</span><span style="color:#000">=</span><span style="color:#1c01ce">0</span>) <span style="color:#a90d91">vec4</span> <span style="color:#000">vertexColor</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a90d91">vec3</span> <span style="color:#000">verties</span>[] <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">vec3</span>(<span style="color:#1c01ce">0</span>, <span style="color:#1c01ce">0</span>, <span style="color:#1c01ce">0</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">vec3</span>(<span style="color:#1c01ce">0</span>, <span style="color:#1c01ce">0.5</span><span style="color:#000">f</span>, <span style="color:#1c01ce">0</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">vec3</span>(<span style="color:#000">-</span><span style="color:#1c01ce">0.5</span><span style="color:#000">f</span>, <span style="color:#1c01ce">0</span>, <span style="color:#1c01ce">0</span>)
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a90d91">vec4</span> <span style="color:#000">colors</span>[] <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">vec4</span>(<span style="color:#1c01ce">1</span>, <span style="color:#1c01ce">0</span>, <span style="color:#1c01ce">0</span>, <span style="color:#1c01ce">1</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">vec4</span>(<span style="color:#1c01ce">0</span>, <span style="color:#1c01ce">1</span>, <span style="color:#1c01ce">0</span>, <span style="color:#1c01ce">1</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">vec4</span>(<span style="color:#1c01ce">0</span>, <span style="color:#1c01ce">0</span>, <span style="color:#1c01ce">1</span>, <span style="color:#1c01ce">1</span>)
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">main</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">vec3</span> <span style="color:#000">in_pos</span> <span style="color:#000">=</span> <span style="color:#000">verties</span>[<span style="color:#000">gl_VertexIndex</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#000">gl_Position</span> <span style="color:#000">=</span> <span style="color:#a90d91">vec4</span>(<span style="color:#000">in_pos</span>.<span style="color:#000">x</span>, <span style="color:#000">-</span><span style="color:#000">in_pos</span>.<span style="color:#000">y</span>, <span style="color:#000">in_pos</span>.<span style="color:#000">z</span>, <span style="color:#1c01ce">1.0</span><span style="color:#000">f</span>);    <span style="color:#177500">//reverse Y, same as OpenGL</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vertexColor</span> <span style="color:#000">=</span> <span style="color:#000">colors</span>[<span style="color:#000">gl_VertexIndex</span>];
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#633820">#version 450
</span></span></span><span style="display:flex;"><span><span style="color:#633820">#extension GL_ARB_separate_shader_objects : enable
</span></span></span><span style="display:flex;"><span><span style="color:#633820"></span>
</span></span><span style="display:flex;"><span><span style="color:#000">layout</span>(<span style="color:#000">location</span><span style="color:#000">=</span><span style="color:#1c01ce">0</span>) <span style="color:#000">in</span> <span style="color:#000">vec4</span> <span style="color:#000">vertexColor</span>;
</span></span><span style="display:flex;"><span><span style="color:#000">layout</span>(<span style="color:#000">location</span><span style="color:#000">=</span><span style="color:#1c01ce">0</span>) <span style="color:#000">out</span> <span style="color:#000">vec4</span> <span style="color:#000">outColor</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">main</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#000">outColor</span> <span style="color:#000">=</span> <span style="color:#000">vertexColor</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>接下来就使用一个cmake构建工具（SPIR-V.cmake）来完成自动编译，省去我们自己执行命令。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#000">find_program</span>(<span style="color:#000">GLSLANGVALIDATOR_COMMAND</span> <span style="color:#000">glslangValidator</span>)
</span></span><span style="display:flex;"><span><span style="color:#a90d91">if</span>(<span style="color:#000">NOT</span> <span style="color:#000">GLSLANGVALIDATOR_COMMAND</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#000">message</span>(<span style="color:#000">FATAL_ERROR</span> <span style="color:#c41a16">&#34;glslangValidator required - source maintained at https://github.com/KhronosGroup/glslang&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#000">endif</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#633820">#
</span></span></span><span style="display:flex;"><span><span style="color:#633820"># Generate SPIR-V header files from the arguments. Returns a list of headers.
</span></span></span><span style="display:flex;"><span><span style="color:#633820">#
</span></span></span><span style="display:flex;"><span><span style="color:#633820"></span><span style="color:#000">function</span>(<span style="color:#000">spirv_shaders</span> <span style="color:#000">ret</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#000">set</span>(<span style="color:#000">options</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#000">set</span>(<span style="color:#000">oneValueArgs</span> <span style="color:#000">SPIRV_VERSION</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#000">set</span>(<span style="color:#000">multiValueArgs</span> <span style="color:#000">SOURCES</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#000">cmake_parse_arguments</span>(<span style="color:#000">_spirvshaders</span> <span style="color:#c41a16">&#34;${options}&#34;</span> <span style="color:#c41a16">&#34;${oneValueArgs}&#34;</span>
</span></span><span style="display:flex;"><span>	                      <span style="color:#c41a16">&#34;${multiValueArgs}&#34;</span> <span style="color:#000">$</span>{<span style="color:#000">ARGN</span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a90d91">if</span>(<span style="color:#000">NOT</span> <span style="color:#000">_spirvshaders_SPIRV_VERSION</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#000">set</span>(<span style="color:#000">_spirvshaders_SPIRV_VERSION</span> <span style="color:#1c01ce">1.0</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#000">endif</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">foreach</span>(<span style="color:#000">GLSL</span> <span style="color:#000">$</span>{<span style="color:#000">_spirvshaders_SOURCES</span>})
</span></span><span style="display:flex;"><span>		<span style="color:#000">string</span>(<span style="color:#000">MAKE_C_IDENTIFIER</span> <span style="color:#000">$</span>{<span style="color:#000">GLSL</span>} <span style="color:#000">IDENTIFIER</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#000">set</span>(<span style="color:#000">HEADER</span> <span style="color:#c41a16">&#34;${CMAKE_CURRENT_BINARY_DIR}/${GLSL}.spv&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#000">set</span>(<span style="color:#000">GLSL</span> <span style="color:#c41a16">&#34;${CMAKE_CURRENT_SOURCE_DIR}/${GLSL}&#34;</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>		<span style="color:#000">message</span>(<span style="color:#c41a16">&#34;GLSL Command: ${GLSLANGVALIDATOR_COMMAND} -V --target-env spirv${_spirvshaders_SPIRV_VERSION} ${GLSL} -o ${HEADER}&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">add_custom_command</span>(
</span></span><span style="display:flex;"><span>			<span style="color:#000">OUTPUT</span> <span style="color:#000">$</span>{<span style="color:#000">HEADER</span>}
</span></span><span style="display:flex;"><span>			<span style="color:#000">COMMAND</span> <span style="color:#000">$</span>{<span style="color:#000">GLSLANGVALIDATOR_COMMAND</span>} <span style="color:#000">-</span><span style="color:#000">V</span> <span style="color:#000">--</span><span style="color:#000">target</span><span style="color:#000">-</span><span style="color:#000">env</span> <span style="color:#000">spirv</span><span style="color:#000">$</span>{<span style="color:#000">_spirvshaders_SPIRV_VERSION</span>} <span style="color:#000">$</span>{<span style="color:#000">GLSL</span>} <span style="color:#000">-</span><span style="color:#000">o</span> <span style="color:#000">$</span>{<span style="color:#000">HEADER</span>}
</span></span><span style="display:flex;"><span>			<span style="color:#000">DEPENDS</span> <span style="color:#000">$</span>{<span style="color:#000">GLSL</span>})
</span></span><span style="display:flex;"><span>		<span style="color:#000">list</span>(<span style="color:#000">APPEND</span> <span style="color:#000">HEADERS</span> <span style="color:#000">$</span>{<span style="color:#000">HEADER</span>})
</span></span><span style="display:flex;"><span>	<span style="color:#000">endforeach</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">set</span>(<span style="color:#000">$</span>{<span style="color:#000">ret</span>} <span style="color:#c41a16">&#34;${HEADERS}&#34;</span> <span style="color:#000">PARENT_SCOPE</span>)
</span></span><span style="display:flex;"><span><span style="color:#000">endfunction</span>(<span style="color:#000">spirv_shaders</span>)
</span></span></code></pre></div><p>这里对应的两句编译命令也会在Build时打印出来。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>GLSL Command: C:/Users/ts/VK/Bin/glslangValidator.exe -V --target-env spirv1.0 D:/st/learn_vulkan_blog/00_hello_triangle/shaders/demo001.frag -o D:/st/learn_vulkan_blog/00_hello_triangle/cmake-build-debug/shaders/demo001.frag.spv
</span></span><span style="display:flex;"><span>GLSL Command: C:/Users/ts/VK/Bin/glslangValidator.exe -V --target-env spirv1.0 D:/st/learn_vulkan_blog/00_hello_triangle/shaders/demo001.vert -o D:/st/learn_vulkan_blog/00_hello_triangle/cmake-build-debug/shaders/demo001.vert.spv
</span></span></code></pre></div><p>然后在<code>CMakeLists.txt</code>中添加以下内容。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span><span style="color:#000">...
</span></span></span><span style="display:flex;"><span><span style="color:#000">...
</span></span></span><span style="display:flex;"><span><span style="color:#000">
</span></span></span><span style="display:flex;"><span><span style="color:#000"></span><span style="color:#a90d91">list</span>(<span style="color:#c41a16">APPEND</span> <span style="color:#c41a16">CMAKE_MODULE_PATH</span> <span style="color:#c41a16">&#34;${CMAKE_CURRENT_SOURCE_DIR}&#34;</span>)<span style="color:#000">
</span></span></span><span style="display:flex;"><span><span style="color:#000"></span><span style="color:#a90d91">include</span>(<span style="color:#c41a16">SPIR-V</span>)<span style="color:#000">
</span></span></span><span style="display:flex;"><span><span style="color:#000">
</span></span></span><span style="display:flex;"><span><span style="color:#000"></span><span style="color:#177500"># 使用SHADERS暂存shader文件列表
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span><span style="color:#a90d91">set</span>(<span style="color:#c41a16">SHADERS</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c41a16">shaders/demo001.frag</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c41a16">shaders/demo001.vert</span>
</span></span><span style="display:flex;"><span>        <span style="color:#177500"># shaders/demo002.frag
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>        <span style="color:#177500"># shaders/demo002.vert
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>        <span style="color:#177500"># ...
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>        <span style="color:#177500"># ...
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>        )<span style="color:#000">
</span></span></span><span style="display:flex;"><span><span style="color:#000"></span><span style="color:#177500"># 编译为中间文件
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span><span style="color:#a90d91">spirv_shaders</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#c41a16">SHADER_HEADERS</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c41a16">SPIRV_VERSION</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c41a16">1.0</span> <span style="color:#177500"># Currently targeting Vulkan 1.0
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>        <span style="color:#c41a16">SOURCES</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">${</span><span style="color:#000">SHADERS</span><span style="color:#000">}</span>
</span></span><span style="display:flex;"><span>)<span style="color:#000">
</span></span></span><span style="display:flex;"><span><span style="color:#000">
</span></span></span><span style="display:flex;"><span><span style="color:#000"></span><span style="color:#a90d91">add_executable</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#000">${</span><span style="color:#000">PROJECT_NAME</span><span style="color:#000">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">${</span><span style="color:#000">SHADER_HEADERS</span><span style="color:#000">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c41a16">src/VulkanCommon.h</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c41a16">src/Main.cpp</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c41a16">src/VkBundle.h</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c41a16">src/VkHelper.cpp</span>
</span></span><span style="display:flex;"><span>        <span style="color:#c41a16">src/VkHelper.h</span>
</span></span><span style="display:flex;"><span>)<span style="color:#000">
</span></span></span><span style="display:flex;"><span><span style="color:#000">
</span></span></span><span style="display:flex;"><span><span style="color:#000">...
</span></span></span><span style="display:flex;"><span><span style="color:#000">...
</span></span></span></code></pre></div><p><strong>读取着色器程序</strong></p>
<p>读取文件到字符数组中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">static</span> <span style="color:#000">std</span><span style="color:#000">::</span><span style="color:#000">vector</span><span style="color:#000">&lt;</span><span style="color:#a90d91">char</span><span style="color:#000">&gt;</span> <span style="color:#000">readFile</span>(<span style="color:#a90d91">const</span> <span style="color:#000">std</span><span style="color:#000">::</span><span style="color:#000">string</span><span style="color:#000">&amp;</span> <span style="color:#000">filePath</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#177500">//从文件尾部开始读取
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#000">std</span><span style="color:#000">::</span><span style="color:#000">ifstream</span> <span style="color:#000">file</span>(<span style="color:#000">filePath</span>, <span style="color:#000">std</span><span style="color:#000">::</span><span style="color:#000">ios</span><span style="color:#000">::</span><span style="color:#000">ate</span> <span style="color:#000">|</span> <span style="color:#000">std</span><span style="color:#000">::</span><span style="color:#000">ios</span><span style="color:#000">::</span><span style="color:#000">binary</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">if</span>(<span style="color:#000">!</span><span style="color:#000">file</span>.<span style="color:#000">is_open</span>()){
</span></span><span style="display:flex;"><span>        <span style="color:#a90d91">throw</span> <span style="color:#000">std</span><span style="color:#000">::</span><span style="color:#000">runtime_error</span>(<span style="color:#c41a16">&#34;can not open the file: &#34;</span> <span style="color:#000">+</span> <span style="color:#000">filePath</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">size_t</span> <span style="color:#000">fileSize</span> <span style="color:#000">=</span> (<span style="color:#000">size_t</span>) <span style="color:#000">file</span>.<span style="color:#000">tellg</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#000">std</span><span style="color:#000">::</span><span style="color:#000">vector</span><span style="color:#000">&lt;</span><span style="color:#a90d91">char</span><span style="color:#000">&gt;</span> <span style="color:#000">buffer</span>(<span style="color:#000">fileSize</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">file</span>.<span style="color:#000">seekg</span>(<span style="color:#1c01ce">0</span>);<span style="color:#177500">//从头开始读
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#000">file</span>.<span style="color:#000">read</span>(<span style="color:#000">buffer</span>.<span style="color:#000">data</span>(), <span style="color:#000">fileSize</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">file</span>.<span style="color:#000">close</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">return</span> <span style="color:#000">buffer</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>着色器程序读取。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">init</span>(){
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#000">std</span><span style="color:#000">::</span><span style="color:#000">string</span> <span style="color:#000">shaders</span>(<span style="color:#c41a16">&#34;shaders/&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">const</span> <span style="color:#a90d91">char</span> <span style="color:#000">*</span><span style="color:#000">defaultShader</span> <span style="color:#000">=</span> <span style="color:#c41a16">&#34;demo001&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">auto</span> <span style="color:#000">vertexShaderCode</span> <span style="color:#000">=</span> <span style="color:#000">readFile</span>(<span style="color:#000">shaders</span> <span style="color:#000">+</span> <span style="color:#000">defaultShader</span> <span style="color:#000">+</span> <span style="color:#c41a16">&#34;.vert.spv&#34;</span>);<span style="color:#177500">// ---&gt; shaders/demo001.vert.spv
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#a90d91">auto</span> <span style="color:#000">fragShaderCode</span> <span style="color:#000">=</span> <span style="color:#000">readFile</span>(<span style="color:#000">shaders</span> <span style="color:#000">+</span> <span style="color:#000">defaultShader</span> <span style="color:#000">+</span> <span style="color:#c41a16">&#34;.frag.spv&#34;</span>);<span style="color:#177500">// ---&gt; shaders/demo001.frag.spv
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>}
</span></span></code></pre></div><p>分别创建<code>VkShaderModule</code>，我们在<code>VkHelper</code>中完成重复操作。抽取一个<code>createShaderModule()</code>函数完成着色器程序的编译。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#000">VkShaderModule</span> <span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">createShaderModule</span>(<span style="color:#000">VkDevice</span> <span style="color:#000">device</span>, <span style="color:#000">std</span><span style="color:#000">::</span><span style="color:#000">vector</span><span style="color:#000">&lt;</span><span style="color:#a90d91">char</span><span style="color:#000">&gt;</span> <span style="color:#000">&amp;</span><span style="color:#000">code</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkShaderModuleCreateInfo</span> <span style="color:#000">createInfo</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">createInfo</span>.<span style="color:#000">sType</span> <span style="color:#000">=</span> <span style="color:#000">VK_STRUCTURE_TYPE_SHADER_MODULE_CREATE_INFO</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">createInfo</span>.<span style="color:#000">pNext</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">createInfo</span>.<span style="color:#000">flags</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">createInfo</span>.<span style="color:#000">codeSize</span> <span style="color:#000">=</span> <span style="color:#000">code</span>.<span style="color:#000">size</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#000">createInfo</span>.<span style="color:#000">pCode</span> <span style="color:#000">=</span> <span style="color:#a90d91">reinterpret_cast</span><span style="color:#000">&lt;</span><span style="color:#a90d91">const</span> <span style="color:#a90d91">uint32_t</span> <span style="color:#000">*&gt;</span>(<span style="color:#000">code</span>.<span style="color:#000">data</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkShaderModule</span> <span style="color:#000">shaderModule</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">if</span>(<span style="color:#000">vkCreateShaderModule</span>(<span style="color:#000">device</span>, <span style="color:#000">&amp;</span><span style="color:#000">createInfo</span>, <span style="color:#a90d91">nullptr</span>, <span style="color:#000">&amp;</span><span style="color:#000">shaderModule</span>) <span style="color:#000">!=</span> <span style="color:#000">VK_SUCCESS</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#a90d91">throw</span> <span style="color:#000">std</span><span style="color:#000">::</span><span style="color:#000">runtime_error</span>(<span style="color:#c41a16">&#34;failed to create shader module!&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">return</span> <span style="color:#000">shaderModule</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">struct</span> <span style="color:#3f6e75">VkBundle</span> {
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkShaderModule</span> <span style="color:#000">vertexShaderModule</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkShaderModule</span> <span style="color:#000">fragShaderModule</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">init</span>(){
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#000">std</span><span style="color:#000">::</span><span style="color:#000">string</span> <span style="color:#000">shaders</span>(<span style="color:#c41a16">&#34;shaders/&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">const</span> <span style="color:#a90d91">char</span> <span style="color:#000">*</span><span style="color:#000">defaultShader</span> <span style="color:#000">=</span> <span style="color:#c41a16">&#34;demo01&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">auto</span> <span style="color:#000">vertexShaderCode</span> <span style="color:#000">=</span> <span style="color:#000">readFile</span>(<span style="color:#000">shaders</span> <span style="color:#000">+</span> <span style="color:#000">defaultShader</span> <span style="color:#000">+</span> <span style="color:#c41a16">&#34;.vert.spv&#34;</span>);<span style="color:#177500">// ---&gt; shaders/demo01.vert.spv
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#a90d91">auto</span> <span style="color:#000">fragShaderCode</span> <span style="color:#000">=</span> <span style="color:#000">readFile</span>(<span style="color:#000">shaders</span> <span style="color:#000">+</span> <span style="color:#000">defaultShader</span> <span style="color:#000">+</span> <span style="color:#c41a16">&#34;.frag.spv&#34;</span>);<span style="color:#177500">// ---&gt; shaders/demo01.frag.spv
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000">vk</span>.<span style="color:#000">vertexShaderModule</span> <span style="color:#000">=</span> <span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">createShaderModule</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>, <span style="color:#000">vertexShaderCode</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">vk</span>.<span style="color:#000">fragShaderModule</span> <span style="color:#000">=</span> <span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">createShaderModule</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>, <span style="color:#000">fragShaderCode</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>销毁。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">destroy</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#000">Print</span>(<span style="color:#c41a16">&#34;%s&#34;</span>, <span style="color:#000">__FUNCTION__</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">vkDeviceWaitIdle</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vkDestroyShaderModule</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>, <span style="color:#000">vk</span>.<span style="color:#000">vertexShaderModule</span>, <span style="color:#000">VK_ALLOC</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">vkDestroyShaderModule</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>, <span style="color:#000">vk</span>.<span style="color:#000">fragShaderModule</span>, <span style="color:#000">VK_ALLOC</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="382-渲染管线配置">3.8.2 渲染管线配置</h4>
<p>同样的，我们先在<code>VkBundle</code>中维护<code>VkPipeline</code>对象。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">struct</span> <span style="color:#3f6e75">VkBundle</span> {
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkPipeline</span> <span style="color:#000">graphicPipeline</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>然后在<code>VkHelper</code>中添加实现。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">createPipeline</span>(<span style="color:#000">VkDevice</span> <span style="color:#000">device</span>, <span style="color:#000">VkPipelineLayout</span> <span style="color:#000">pipelineLayout</span>, <span style="color:#000">VkRenderPass</span> <span style="color:#000">renderPass</span>, <span style="color:#000">VkShaderModule</span> <span style="color:#000">vertShaderModule</span>, <span style="color:#000">VkShaderModule</span> <span style="color:#000">fragShaderModule</span>, <span style="color:#000">SwapchainParam</span> <span style="color:#000">swapchainParam</span>, <span style="color:#000">VkPipeline</span> <span style="color:#000">*</span><span style="color:#000">out_pipeline</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#177500">//TODO 
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>}
</span></span></code></pre></div><p>需要配置以下内容。</p>
<ul>
<li>着色器对象。本案例就是上文创建的<code>vertexShaderModule</code>和<code>fragShaderModule</code></li>
<li>顶点输入。</li>
<li>图元装配。</li>
<li>视口裁剪。</li>
<li>光栅化。</li>
<li>多重采样。</li>
<li>颜色混合。</li>
</ul>
<p>着色器对象，也就是上文编译并创建完毕的顶点着色器和片元着色器。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#000">VkPipelineShaderStageCreateInfo</span> <span style="color:#000">stages</span>[] <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            .<span style="color:#000">sType</span> <span style="color:#000">=</span> <span style="color:#000">VK_STRUCTURE_TYPE_PIPELINE_SHADER_STAGE_CREATE_INFO</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">pNext</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">flags</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">stage</span> <span style="color:#000">=</span> <span style="color:#000">VK_SHADER_STAGE_VERTEX_BIT</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">module</span> <span style="color:#000">=</span> <span style="color:#000">vertShaderModule</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">pName</span> <span style="color:#000">=</span> <span style="color:#c41a16">&#34;main&#34;</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">pSpecializationInfo</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            .<span style="color:#000">sType</span> <span style="color:#000">=</span> <span style="color:#000">VK_STRUCTURE_TYPE_PIPELINE_SHADER_STAGE_CREATE_INFO</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">pNext</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">flags</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">stage</span> <span style="color:#000">=</span> <span style="color:#000">VK_SHADER_STAGE_FRAGMENT_BIT</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">module</span> <span style="color:#000">=</span> <span style="color:#000">fragShaderModule</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">pName</span> <span style="color:#000">=</span> <span style="color:#c41a16">&#34;main&#34;</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">pSpecializationInfo</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>顶点输入，本文的顶点数组都在着色器中定义了，所以这里全部置空即可。如果你对OpenGL有一定了解的话，这里可以理解为配置Vertex Buffer Object（VBO）。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#000">VkPipelineVertexInputStateCreateInfo</span> <span style="color:#000">vertexInputStateCreateInfo</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>        .<span style="color:#000">sType</span> <span style="color:#000">=</span> <span style="color:#000">VK_STRUCTURE_TYPE_PIPELINE_VERTEX_INPUT_STATE_CREATE_INFO</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pNext</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">flags</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">vertexBindingDescriptionCount</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pVertexBindingDescriptions</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">vertexAttributeDescriptionCount</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pVertexAttributeDescriptions</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>图元装配，<code>.topology</code>的类型有点、线、三角形等图元可以选择。本案例使用三角形图元。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#000">VkPipelineInputAssemblyStateCreateInfo</span> <span style="color:#000">assemblyStateCreateInfo</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>        .<span style="color:#000">sType</span> <span style="color:#000">=</span> <span style="color:#000">VK_STRUCTURE_TYPE_PIPELINE_INPUT_ASSEMBLY_STATE_CREATE_INFO</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pNext</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">flags</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">topology</span> <span style="color:#000">=</span> <span style="color:#000">VK_PRIMITIVE_TOPOLOGY_TRIANGLE_LIST</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">primitiveRestartEnable</span> <span style="color:#000">=</span> <span style="color:#000">VK_FALSE</span>,
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>视口和裁剪，本文将整个窗口大小作为视口大小，裁剪亦如此。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#000">VkViewport</span> <span style="color:#000">viewport</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>        .<span style="color:#000">x</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">y</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">width</span> <span style="color:#000">=</span> <span style="color:#a90d91">static_cast</span><span style="color:#000">&lt;</span><span style="color:#a90d91">float</span><span style="color:#000">&gt;</span>(<span style="color:#000">swapchainParam</span>.<span style="color:#000">extent</span>.<span style="color:#000">width</span>),
</span></span><span style="display:flex;"><span>        .<span style="color:#000">height</span> <span style="color:#000">=</span> <span style="color:#a90d91">static_cast</span><span style="color:#000">&lt;</span><span style="color:#a90d91">float</span><span style="color:#000">&gt;</span>(<span style="color:#000">swapchainParam</span>.<span style="color:#000">extent</span>.<span style="color:#000">height</span>),
</span></span><span style="display:flex;"><span>        .<span style="color:#000">minDepth</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">maxDepth</span> <span style="color:#000">=</span> <span style="color:#1c01ce">1</span>
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">VkRect2D</span> <span style="color:#000">scissor</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>        .<span style="color:#000">offset</span> <span style="color:#000">=</span> {<span style="color:#1c01ce">0</span>, <span style="color:#1c01ce">0</span>},
</span></span><span style="display:flex;"><span>        .<span style="color:#000">extent</span> <span style="color:#000">=</span> <span style="color:#000">swapchainParam</span>.<span style="color:#000">extent</span>,
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">VkPipelineViewportStateCreateInfo</span> <span style="color:#000">viewportStateCreateInfo</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>        .<span style="color:#000">sType</span> <span style="color:#000">=</span> <span style="color:#000">VK_STRUCTURE_TYPE_PIPELINE_VIEWPORT_STATE_CREATE_INFO</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pNext</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">flags</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">viewportCount</span> <span style="color:#000">=</span> <span style="color:#1c01ce">1</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pViewports</span> <span style="color:#000">=</span> <span style="color:#000">&amp;</span><span style="color:#000">viewport</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">scissorCount</span> <span style="color:#000">=</span> <span style="color:#1c01ce">1</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pScissors</span> <span style="color:#000">=</span> <span style="color:#000">&amp;</span><span style="color:#000">scissor</span>
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>光栅化，主要配置面的朝向（通过顶点的逆时针还是顺时针判断）、表面剔除和其他深度信息等。本文主要配置面的朝向和表面剔除，其他选项基本为false。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#000">VkPipelineRasterizationStateCreateInfo</span> <span style="color:#000">rasterizationStateCreateInfo</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>        .<span style="color:#000">sType</span> <span style="color:#000">=</span> <span style="color:#000">VK_STRUCTURE_TYPE_PIPELINE_RASTERIZATION_STATE_CREATE_INFO</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pNext</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">flags</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">depthClampEnable</span> <span style="color:#000">=</span> <span style="color:#000">VK_FALSE</span>,        <span style="color:#177500">//计算阴影
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>        .<span style="color:#000">rasterizerDiscardEnable</span> <span style="color:#000">=</span> <span style="color:#000">VK_FALSE</span>, <span style="color:#177500">//VK_TRUE表示所有几何图元都不能通过光栅化阶段。这一设置会禁止一切片段输出到帧缓冲
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>        <span style="color:#177500">// VK_POLYGON_MODE_FILL：整个多边形，包括多边形内部都产生片段
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>        <span style="color:#177500">// VK_POLYGON_MODE_LINE：只有多边形的边会产生片段
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>        <span style="color:#177500">// VK_POLYGON_MODE_POINT：只有多边形的顶点会产生片段
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>        .<span style="color:#000">polygonMode</span> <span style="color:#000">=</span> <span style="color:#000">VK_POLYGON_MODE_FILL</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">cullMode</span> <span style="color:#000">=</span> <span style="color:#000">VK_CULL_MODE_BACK_BIT</span>,   <span style="color:#177500">//表面剔除
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>        .<span style="color:#000">frontFace</span> <span style="color:#000">=</span> <span style="color:#000">VK_FRONT_FACE_COUNTER_CLOCKWISE</span>, <span style="color:#177500">//逆时针标识为前面
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>        .<span style="color:#000">depthBiasEnable</span> <span style="color:#000">=</span> <span style="color:#000">VK_FALSE</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">depthBiasConstantFactor</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">depthBiasClamp</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">depthBiasSlopeFactor</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">lineWidth</span> <span style="color:#000">=</span> <span style="color:#1c01ce">1.0f</span>,
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>多重采样。本文默认关闭抗锯齿，并只执行单次采样。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#000">VkPipelineMultisampleStateCreateInfo</span> <span style="color:#000">multisampleStateCreateInfo</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>        .<span style="color:#000">sType</span> <span style="color:#000">=</span> <span style="color:#000">VK_STRUCTURE_TYPE_PIPELINE_MULTISAMPLE_STATE_CREATE_INFO</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pNext</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">flags</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">rasterizationSamples</span> <span style="color:#000">=</span> <span style="color:#000">VK_SAMPLE_COUNT_1_BIT</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">sampleShadingEnable</span> <span style="color:#000">=</span> <span style="color:#000">VK_FALSE</span>,    <span style="color:#177500">//抗锯齿
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>        .<span style="color:#000">minSampleShading</span> <span style="color:#000">=</span> <span style="color:#1c01ce">1.0f</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pSampleMask</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">alphaToCoverageEnable</span> <span style="color:#000">=</span> <span style="color:#000">VK_FALSE</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">alphaToOneEnable</span> <span style="color:#000">=</span> <span style="color:#000">VK_FALSE</span>
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>颜色混合。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#000">VkPipelineColorBlendAttachmentState</span> <span style="color:#000">attachmentState</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#177500">//    VkColorComponentFlags    colorWriteMask;
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>        .<span style="color:#000">blendEnable</span> <span style="color:#000">=</span> <span style="color:#000">VK_FALSE</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">srcColorBlendFactor</span> <span style="color:#000">=</span> <span style="color:#000">VK_BLEND_FACTOR_ONE</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">dstColorBlendFactor</span> <span style="color:#000">=</span> <span style="color:#000">VK_BLEND_FACTOR_ZERO</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">colorBlendOp</span> <span style="color:#000">=</span> <span style="color:#000">VK_BLEND_OP_ADD</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">srcAlphaBlendFactor</span> <span style="color:#000">=</span> <span style="color:#000">VK_BLEND_FACTOR_ONE</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">dstAlphaBlendFactor</span> <span style="color:#000">=</span> <span style="color:#000">VK_BLEND_FACTOR_ZERO</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">alphaBlendOp</span> <span style="color:#000">=</span> <span style="color:#000">VK_BLEND_OP_ADD</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">colorWriteMask</span> <span style="color:#000">=</span> <span style="color:#000">VK_COLOR_COMPONENT_R_BIT</span> <span style="color:#000">|</span> <span style="color:#000">VK_COLOR_COMPONENT_G_BIT</span> <span style="color:#000">|</span> <span style="color:#000">VK_COLOR_COMPONENT_B_BIT</span> <span style="color:#000">|</span> <span style="color:#000">VK_COLOR_COMPONENT_A_BIT</span>
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">VkPipelineColorBlendStateCreateInfo</span> <span style="color:#000">colorBlendStateCreateInfo</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>        .<span style="color:#000">sType</span> <span style="color:#000">=</span> <span style="color:#000">VK_STRUCTURE_TYPE_PIPELINE_COLOR_BLEND_STATE_CREATE_INFO</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pNext</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">flags</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">logicOpEnable</span> <span style="color:#000">=</span> <span style="color:#000">VK_FALSE</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">logicOp</span> <span style="color:#000">=</span> <span style="color:#000">VK_LOGIC_OP_CLEAR</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">attachmentCount</span> <span style="color:#000">=</span> <span style="color:#1c01ce">1</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pAttachments</span> <span style="color:#000">=</span> <span style="color:#000">&amp;</span><span style="color:#000">attachmentState</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">blendConstants</span> <span style="color:#000">=</span> {<span style="color:#1c01ce">0</span>, <span style="color:#1c01ce">0</span>, <span style="color:#1c01ce">0</span>, <span style="color:#1c01ce">0</span>},
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>创建渲染管线，将上述所有管道状态配置赋值给<code>CreateInfo</code>对象。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#000">VkGraphicsPipelineCreateInfo</span> <span style="color:#000">createInfo</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>        .<span style="color:#000">sType</span> <span style="color:#000">=</span> <span style="color:#000">VK_STRUCTURE_TYPE_GRAPHICS_PIPELINE_CREATE_INFO</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pNext</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">flags</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">stageCount</span> <span style="color:#000">=</span> <span style="color:#000">ARRAY_SIZE</span>(<span style="color:#000">stages</span>),
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pStages</span> <span style="color:#000">=</span> <span style="color:#000">stages</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pVertexInputState</span> <span style="color:#000">=</span> <span style="color:#000">&amp;</span><span style="color:#000">vertexInputStateCreateInfo</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pInputAssemblyState</span> <span style="color:#000">=</span> <span style="color:#000">&amp;</span><span style="color:#000">assemblyStateCreateInfo</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pTessellationState</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pViewportState</span> <span style="color:#000">=</span> <span style="color:#000">&amp;</span><span style="color:#000">viewportStateCreateInfo</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pRasterizationState</span> <span style="color:#000">=</span> <span style="color:#000">&amp;</span><span style="color:#000">rasterizationStateCreateInfo</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pMultisampleState</span> <span style="color:#000">=</span> <span style="color:#000">&amp;</span><span style="color:#000">multisampleStateCreateInfo</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pDepthStencilState</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pColorBlendState</span> <span style="color:#000">=</span> <span style="color:#000">&amp;</span><span style="color:#000">colorBlendStateCreateInfo</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pDynamicState</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">layout</span> <span style="color:#000">=</span> <span style="color:#000">pipelineLayout</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">renderPass</span> <span style="color:#000">=</span> <span style="color:#000">renderPass</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">subpass</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">basePipelineHandle</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">basePipelineIndex</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">CALL_VK</span>(<span style="color:#000">vkCreateGraphicsPipelines</span>(<span style="color:#000">device</span>, <span style="color:#a90d91">nullptr</span>, <span style="color:#1c01ce">1</span>, <span style="color:#000">&amp;</span><span style="color:#000">createInfo</span>, <span style="color:#000">VK_ALLOC</span>, <span style="color:#000">out_pipeline</span>));
</span></span></code></pre></div><p>使用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">init</span>(){
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#000">vk</span>.<span style="color:#000">vertexShaderModule</span> <span style="color:#000">=</span> <span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">createShaderModule</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>, <span style="color:#000">vertexShaderCode</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">vk</span>.<span style="color:#000">fragShaderModule</span> <span style="color:#000">=</span> <span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">createShaderModule</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>, <span style="color:#000">fragShaderCode</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">createPipeline</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>, <span style="color:#000">vk</span>.<span style="color:#000">pipelineLayout</span>, <span style="color:#000">vk</span>.<span style="color:#000">renderPass</span>, <span style="color:#000">vk</span>.<span style="color:#000">vertexShaderModule</span>, <span style="color:#000">vk</span>.<span style="color:#000">fragShaderModule</span>, <span style="color:#000">vk</span>.<span style="color:#000">swapchainParam</span>, <span style="color:#000">&amp;</span><span style="color:#000">vk</span>.<span style="color:#000">graphicPipeline</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>最后别忘了程序结束时销毁对象。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">destroy</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#000">Print</span>(<span style="color:#c41a16">&#34;%s&#34;</span>, <span style="color:#000">__FUNCTION__</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">vkDeviceWaitIdle</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vkDestroyPipeline</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>, <span style="color:#000">vk</span>.<span style="color:#000">graphicPipeline</span>, <span style="color:#000">VK_ALLOC</span>);
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="39-命令缓冲">3.9 命令缓冲</h3>
<p>从性能层面考虑，我们可以在初始化阶段创建好N个命令缓冲备用，在渲染循环中取出对应缓冲使用即可。这里命令缓冲的数量可以自定义，只要不出现冲突即可。在本案例中，我直接使用交换链中图片数作为命令缓冲的数量。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">struct</span> <span style="color:#3f6e75">VkBundle</span> {
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">uint32_t</span> <span style="color:#000">cmdBufferCount</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkCommandBuffer</span> <span style="color:#000">*</span><span style="color:#000">cmdBuffers</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>在<code>VkHelper</code>中增加申请命令缓冲的实现，其参数相对简单。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">allocateCommandBuffers</span>(<span style="color:#000">VkDevice</span> <span style="color:#000">device</span>, <span style="color:#000">VkCommandPool</span> <span style="color:#000">cmdPool</span>, <span style="color:#a90d91">uint32_t</span> <span style="color:#000">cmdBufferCount</span>, <span style="color:#000">VkCommandBuffer</span> <span style="color:#000">*</span><span style="color:#000">cmdBuffers</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#000">VkCommandBufferAllocateInfo</span> <span style="color:#000">allocateInfo</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>            .<span style="color:#000">sType</span> <span style="color:#000">=</span> <span style="color:#000">VK_STRUCTURE_TYPE_COMMAND_BUFFER_ALLOCATE_INFO</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">pNext</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">commandPool</span> <span style="color:#000">=</span> <span style="color:#000">cmdPool</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">level</span> <span style="color:#000">=</span> <span style="color:#000">VK_COMMAND_BUFFER_LEVEL_PRIMARY</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">commandBufferCount</span> <span style="color:#000">=</span> <span style="color:#000">cmdBufferCount</span>
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">CALL_VK</span>(<span style="color:#000">vkAllocateCommandBuffers</span>(<span style="color:#000">device</span>, <span style="color:#000">&amp;</span><span style="color:#000">allocateInfo</span>, <span style="color:#000">cmdBuffers</span>));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>在初始化时调用并赋值给<code>VkBundle</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">init</span>(){
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#000">vk</span>.<span style="color:#000">cmdBufferCount</span> <span style="color:#000">=</span> <span style="color:#000">vk</span>.<span style="color:#000">swapchainImage</span>.<span style="color:#000">imageCount</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">vk</span>.<span style="color:#000">cmdBuffers</span> <span style="color:#000">=</span> <span style="color:#a90d91">static_cast</span><span style="color:#000">&lt;</span><span style="color:#000">VkCommandBuffer</span> <span style="color:#000">*&gt;</span>(<span style="color:#000">malloc</span>(<span style="color:#a90d91">sizeof</span>(<span style="color:#000">VkCommandBuffer</span>) <span style="color:#000">*</span> <span style="color:#000">vk</span>.<span style="color:#000">cmdBufferCount</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkHelper</span><span style="color:#000">::</span><span style="color:#000">allocateCommandBuffers</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>, <span style="color:#000">vk</span>.<span style="color:#000">cmdPool</span>, <span style="color:#000">vk</span>.<span style="color:#000">cmdBufferCount</span>, <span style="color:#000">vk</span>.<span style="color:#000">cmdBuffers</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>销毁时释放命令缓冲。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">destroy</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#000">Print</span>(<span style="color:#c41a16">&#34;%s&#34;</span>, <span style="color:#000">__FUNCTION__</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">vkDeviceWaitIdle</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">vkFreeCommandBuffers</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>, <span style="color:#000">vk</span>.<span style="color:#000">cmdPool</span>, <span style="color:#000">vk</span>.<span style="color:#000">cmdBufferCount</span>, <span style="color:#000">vk</span>.<span style="color:#000">cmdBuffers</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">free</span>(<span style="color:#000">vk</span>.<span style="color:#000">cmdBuffers</span>);
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="310-信号量">3.10 信号量</h3>
<p>信号量是Vulkan中用作同步的对象之一，另外还有栅栏（Fence）等，不过本案例暂时不使用栅栏控制同步。</p>
<p>我们创建两个信号量，作用分别是：</p>
<ul>
<li>从交换链获取图像同步。即需要等待交换链图像准备完成方可执行渲染。</li>
<li>等待显示完成同步。即等待GPU完成工作，CPU再循环执行调用，形成CPU-GPU之间同步和配合。</li>
</ul>
<p>我们依然在<code>VkBundle</code>中维护这两个信号量。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">struct</span> <span style="color:#3f6e75">VkBundle</span> {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkSemaphore</span> <span style="color:#000">imageSemaphore</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkSemaphore</span> <span style="color:#000">presentSemaphore</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>信号量的创建较为简单，所以我们直接在<code>init()</code>中完成。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">init</span>(){
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>	...
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkSemaphoreCreateInfo</span> <span style="color:#000">semaphoreCreateInfo</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>            .<span style="color:#000">sType</span> <span style="color:#000">=</span> <span style="color:#000">VK_STRUCTURE_TYPE_SEMAPHORE_CREATE_INFO</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">pNext</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>            .<span style="color:#000">flags</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    <span style="color:#000">CALL_VK</span>(<span style="color:#000">vkCreateSemaphore</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>, <span style="color:#000">&amp;</span><span style="color:#000">semaphoreCreateInfo</span>, <span style="color:#000">VK_ALLOC</span>, <span style="color:#000">&amp;</span><span style="color:#000">vk</span>.<span style="color:#000">imageSemaphore</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#000">CALL_VK</span>(<span style="color:#000">vkCreateSemaphore</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>, <span style="color:#000">&amp;</span><span style="color:#000">semaphoreCreateInfo</span>, <span style="color:#000">VK_ALLOC</span>, <span style="color:#000">&amp;</span><span style="color:#000">vk</span>.<span style="color:#000">presentSemaphore</span>));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这样以来，信号量就可以使用了。接下来就是销毁逻辑。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">destroy</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#000">Print</span>(<span style="color:#c41a16">&#34;%s&#34;</span>, <span style="color:#000">__FUNCTION__</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">vkDeviceWaitIdle</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000">vkDestroySemaphore</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>, <span style="color:#000">vk</span>.<span style="color:#000">presentSemaphore</span>, <span style="color:#000">VK_ALLOC</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#000">vkDestroySemaphore</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>, <span style="color:#000">vk</span>.<span style="color:#000">imageSemaphore</span>, <span style="color:#000">VK_ALLOC</span>);
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="311-渲染">3.11 渲染</h3>
<p>到目前为止，我们已经初始化好了Vulkan实例、窗口、设备、命令缓冲、帧缓冲和渲染管线等对象。接下来的重头戏就是渲染，也可以理解为提交DrawCall。分为以下几个步骤。</p>
<ol>
<li>从交换链中获取图像；</li>
<li>开启命令缓冲、渲染流程；</li>
<li>执行vkCmdDraw()；</li>
<li>结束渲染流程、命令缓冲；</li>
<li>渲染命令缓冲提交到队列；</li>
<li>显示并等待GPU完成；</li>
<li>结束。</li>
</ol>
<h4 id="3111-获取交换链图像">3.11.1 获取交换链图像</h4>
<p>我们记录一下图像索引，由<code>vkAcquire..</code>获取图像信息，这里使用<code>imageSemaphore</code>信号量。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#a90d91">void</span> <span style="color:#000">render</span>(<span style="color:#a90d91">uint32_t</span> <span style="color:#000">currentFrame</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">if</span>(<span style="color:#000">!</span><span style="color:#000">canRender</span>) <span style="color:#a90d91">return</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a90d91">uint32_t</span> <span style="color:#000">imageIndex</span> <span style="color:#000">=</span> <span style="color:#1c01ce">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#000">VkResult</span> <span style="color:#000">rt</span> <span style="color:#000">=</span> <span style="color:#000">vkAcquireNextImageKHR</span>(<span style="color:#000">vk</span>.<span style="color:#000">deviceInfo</span>.<span style="color:#000">device</span>, <span style="color:#000">vk</span>.<span style="color:#000">swapchain</span>, <span style="color:#000">std</span><span style="color:#000">::</span><span style="color:#000">numeric_limits</span><span style="color:#000">&lt;</span><span style="color:#a90d91">uint64_t</span><span style="color:#000">&gt;::</span><span style="color:#000">max</span>(), <span style="color:#000">vk</span>.<span style="color:#000">imageSemaphore</span>, <span style="color:#000">VK_NULL_HANDLE</span>, <span style="color:#000">&amp;</span><span style="color:#000">imageIndex</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#177500">// out of date: 窗口变化等情况会出现这个返回。本案例先不处理。
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>    <span style="color:#a90d91">if</span>(<span style="color:#000">rt</span> <span style="color:#000">==</span> <span style="color:#000">VK_ERROR_OUT_OF_DATE_KHR</span>){
</span></span><span style="display:flex;"><span>        <span style="color:#000">Error</span>(<span style="color:#c41a16">&#34;swapchain was out of date.&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a90d91">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#177500">//TODO
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>}
</span></span></code></pre></div><h4 id="3112-开启命令缓冲">3.11.2 开启命令缓冲</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#000">VkCommandBufferBeginInfo</span> <span style="color:#000">cmdBufferBeginInfo</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>        .<span style="color:#000">sType</span> <span style="color:#000">=</span> <span style="color:#000">VK_STRUCTURE_TYPE_COMMAND_BUFFER_BEGIN_INFO</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pNext</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#177500">//VK_COMMAND_BUFFER_USAGE_ONE_TIME_SUBMIT_BIT：指令缓冲在执行一次后，就被用来记录新的指令。
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>        <span style="color:#177500">//VK_COMMAND_BUFFER_USAGE_RENDER_PASS_CONTINUE_BIT：这是一个只在一个渲染流程内使用的辅助指令缓冲。
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>        <span style="color:#177500">//VK_COMMAND_BUFFER_USAGE_SIMULTANEOUS_USE_BIT：在指令缓冲等待执行时，仍然可以提交这一指令缓冲。
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span>        .<span style="color:#000">flags</span> <span style="color:#000">=</span> <span style="color:#000">VK_COMMAND_BUFFER_USAGE_SIMULTANEOUS_USE_BIT</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pInheritanceInfo</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#000">CALL_VK</span>(<span style="color:#000">vkBeginCommandBuffer</span>(<span style="color:#000">vk</span>.<span style="color:#000">cmdBuffers</span>[<span style="color:#000">imageIndex</span>], <span style="color:#000">&amp;</span><span style="color:#000">cmdBufferBeginInfo</span>));
</span></span></code></pre></div><h4 id="3113-开启渲染流程">3.11.3 开启渲染流程</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#000">VkClearValue</span> <span style="color:#000">defaultClearValues</span> <span style="color:#000">=</span> { <span style="color:#1c01ce">0.1f</span>,  <span style="color:#1c01ce">0.1f</span>,  <span style="color:#1c01ce">0.2f</span>,  <span style="color:#1c01ce">1.0f</span>};<span style="color:#177500">//清屏颜色
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span><span style="color:#000">VkRenderPassBeginInfo</span> <span style="color:#000">renderPassBeginInfo</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>        .<span style="color:#000">sType</span> <span style="color:#000">=</span> <span style="color:#000">VK_STRUCTURE_TYPE_RENDER_PASS_BEGIN_INFO</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pNext</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">renderPass</span> <span style="color:#000">=</span> <span style="color:#000">vk</span>.<span style="color:#000">renderPass</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">framebuffer</span> <span style="color:#000">=</span> <span style="color:#000">vk</span>.<span style="color:#000">framebuffers</span>[<span style="color:#000">imageIndex</span>],
</span></span><span style="display:flex;"><span>        .<span style="color:#000">renderArea</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>                .<span style="color:#000">offset</span> <span style="color:#000">=</span> {<span style="color:#1c01ce">0</span>, <span style="color:#1c01ce">0</span>},
</span></span><span style="display:flex;"><span>                .<span style="color:#000">extent</span> <span style="color:#000">=</span> <span style="color:#000">vk</span>.<span style="color:#000">swapchainParam</span>.<span style="color:#000">extent</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        .<span style="color:#000">clearValueCount</span> <span style="color:#000">=</span> <span style="color:#1c01ce">1</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pClearValues</span> <span style="color:#000">=</span> <span style="color:#000">&amp;</span><span style="color:#000">defaultClearValues</span>,
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#177500">//VK_SUBPASS_CONTENTS_INLINE：所有要执行的指令都在主要指令缓冲中，没有辅助指令缓冲需要执行。
</span></span></span><span style="display:flex;"><span><span style="color:#177500">//VK_SUBPASS_CONTENTS_SECONDARY_COMMAND_BUFFERS：有来自辅助指令缓冲的指令需要执行。
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span><span style="color:#000">vkCmdBeginRenderPass</span>(<span style="color:#000">vk</span>.<span style="color:#000">cmdBuffers</span>[<span style="color:#000">imageIndex</span>], <span style="color:#000">&amp;</span><span style="color:#000">renderPassBeginInfo</span>, <span style="color:#000">VK_SUBPASS_CONTENTS_INLINE</span>);
</span></span></code></pre></div><h4 id="3114-执行渲染">3.11.4 执行渲染</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#177500">//绑定渲染管线
</span></span></span><span style="display:flex;"><span><span style="color:#177500"></span><span style="color:#000">vkCmdBindPipeline</span>(<span style="color:#000">vk</span>.<span style="color:#000">cmdBuffers</span>[<span style="color:#000">imageIndex</span>], <span style="color:#000">VK_PIPELINE_BIND_POINT_GRAPHICS</span>, <span style="color:#000">vk</span>.<span style="color:#000">graphicPipeline</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#177500">/*
</span></span></span><span style="display:flex;"><span><span style="color:#177500"> * commandBuffer 命令缓冲
</span></span></span><span style="display:flex;"><span><span style="color:#177500"> * vertexCount 顶点数量
</span></span></span><span style="display:flex;"><span><span style="color:#177500"> * instanceCount 实例数量，我们目前只绘制一个实例。当绘制大批量对象时会用到。
</span></span></span><span style="display:flex;"><span><span style="color:#177500"> * firstVertex 起始顶点，用于偏移
</span></span></span><span style="display:flex;"><span><span style="color:#177500"> * firstInstance 起始实例，用于偏移
</span></span></span><span style="display:flex;"><span><span style="color:#177500"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#000">vkCmdDraw</span>(<span style="color:#000">vk</span>.<span style="color:#000">cmdBuffers</span>[<span style="color:#000">imageIndex</span>], <span style="color:#1c01ce">3</span>, <span style="color:#1c01ce">1</span>, <span style="color:#1c01ce">0</span>, <span style="color:#1c01ce">0</span>);
</span></span></code></pre></div><h4 id="3115-结束渲染流程">3.11.5 结束渲染流程</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#000">vkCmdEndRenderPass</span>(<span style="color:#000">vk</span>.<span style="color:#000">cmdBuffers</span>[<span style="color:#000">imageIndex</span>]);
</span></span></code></pre></div><h4 id="3116-结束命令缓冲">3.11.6 结束命令缓冲</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#000">CALL_VK</span>(<span style="color:#000">vkEndCommandBuffer</span>(<span style="color:#000">vk</span>.<span style="color:#000">cmdBuffers</span>[<span style="color:#000">imageIndex</span>]));
</span></span></code></pre></div><h4 id="3117-将命令缓冲提交到队列">3.11.7 将命令缓冲提交到队列</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#000">VkPipelineStageFlags</span> <span style="color:#000">stages</span>[] <span style="color:#000">=</span> {<span style="color:#000">VK_PIPELINE_STAGE_COLOR_ATTACHMENT_OUTPUT_BIT</span>};
</span></span><span style="display:flex;"><span><span style="color:#000">VkSubmitInfo</span> <span style="color:#000">submitInfo</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>        .<span style="color:#000">sType</span> <span style="color:#000">=</span> <span style="color:#000">VK_STRUCTURE_TYPE_SUBMIT_INFO</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pNext</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">waitSemaphoreCount</span> <span style="color:#000">=</span> <span style="color:#1c01ce">1</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pWaitSemaphores</span> <span style="color:#000">=</span> <span style="color:#000">&amp;</span><span style="color:#000">vk</span>.<span style="color:#000">imageSemaphore</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pWaitDstStageMask</span> <span style="color:#000">=</span> <span style="color:#000">stages</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">commandBufferCount</span> <span style="color:#000">=</span> <span style="color:#1c01ce">1</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pCommandBuffers</span> <span style="color:#000">=</span> <span style="color:#000">&amp;</span><span style="color:#000">vk</span>.<span style="color:#000">cmdBuffers</span>[<span style="color:#000">imageIndex</span>],
</span></span><span style="display:flex;"><span>        .<span style="color:#000">signalSemaphoreCount</span> <span style="color:#000">=</span> <span style="color:#1c01ce">1</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pSignalSemaphores</span> <span style="color:#000">=</span> <span style="color:#000">&amp;</span><span style="color:#000">vk</span>.<span style="color:#000">presentSemaphore</span>,
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#000">CALL_VK</span>(<span style="color:#000">vkQueueSubmit</span>(<span style="color:#000">vk</span>.<span style="color:#000">queueInfo</span>.<span style="color:#000">queue</span>, <span style="color:#1c01ce">1</span>, <span style="color:#000">&amp;</span><span style="color:#000">submitInfo</span>, <span style="color:#000">VK_NULL_HANDLE</span>));
</span></span></code></pre></div><h4 id="3118-显示呈现">3.11.8 显示（呈现）</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#000">VkPresentInfoKHR</span> <span style="color:#000">presentInfo</span> <span style="color:#000">=</span> {
</span></span><span style="display:flex;"><span>        .<span style="color:#000">sType</span> <span style="color:#000">=</span> <span style="color:#000">VK_STRUCTURE_TYPE_PRESENT_INFO_KHR</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pNext</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">waitSemaphoreCount</span> <span style="color:#000">=</span> <span style="color:#1c01ce">1</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pWaitSemaphores</span> <span style="color:#000">=</span> <span style="color:#000">&amp;</span><span style="color:#000">vk</span>.<span style="color:#000">presentSemaphore</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">swapchainCount</span> <span style="color:#000">=</span> <span style="color:#1c01ce">1</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pSwapchains</span> <span style="color:#000">=</span> <span style="color:#000">&amp;</span><span style="color:#000">vk</span>.<span style="color:#000">swapchain</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pImageIndices</span> <span style="color:#000">=</span> <span style="color:#000">&amp;</span><span style="color:#000">imageIndex</span>,
</span></span><span style="display:flex;"><span>        .<span style="color:#000">pResults</span> <span style="color:#000">=</span> <span style="color:#a90d91">nullptr</span>
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span><span style="color:#000">CALL_VK</span>(<span style="color:#000">vkQueuePresentKHR</span>(<span style="color:#000">vk</span>.<span style="color:#000">queueInfo</span>.<span style="color:#000">queue</span>, <span style="color:#000">&amp;</span><span style="color:#000">presentInfo</span>));
</span></span></code></pre></div><h4 id="3119-等待gpu工作结束">3.11.9 等待GPU工作结束</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#000">CALL_VK</span>(<span style="color:#000">vkQueueWaitIdle</span>(<span style="color:#000">vk</span>.<span style="color:#000">queueInfo</span>.<span style="color:#000">queue</span>));
</span></span></code></pre></div><h2 id="4-总结">4 总结</h2>
<p>这篇文章我从构思到差不多写完经历了三个星期，可能最近比较懒散。也发现Vulkan绘制一个基本图元的过程，不管怎么精简，都需要1000多行的代码。涉及到的陌生对象非常之多，如果之前没有对应编程习惯，上手难度还是比较高的。本文仍然没有完整描述每个步骤的作用和选项。但我认为，要深入认识这些对象和每个属性的作用，仍然需要不断练习。所以后续我将继续学习和记录一些案例，以<strong>简单图元-&gt;贴图渲染-&gt;3D物体渲染-&gt;相机-&gt;光照/阴影</strong>这个路线再编写几个DEMO。</p>
<p>案例源码：<a href="https://gitee.com/xingchen0085/learn_vulkan_blog/tree/master/00_hello_triangle">learn_vulkan_blog</a></p>
<p>本人水平有限，如有问题还望指正，希望能和更多朋友交流！谢谢！</p>
<blockquote>
<p>我的博客原文：<a href="http://adiosy.com/posts/learn-vulkan/00learn-vulkan_%E5%BC%80%E7%AF%87.html">Learn Vulkan00_三角形</a></p>
</blockquote>
        </div>

        
<div class="post-archive">
    <ul class="post-copyright">
        <li><strong>Author: </strong><a rel="author" href="http://www.adiosy.com/">xingchen</a></li>
        <li style="word-break:break-all"><strong>Link: </strong><a href="http://www.adiosy.com/posts/learn_vulkan/learn_vulkan00_%E7%AC%AC%E4%B8%80%E4%B8%AA%E4%B8%89%E8%A7%92%E5%BD%A2.html">http://www.adiosy.com/posts/learn_vulkan/learn_vulkan00_%E7%AC%AC%E4%B8%80%E4%B8%AA%E4%B8%89%E8%A7%92%E5%BD%A2.html</a></li>
        <li><strong>License: </strong>This work is under a <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>. Kindly fulfill the requirements of the aforementioned License when adapting or creating a derivative of this work.</li>
    </ul>
</div>
<br/>



        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/posts/hello-openxr---%E7%AC%AC%E4%B8%80%E4%B8%AAopenxr%E7%A8%8B%E5%BA%8F.html">Hello OpenXR - 第一个OpenXR程序</a></li>
        
        <li><a href="/posts/opengl_renderer/04_%E7%BB%98%E5%88%B6%E7%82%B9%E7%BA%BF%E9%9D%A2.html">OpenGL渲染器04_绘制点线面</a></li>
        
        <li><a href="/posts/opengl_renderer/03_opengl%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA.html">OpenGL渲染器03_OpenGL环境 </a></li>
        
        <li><a href="/posts/opengl_renderer/02_c&#43;&#43;%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA.html">OpenGL渲染器02_C&#43;&#43;环境</a></li>
        
        <li><a href="/posts/opengl_renderer/01_%E5%BC%80%E7%AF%87.html">OpenGL渲染器01_开篇</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/vulkan'>Vulkan</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "xingchen0085/doc"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
    
    

</div>

                    <footer id="footer">

    
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://www.flysnow.org/" target="_black"><span class="badge-subject">Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>

    <br />
        
        <div>
            <span id="busuanzi_container_site_uv" style="font-family: auto;">
              本站访客数<span id="busuanzi_value_site_uv"></span>人次
            </span>
            &copy; 2025 <a href="http://www.adiosy.com/">Adiosy&#39;s blog By xingchen</a>
                
                | <a rel="nofollow" target="_blank" href="http://beian.miit.gov.cn/">滇ICP备2022000560号-1</a>
            
    </div>
</footer>


    
    <script src="//cdnjs.cloudflare.com/ajax/libs/raphael/2.2.8/raphael.min.js" crossorigin="anonymous"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/flowchart/1.12.2/flowchart.min.js" crossorigin="anonymous"></script>
        <script>(function () {
                if (!window.flowchart) return;
                const blocks = document.querySelectorAll('pre code.language-flowchart, pre code.language-flow');
                for (let i = 0; i < blocks.length; i++) {
                    const block = blocks[i];
                    const rootElement = block.parentNode;
                    const container = document.createElement('div');
                    const id = `js-flowchart-diagrams-${i}`;
                    container.id = id;
                    container.className = 'align-center';
                    container.setAttribute("style", "overFlow-x:auto");
                    rootElement.parentNode.replaceChild(container, rootElement);
                    const diagram = flowchart.parse(block.childNodes[0].nodeValue);
                    diagram.drawSVG(id, window.flowchartDiagramsOptions ? window.flowchartDiagramsOptions : {});
                }
            })();
        </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/webfont/1.6.28/webfontloader.js" crossorigin="anonymous"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/snap.svg/0.5.1/snap.svg-min.js" crossorigin="anonymous"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js" crossorigin="anonymous"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/js-sequence-diagrams/1.0.6/sequence-diagram-min.js" crossorigin="anonymous"></script>
        <script>(function () {
            if (!window.Diagram) return;
            const blocks = document.querySelectorAll('pre code.language-sequence');
            for (let i = 0; i < blocks.length; i++) {
                const block = blocks[i];
                
                const rootElement = block.parentNode;
                const container = document.createElement('div');
                const id = `js-sequence-diag-${i}`;
                container.id = id;
                container.className = 'align-center';
                container.setAttribute("style", "overFlow-x:auto");
                rootElement.parentNode.replaceChild(container, rootElement);

                const diagram = Diagram.parse(block.childNodes[0].nodeValue);
                diagram.drawSVG(id, window.sequenceDiagramsOptions
                    ? window.sequenceDiagramsOptions
                    : { theme: 'simple' });
            }
        })();
        </script><script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script><script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js"></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>


<style type="text/css">
div.highlight {
    position: relative;
    margin: 1em 0px;
}

.copy-code {
    display: none;
    position: absolute;
    top: 4px;
    right: 4px;
    color: rgba(255, 255, 255, 0.8);
    background: rgba(78, 78, 78, 0.8);
    border-radius: var(--radius);
    padding: 0 5px;
    font: inherit;
    user-select: none;
    cursor: pointer;
    border: 0;
    --radius: 8px;
}

div.highlight:hover .copy-code,pre:hover .copy-code {
    display: block;
}

</style>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>


    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




                </div>

                <div id="secondary">
    <section class="widget">
        
<form id="search" action='http://www.adiosy.com/search' method="get" accept-charset="utf-8" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="http://www.adiosy.com/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>

    <section class="widget">
        <h3 class="widget-title">Latest articles</h3>
<ul class="widget-list">
    
    <li>
        <a href="http://www.adiosy.com/posts/learn_vulkan/learn_vulkan04_%E6%B8%B2%E6%9F%93%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0_%E6%9D%90%E8%B4%A8%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1.html" title="Learn_Vulkan04_渲染框架实现_材质系统设计">Learn_Vulkan04_渲染框架实现_材质系统设计</a>
    </li>
    
    <li>
        <a href="http://www.adiosy.com/posts/android%E8%B7%A8%E8%BF%9B%E7%A8%8B%E6%B8%B2%E6%9F%93-hardwarebuffer.html" title="Android跨进程渲染-HardwareBuffer">Android跨进程渲染-HardwareBuffer</a>
    </li>
    
    <li>
        <a href="http://www.adiosy.com/posts/learn_vulkan/learn_vulkan03_%E6%B8%B2%E6%9F%93%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0_%E7%AA%97%E5%8F%A3%E5%92%8Cvulkan%E7%8E%AF%E5%A2%83.html" title="Learn_Vulkan03_渲染框架实现_窗口和Vulkan环境">Learn_Vulkan03_渲染框架实现_窗口和Vulkan环境</a>
    </li>
    
    <li>
        <a href="http://www.adiosy.com/posts/opengl%E6%88%96vulkan%E6%B8%B2%E6%9F%93yuv%E6%A0%BC%E5%BC%8F%E6%95%B0%E6%8D%AE.html" title="OpenGL或Vulkan渲染YUV格式数据">OpenGL或Vulkan渲染YUV格式数据</a>
    </li>
    
    <li>
        <a href="http://www.adiosy.com/posts/learn_vulkan/learn_vulkan02_%E6%B8%B2%E6%9F%93%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0_%E5%BC%80%E7%AF%87.html" title="Learn_Vulkan02_渲染框架实现_开篇">Learn_Vulkan02_渲染框架实现_开篇</a>
    </li>
    
    <li>
        <a href="http://www.adiosy.com/posts/learn_vulkan/learn_vulkan01_%E9%87%8D%E8%A6%81%E5%AF%B9%E8%B1%A1%E6%B5%85%E6%9E%90.html" title="Learn_Vulkan01_重要对象浅析">Learn_Vulkan01_重要对象浅析</a>
    </li>
    
    <li>
        <a href="http://www.adiosy.com/posts/learn_vulkan/learn_vulkan00_%E7%AC%AC%E4%B8%80%E4%B8%AA%E4%B8%89%E8%A7%92%E5%BD%A2.html" title="Learn_Vulkan00_第一个三角形">Learn_Vulkan00_第一个三角形</a>
    </li>
    
    <li>
        <a href="http://www.adiosy.com/posts/hello-openxr---%E7%AC%AC%E4%B8%80%E4%B8%AAopenxr%E7%A8%8B%E5%BA%8F.html" title="Hello OpenXR - 第一个OpenXR程序">Hello OpenXR - 第一个OpenXR程序</a>
    </li>
    
    <li>
        <a href="http://www.adiosy.com/posts/opengl_renderer/04_%E7%BB%98%E5%88%B6%E7%82%B9%E7%BA%BF%E9%9D%A2.html" title="OpenGL渲染器04_绘制点线面">OpenGL渲染器04_绘制点线面</a>
    </li>
    
    <li>
        <a href="http://www.adiosy.com/posts/opengl_renderer/03_opengl%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA.html" title="OpenGL渲染器03_OpenGL环境 ">OpenGL渲染器03_OpenGL环境 </a>
    </li>
    
</ul>
    </section>

    
<section class="widget">
    <h3 class="widget-title" style="color:red">加入讨论群</h3>
    <ul class="widget-list">
        
        <li>
            <a href="#" title="加入讨论群" target="_blank" style="color:red">
                
                    <img src="/posts/assets/qrcode_qq_group.jpg">
                
            </a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        
<h3 class="widget-title">Categories</h3>
<ul class="widget-list">
    
    <li><a href="http://www.adiosy.com/categories/opengl.html">OpenGL (4)</a></li>
    
    <li><a href="http://www.adiosy.com/categories/openxr.html">OpenXR (1)</a></li>
    
    <li><a href="http://www.adiosy.com/categories/vulkan.html">Vulkan (5)</a></li>
    
    <li><a href="http://www.adiosy.com/categories/yuv.html">YUV (1)</a></li>
    
</ul>
    </section>

    <section class="widget">
        
<h3 class="widget-title">Tags</h3>
<div class="tagcloud">
    
    <a href="http://www.adiosy.com/tags/monado.html">Monado</a>
    
    <a href="http://www.adiosy.com/tags/opengl.html">OpenGL</a>
    
    <a href="http://www.adiosy.com/tags/openxr.html">OpenXR</a>
    
    <a href="http://www.adiosy.com/tags/vr/ar.html">VR/AR</a>
    
    <a href="http://www.adiosy.com/tags/vulkan.html">Vulkan</a>
    
    <a href="http://www.adiosy.com/tags/yuv.html">YUV</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">Links</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://github.com/xingchen0085" title="我的Github" target="_blank">我的Github</a>
        </li>
        
        <li>
            <a target="_blank" href="https://gitee.com/xingchen0085" title="我的Gitee" target="_blank">我的Gitee</a>
        </li>
        
        <li>
            <a target="_blank" href="https://potatomelon.com" title="土豆社区" target="_blank">土豆社区</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">Meta</h3>
        <ul class="widget-list">
            <li><a href="http://www.adiosy.com/index.xml">RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>